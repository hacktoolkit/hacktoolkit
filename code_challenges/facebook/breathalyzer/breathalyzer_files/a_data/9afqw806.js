/*
HTTP Host: static.ak.fbcdn.net
Generated: June 8th 2010 9:43:09 AM PDT
Machine: 10.16.140.102
Locale: nu_ll
Path: js/2ywfs5qomb8kwwgc.pkg.js
*/

((location=='about:blank'&&(window.parent.eval_global||window.parent.eval))||(window.eval_global||window.eval))("if (window.CavalryLogger) { CavalryLogger.start_js([\"js\\\/2ywfs5qomb8kwwgc.pkg.js\"]); }\n\nvar ChannelRebuildReasons={Unknown:0,AsyncError:1,TooLong:2,Refresh:3,RefreshDelay:4,UIRestart:5,NeedSeq:6,PrevFailed:7,IFrameLoadGiveUp:8,IFrameLoadRetry:9,IFrameLoadRetryWorked:10,PageTransitionRetry:11};\nvar CrossDocument={};(function(){CrossDocument.setListener=function(eventHandler){if(window.postMessage){if(window.addEventListener){window.addEventListener('message',eventHandler,false);}else window.onmessage=eventHandler;}else if(document.postMessage)document.addEventListener('message',eventHandler,false);};CrossDocument.mkPostMessage=function(targetWindow,targetDocument,msgHandler){if(window.postMessage){if(\"object\"==typeof window.postMessage){return function(message,origin){targetWindow.postMessage(message,origin);};}else return bind(targetWindow,targetWindow.postMessage);}else if(document.postMessage){return bind(targetDocument,targetDocument.postMessage);}else return bind(targetWindow,msgHandler);};CrossDocument.targetOrigin=function(parent){if(window.postMessage||document.postMessage){var parentLoc=parent.location;var parentHost=parentLoc.hostname;if(parentHost=='facebook.com'||parentHost.substring(parentHost.length-13)=='.facebook.com')return parentLoc.protocol+'\/\/'+parentLoc.host;}else return null;};var _handleMessage=function(msgCallback,msgStr){if(!msgStr||msgStr.charAt(0)!='{')return;var msg=eval('('+msgStr+')');return msgCallback(msg);};CrossDocument.mkEventHandler=function(msgCallback){return function(event){event=event||window.event;var domain=(event.domain||event.origin);if(domain.substring(domain.length-13)!='.facebook.com'&&domain.substring(domain.length-15)!=':\/\/facebook.com'&&domain!='facebook.com')return;return _handleMessage(msgCallback,event.data);};};CrossDocument.mkMessageHandler=function(msgCallback){return function(msgStr){return _handleMessage(msgCallback,msgStr);};};})();\nDcode=function(){var a,d={},b={_:'%',A:'%22%3a',B:'%2c%22',C:'%2c%22sb%22%3a1%2c%22t%22%3a%7b%7d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',D:'%7b%22',E:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22blo%22%3a0%2c%22bvt%22%3a',F:'ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',G:'%2c%22ch%22%3a%7b%22h%22%3a%22channel',H:'%22%2c%22p%22%3a80%2c%22sub%22%3a%5b',I:'%7d%7d',J:'%7b%22v%22%3a2%2c%22time%22%3a1',K:'%2c%22lc%22%3a1%2c%22cvr%22%3a%7b%22r%22%3a1%2c%22ts%22%3a1',L:'%5d%2c%22p%5f',M:'%22%3a0%2c%22',N:'%22%3a%7b%22i%22%3a0%2c%22all%46lids%22%3a%5bnull%5d',O:'0000',P:'%22%3a1',Q:'%7d',R:'%2c%22pt%22%3a0%2c%22vis%22%3a0%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22blo%22%3a0%2c%22bvt%22%3a0%2c%22ct%22%3a0%2c%22sb%22%3a1%2c%22t%22%3a%7b%7d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%7d%2c2bl%22%3a%7b%22ac%22%3a0%2c%22ut',S:'%22%3a%7b%22ol%22%3a%2d1%2c%22exp%22%3a1',T:'fl%22%3a%5b%22%2d1%22%5d%2c%22all%46lids%22%3a%5b%22%2d1%22%5d',U:'ud%22%3a900%2c%22lc%22%3a0%2c%22cvr%22%3a%7b',V:'%2c%22ut%22%3a1',W:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls',X:'%2c%22lc%22%3a1%2c%22cvr%22%3a%7b%22r%22%3a0%2e',Y:'%22%3a%7b%22n%22%3a%22%',Z:'%2c%22ud%22%3a'};function c(){var f=[];for(var e in b){d[b[e]]=e;f.push(b[e]);}f.reverse();a=new RegExp(f.join(\"|\"),'g');}return {encode:function(e){c();return encodeURIComponent(e).replace(\/([_A-Z])|%..\/g,function(g,f){return f?'%'+f.charCodeAt(0).toString(16):g;}).toLowerCase().replace(a,function(f){return d[f];});},decode:function(e){return decodeURIComponent(e.replace(\/[_A-Z]\/g,function(f){return b[f];}));}};}();\nfunction CookieManager(b,a){this.version=b;this.cookieName='presence';this.dictEncode=a;this.storers={};}CookieManager.prototype={register:function(b,a){this.storers[b]=a;},store:function(){var a=this._getCookie();if(a&&a.v&&this.version<a.v){presence.versionShutdown();return;}var b={v:this.version,time:parseInt(presence.getTime()*.001)};for(var d in this.storers)b[d]=this.storers[d]();var c=JSON.encode(b);if(this.dictEncode)c='D'+Dcode.encode(c);setCookie(this.cookieName,c,null);},_getCookie:function(){try{var data=getCookie(this.cookieName);if(this.lastD===data){return this.lastV;}else{this.lastD=data;this.lastV=null;}if(data&&data.charAt(0)=='D')data=Dcode.decode(data.substring(1));if(data)return this.lastV=JSON.decode(data);}catch(a){}return null;},getSubCookie:function(b){var a=this._getCookie();if(!a)return null;return a[b];}};\nfunction rand32(){return Math.floor(Math.random()*4294967295);}function verifyNumber(a){if(typeof a=='undefined'||isNaN(a)||a==Number.POSITIVE_INFINITY||a==Number.NEGATIVE_INFINITY)a=0;return a;}\nfunction ChannelManager(e,d,a,c,b){this.user=e;this.iframeCheckTime=5000;this.iframeCheckRetryTime=5000;this.iframeLoadMaxRetries=1;this.expectResponseTimeout=5000;this.retryInterval=d;this.channelConfig=a;this._init(c);this.loginErrorGk=b;}ChannelManager.prototype={_init:function(c){this.channel={name:null,iframeHost:null,iframePort:null,iframePath:null};this.isActionRequest=true;this.isReady=false;this.isRebuilding=false;this.iframeIsLoaded=false;this.iframeEverLoaded=false;this.iframeCheckFailedCount=0;this.permaShutdown=false;this.shouldClearSubdomain=false;this.subframe=ge('channel_iframe');this.postMessage=null;var a=presenceCookieManager.getSubCookie('ch');if(c){this.iframeSubdomain=null;}else{this.iframeSubdomain=0;if(a&&a.sub){for(var b=0;b<a.sub.length;b++)if(!a.sub[b]){this.iframeSubdomain=b;break;}if(b==a.sub.length)this.iframeSubdomain=a.sub.length;}}var d=ua.safari();this.pollForMessages=(d>523&&d<525);this.useRandomSubdomain=!!ua.ie();this.handleIframeEvent=CrossDocument.mkEventHandler(this._handleIframeMessage.bind(this));this.handleIframeMessage=CrossDocument.mkMessageHandler(this._handleIframeMessage.bind(this));CrossDocument.setListener(this.handleIframeEvent.bind(this));presenceCookieManager.register('ch',this._getCookieInfo.bind(this));if(ua.firefox()){onbeforeunloadRegister(this._onUnload.bind(this));}else onunloadRegister(this._onUnload.bind(this));},sendIframeMessage:function(b){if(!this.postMessage)return;var c=JSON.encode(b);try{this.postMessage(c,this.targetOrigin);}catch(a){presence.error('channel: iframe msg error: '+'message \"'+c+'\" and error '+a.toString());}},_handleIframeMessage:function(a){if(a.type=='init'){this.iframeLoaded();}else if(a.type=='channelMsg')this.handleChannelMsg(a.channel,a.seq,a.msg);},_onUnload:function(){this.shouldClearSubdomain=true;presence.doSync(true);},addChannel:function(a,d,b,f,e,c){if(this.channel.name!==null){presence.error(\"channel: addChannel called twice\");return;}this.channel.name=a;this.channel.currentSeq=d;this.channel.nextSeq=0;this.channel.msgHandler=b;this.channel.startHandler=f;this.channel.shutdownHandler=e;this.channel.restartHandler=c;},_getCookieInfo:function(){var b={};if(this.channel.iframeHost&&this.channel.iframePort){b.h=this.channel.iframeHost;b.p=this.channel.iframePort;if(null!==this.iframeSubdomain){var a=presenceCookieManager.getSubCookie('ch');var e=(a&&a.sub)?a.sub:[];var d=e.length;if(this.shouldClearSubdomain){e[this.iframeSubdomain]=0;}else{e[this.iframeSubdomain]=1;for(var c=d;c<=this.iframeSubdomain;c++)if(!e[c])e[c]=0;}b.sub=e;}b[this.channel.name]=this.channel.currentSeq;}b.ri=this.retryInterval;return b;},stop:function(){this.stopped=true;this.setReady(false);},setReady:function(a){this.isReady=a;var b={type:'isReady',isReady:a,isActionRequest:this.isActionRequest};if(a&&this.isActionRequest)this.isActionRequest=false;if(a){b.channelName=this.channel.name;b.currentSeq=this.channel.currentSeq;}this.sendIframeMessage(b);},setActionRequest:function(a){this.sendIframeMessage({type:'isActionRequest',isActionRequest:a});},expectResponse:function(){var a=this.channel.nextSeq;presence.debug(\"doing expectResponse of seq \"+a);this.sendIframeMessage({type:'expectResponse',newTimeout:this.expectResponseTimeout,expectedSeq:a});},_iframeUrl:function(){var a;if(null===this.iframeSubdomain){a='';}else{a=this.iframeSubdomain;if(this.useRandomSubdomain)a+=''+rand32();a+='.';}var b='http:\/\/'+a+this.channel.iframeHost+'.facebook.com:'+this.channel.iframePort+this.channel.iframePath;return b;},iframeLoad:function(d,b,e,c){this.isReady=c;this.iframeIsLoaded=false;this.channel.iframePath=d;this.channel.iframeHost=b;this.channel.iframePort=e;var g=this._iframeUrl();this._iframeCheck.bind(this).defer(this.iframeCheckTime);var f=null;if(!ua.ie()||ua.ie()<8)try{f=this.subframe.contentDocument;}catch(a){}if(f){try{f.location.replace(g);}catch(a){presence.error('channel: error setting location: '+a.toString());}}else if(this.subframe.contentWindow){this.subframe.src=g;}else if(this.subframe.document){this.subframe.src=g;}else presence.error('channel: error setting subframe url');presence.debug('channel: done with iframeLoad, subframe sent to '+g);},iframeLoaded:function(){if(!this.iframeIsLoaded){this.iframeIsLoaded=true;this.postMessage=CrossDocument.mkPostMessage(this.subframe.contentWindow,this.subframe.contentDocument,this.subframe.contentWindow.channelUplink.handleParentMessage);this.targetOrigin=\"*\";this.setReady(this.isReady);if(this.pollForMessages)this.msgCheckInterval=setInterval(this.handleChannelMsgCheck.bind(this),100);if(this.iframeCheckFailedCount){this.channel.restartHandler(false);this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadRetryWorked);}else this.channel.startHandler();this.iframeCheckFailedCount=0;this.iframeEverLoaded=true;}},_iframeCheck:function(){if(!this.iframeIsLoaded){presence.error(\"channel: uplink iframe never loaded: shutting down (\"+this.channel.iframeHost+\":\"+this.channel.iframePort+\")\");this.iframeCheckFailedCount++;this.channel.iframeHost=this.channel.iframePort=this.channel.iframePath=0;presenceCookieManager.store();if(this.iframeCheckFailedCount<=this.iframeLoadMaxRetries){this.iframeCheckTime=this.iframeCheckRetryTime;this.channel.iframePath=null;this.rebuild(ChannelRebuildReasons.IFrameLoadRetry);}else{this.channel.shutdownHandler();this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadGiveUp);}}else this.retryInterval=0;},_sendDummyReconnect:function(b){var a=new AsyncRequest().setURI('\/ajax\/presence\/reconnect.php').setData({reason:b,iframe_loaded:this.iframeEverLoaded}).setOption('suppressErrorHandlerWarning',true).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);a.specifiesWriteRequiredParams()&&a.send();},_rebuildResponse:function(c){var b=c.getPayload();var a=b.user_channel;presence.debug('got rebuild response with channel '+a+', seq '+b.seq+', host '+b.host+', port '+b.port);this.channel.currentSeq=b.seq;this.channel.nextSeq=0;this.isRebuilding=false;if(b.path!=this.channel.iframePath||b.host!=this.channel.iframeHost||b.port!=this.channel.iframePort){this.iframeLoad(b.path,b.host,b.port,true);}else this.setReady(true);presenceCookieManager.store();presenceUpdater.pauseUpdate();if(typeof chatOptions!='undefined')chatOptions.setVisibility(b.visibility);this.channel.restartHandler(true);presenceUpdater.resumeUpdate(['buddy_list']);},_retryRebuild:function(c,a){if(a){this.retryInterval=this.channelConfig.MAX_RETRY_INTERVAL;}else if(this.retryInterval==0){this.retryInterval=this.channelConfig.MIN_RETRY_INTERVAL;}else{this.retryInterval*=2;if(this.retryInterval>=this.channelConfig.MAX_RETRY_INTERVAL)this.retryInterval=this.channelConfig.MAX_RETRY_INTERVAL;}var b=this.retryInterval*(.75+Math.random()*.5);presence.warn('channel: retry: manager trying again in '+(b*.001)+' secs');setTimeout(this._rebuildSend.bind(this,c),this.retryInterval);},_rebuildError:function(a,b){this.channel.shutdownHandler(true);presence.error('channel: got rebuild error: '+b.getErrorDescription());if(presence.checkMaintenanceError(b)){presence.warn('channel: manager not trying again');}else if(presence.checkLoginError(b)){if(presence.inPopoutWindow||this.loginErrorGk){this._retryRebuild(ChannelRebuildReasons.PrevFailed,true);}else presence.warn('channel: manager not trying again');}else this._retryRebuild(ChannelRebuildReasons.PrevFailed,false);},_rebuildTransportError:function(a,b){this.channel.shutdownHandler(true);presence.error('channel: got rebuild transport error: '+b.getErrorDescription());this._retryRebuild(a,false);},_rebuildSend:function(b){if(typeof b!='number')b=ChannelRebuildReasons.Unknown;presence.debug('channel: sending rebuild');var a=new AsyncRequest().setURI('\/ajax\/presence\/reconnect.php').setData({reason:b,iframe_loaded:this.iframeEverLoaded}).setHandler(this._rebuildResponse.bind(this)).setErrorHandler(this._rebuildError.bind(this,b)).setTransportErrorHandler(this._rebuildTransportError.bind(this,b)).setOption('suppressErrorAlerts',true).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);return a.specifiesWriteRequiredParams()&&a.send();},rebuild:function(a){if(this.stopped)return;if(this.isRebuilding){presence.debug('channel: rebuild called, but already rebuilding');return;}this.setReady(false);this.isRebuilding=true;presence.debug('channel: rebuilding');if(a==ChannelRebuildReasons.RefreshDelay)this.retryInterval=this.channelConfig.MAX_RETRY_INTERVAL;setTimeout(this._rebuildSend.bind(this,a),this.retryInterval);},handleChannelMsgCheck:function(){if(this.pendingMsg){this._handleChannelMsg(this.pendingMsg.channel,this.pendingMsg.seq,this.pendingMsg.msg);this.pendingMsg=null;}},handleChannelMsg:function(a,c,b){if(this.pollForMessages){this.pendingMsg={channel:a,seq:c,msg:b};}else this._handleChannelMsg(a,c,b);},_handleChannelMsg:function(a,e,c){if(c.type=='shutdown'||c.type=='permaShutdown'){if(!window.loaded||this.permaShutdown)return;if(c.type=='permaShutdown'){presence.warn('channel: got permaShutdown');this.permaShutdown=true;}else{presence.warn('channel: got shutdown');this.rebuild(c.reason);}this.channel.shutdownHandler(true);}if(c.type=='fullReload'){window.location.reload(true);}else{this.channel.currentSeq++;var d;if((d=this.channel.nextSeq)&&e<d){presence.warn('channel: ignoring a duplicate message: ('+e+')<('+d+') on '+a);return;}this.channel.nextSeq=parseInt(e)+1;presence.pauseSync();try{this.channel.msgHandler(a,c);}catch(b){presence.error('channel: error in channel handlers: '+b.toString()+', msg: '+c);}presence.resumeSync();}}};\nPresenceMessage={STARTED:'presence\/started',SHUTDOWN:'presence\/shutdown',RESTARTED:'presence\/restarted',WINDOW_RESIZED:'presence\/window-resized',TAB_CLOSED:'presence\/tab-closed',TAB_OPENED:'presence\/tab-opened',PRESENCE_UPDATER_READY:'presence\/updater-ready',getAppMessageType:function(a,b){return 'presence\/app_message:'+a+':'+b;},getArbiterMessageType:function(a){return 'presence\/message:'+a;}};\nfunction LiveMessageReceiver(a){this.eventName=a;this.subs=null;this.handler=bagofholding;this.shutdownHandler=null;this.restartHandler=null;this.registered=false;this.appId=1;}LiveMessageReceiver.prototype.setAppId=function(a){this.appId=a;return this;};LiveMessageReceiver.prototype.setHandler=function(a){this.handler=a;this._dirty();return this;};LiveMessageReceiver.prototype.setRestartHandler=function(a){this.restartHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype.setShutdownHandler=function(a){this.shutdownHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype._dirty=function(){if(this.registered){this.unregister();this.register();}};LiveMessageReceiver.prototype.register=function(){var b=function(d,c){return this.handler(c);}.bind(this);var a=PresenceMessage.getAppMessageType(this.appId,this.eventName);this.subs={};this.subs.main=Arbiter.subscribe(a,b);if(this.shutdownHandler)this.subs.shut=Arbiter.subscribe(PresenceMessage.SHUTDOWN,this.shutdownHandler);if(this.restartHandler)this.subs.restart=Arbiter.subscribe(PresenceMessage.RESTARTED,this.restartHandler);this.registered=true;return this;};LiveMessageReceiver.prototype.unregister=function(){if(!this.subs)return this;for(var a in this.subs)if(this.subs[a])Arbiter.unsubscribe(this.subs[a]);this.subs=null;this.registered=false;return this;};LiveMessageReceiver.route=function(b){var a=function(c){var d=PresenceMessage.getAppMessageType(b.app_id,b.event_name);Arbiter.inform(d,c,Arbiter.BEHAVIOR_PERSISTENT);};if(b.hasCapture){new AsyncRequest().setHandler(function(c){a(c.getPayload());}).setAllowCrossPageTransition(true).handleResponse(b.response);}else a(b.response);};\nfunction Presence(f,b,a,d,c,e){this.user=f;this.name=b;this.firstName=a;this.sitevars=e;this.popoutURL=env_get('www_base')+'presence\/popout.php';this.updateServerTime(d);this.pageLoadTime=this.getTime();this._init(c);}Presence.prototype={minWidth:100,minHeight:100,defWidth:900,defHeight:650,defX:30,defY:30,cookiePollTime:2000,popoutHeartbeatTime:1000,popoutHeartbeatAllowance:4000,popoutHeartbeatFirstAllowance:15000,resizeStopTime:500,shutdownDelay:5000,restartDelay:3000,POPOUT_TYPE_NONE:0,POPOUT_TYPE_CHAT:1,_init:function(b){this.stateStorers=[];this.stateLoaders=[];this.windowID=rand32()+1;this.contentPaddings={buddy_list:77,presence_notifications:23};this.inPopoutWindow=b==this.POPOUT_TYPE_CHAT;if(!this.inPopoutWindow){this.holder=$('fbDockChat');}else{this.holder=$('presence');this.popoutSidebar=ge('presence_popout_sidebar');}this.popoutWidth=this.defWidth;this.popoutHeight=this.defHeight;this.cookiePoller=null;this.heartbeat=null;this.resizeTimeout=null;this.lastResized=0;this.stateUpdateTime=0;this.loaded=false;this.isShutdown=false;this.isShuttingDown=false;this.isRestarting=false;this.isPermaShutdown=false;this.shutdownTime=0;this.popoutClicked=false;this.popinClicked=false;this.justPoppedOut=false;this.syncPaused=0;this.disableUnfocus=null;this.poppedOut=this.inPopoutWindow;presenceCookieManager.register('state',this._getCookieData.bind(this));if(this.inPopoutWindow){Util.fallbackErrorHandler=null;onbeforeunloadRegister(this.popin.bind(this,false));onunloadRegister(this.popin.bind(this,false));}if(this.inPopoutWindow){Event.listen(window,'resize',this._windowOnResize.bind(this));Event.listen(window,'keypress',this._documentKeyPress.bind(this));}Arbiter.subscribe(\"page_transition\",this.checkRebuild.bind(this));var c=ua.safari();this.isSafari2=(c&&c<500);this.isOpera=(ua.opera()>0);var a=ua.firefox();this.isFF2=(a&&a<3);this.isWindows=ua.windows();this.load();if(this.inPopoutWindow){this._windowOnResize.bind(this).defer();setTimeout(this._windowOnResize.bind(this),3000);}},updateServerTime:function(a){this.timeSkew=(new Date()).getTime()-a;},getTime:function(){return (new Date()).getTime()-this.timeSkew;},debug:function(a){},warn:function(a){this.logError(\"13003:warning:\"+a);},error:function(a){this.logError(\"13002:error:\"+a);},logError:function(a){if(window.send_error_signal)send_error_signal(\"presence\",a);},load:function(){var b=presenceCookieManager.getSubCookie('state');if(!b){this.debug('presence: got null state cookie, loading with current state');this._load(this._getCookieData());return;}try{this._load(b);}catch(a){this.error('presence: got load exception: '+a.toString());this._load(this._getCookieData());}},_load:function(b){this.syncPaused++;this.stateUpdateTime=verifyNumber(b.ut);this.popoutTime=verifyNumber(b.pt);this.poppedOut=!!b.p;if(this.poppedOut){if(this.inPopoutWindow){if(!this.heartbeat)this.heartbeat=setInterval(this._popoutHeartbeat.bind(this),this.popoutHeartbeatTime);}else CSS.addClass(this.holder,'popped_out');}else{if(this.inPopoutWindow){if(!this.loaded){this.poppedOut=true;this.doSync();}else if(!this.popinClicked)window.close();}else this.justPoppedOut=true;CSS.removeClass(this.holder,'popped_out');}if(!this.inPopoutWindow&&!this.cookiePoller)this.cookiePoller=setInterval(this._pollCookie.bind(this),this.cookiePollTime);this.state=b;for(var a=0;a<this.stateLoaders.length;a++)this.stateLoaders[a](b);if(this.inPopoutWindow){this._handleResize.bind(this,0,0).defer();setTimeout(this._handleResize.bind(this,0,0),100);}this.syncPaused--;this.loaded=true;},_pollCookie:function(){var e=presenceCookieManager.getSubCookie('state');if(!e)return;var d=this.popoutTime;if(e.ut>this.stateUpdateTime){this.load(e);return;}if(this.poppedOut&&!this.inPopoutWindow){var a=verifyNumber(e.pt);var b=(new Date()).getTime()-a;var c=this.popoutHeartbeatTime+this.popoutHeartbeatAllowance;if(this.justPoppedOut)if(a==d){c+=this.popoutHeartbeatFirstAllowance;}else this.justPoppedOut=false;this.popoutTime=a;if(b>c){this.poppedOut=false;this.doSync();}}},_popoutHeartbeat:function(){this._pollCookie();if(this.poppedOut)presenceCookieManager.store();},_getCookieData:function(){var b={p:this.poppedOut?1:0,ut:this.stateUpdateTime,pt:this.inPopoutWindow?(new Date()).getTime():this.popoutTime};for(var a=0;a<this.stateStorers.length;a++)b=this.stateStorers[a](b);this.state=b;return this.state;},doSync:function(a){if(this.syncPaused)return;if(a){this._doSync();}else this._doSync.bind(this).defer();},_doSync:function(){this.stateUpdateTime=(new Date()).getTime();presenceCookieManager.store();this._load(this.state);},pauseSync:function(){this.syncPaused++;},resumeSync:function(){this.syncPaused--;this.doSync();},handleMsg:function(a,b){this._handleMsg.bind(this,a,b).defer();},_handleMsg:function(a,b){if(typeof b=='string'){if(b=='shutdown'){this.connectionShutdown();}else if(b=='restart')if(this.isShutdown)this.restart();return;}if(this.isShutdown)return false;if(!b.type)return;if(b.type=='app_msg')if(b.event_name=='beep_event'){Bootloader.loadComponents('beeper',function(){Beeper.ensureInitialized();LiveMessageReceiver.route(b);});}else LiveMessageReceiver.route(b);Arbiter.inform(PresenceMessage.getArbiterMessageType(b.type),{sender:this,channel:a,obj:b});},popout:function(){if(this.inPopoutWindow||this.poppedOut){this.popin(true);return;}if(this.popoutClicked)return;this.popoutClicked=true;var a=window.open(this.popoutURL,\"fbChatWindow\",\"status=0,toolbar=0,location=0,menubar=0,\"+\"directories=0,resizable=1,scrollbars=0,\"+\"width=\"+this.popoutWidth+\",height=\"+this.popoutHeight+\",\"+\"left=\"+this.defX+\",top=\"+this.defY);CSS.removeClass(this.holder,'popped_out');this.poppedOut=true;this.justPoppedOut=true;this.popoutTime=(new Date()).getTime();this.doSync();this.popoutClicked=false;},popin:function(a){if(typeof a=='undefined')a=true;if(this.inPopoutWindow){if(this.popinClicked)return;this.popinClicked=true;}this.poppedOut=false;this.doSync();if(this.inPopoutWindow&&a)window.close();},_windowOnResize:function(){if(!this.inPopoutWindow)return;this.contentResized={};var a=Vector2.getViewportDimensions();this._handleResize(a.x-this.virtPopoutWidth,a.y-this.virtPopoutHeight);if(this.inPopoutWindow)this.popoutHeight=a.y;},_handleResize:function(b,c){var a=this.loaded?100:10;if(this.handleResizeTimer)clearTimeout(this.handleResizeTimer);this.handleResizeTimer=setTimeout(function(){this.virtPopoutWidth+=b;this.virtPopoutHeight+=c;this.popoutWidth=Math.max(this.virtPopoutWidth,this.minWidth);this.popoutHeight=Math.max(this.virtPopoutHeight,this.minHeight);Arbiter.inform(PresenceMessage.WINDOW_RESIZED,{sender:this});},a);},_documentKeyPress:function(a){if(!this.inPopoutWindow)return;a=$E(a);var b=a?a.keyCode:-1;if(b==KEYS.ESC)Event.kill(a);},renderLink:function(b,c,a){return '<a href=\"'+b+'\"'+(this.inPopoutWindow?' target=\"_blank\"':'')+(a?a:'')+'>'+c+'<\/a>';},checkRebuild:function(){if(this.isShutdown&&!this.isPermaShutdown)channelManager.rebuild(ChannelRebuildReasons.PageTransitionRetry);},getErrorDescription:function(a){var c=a.getError();var b=a.getErrorDescription();if(!b)b=_tx(\"An error occurred.\");if(c==1357001)b=_tx(\"Your session has timed out. Please log in.\");return b;},checkLoginError:function(a){var b=a.getError();if(b==1357001||b==1357004||b==1348009){this.loginShutdown();return true;}return false;},checkMaintenanceError:function(a){if(a.getError()==1356007){this.maintenanceShutdown();return true;}return false;},permaShutdown:function(){this.isPermaShutdown=true;var a=_tx(\"Facebook {Chat} is experiencing technical problems.\",{Chat:_tx(\"Chat\")});this.shutdown(false,a,\"perma_shutdown\");},loginShutdown:function(){var a=_tx(\"Your session has timed out. Please log in.\");this.shutdown(false,a,\"login_shutdown\");},connectionShutdown:function(b){var a=_tx(\"Could not connect to Facebook {Chat} at this time.\",{Chat:_tx(\"Chat\")});this.shutdown(b,a,\"connection_shutdown\");},maintenanceShutdown:function(){var a=_tx(\"Facebook {Chat} is down for maintenance at this time.\",{Chat:_tx(\"Chat\")});this.shutdown(false,a,\"maintenance_shutdown\");channelManager.stop();},versionShutdown:function(){var a=_tx(\"Please refresh the page to get the latest version of Facebook {Chat}.\",{Chat:_tx(\"Chat\")});this.shutdown(false,a,\"version_shutdown\");channelManager.stop();},shutdown:function(d,c,a){this.isRestarting=false;this.isShuttingDown=true;var b=(new Date()).getTime();this.shutdownTime=b;if(!d){this._shutdown(c,0,a);}else setTimeout(this._shutdown.bind(this,c,b,a),this.shutdownDelay);},_shutdown:function(c,d,b){if(!this.isShuttingDown&&d==this.shutdownTime)return;if(d&&this.isShutdown)return;if(typeof c!='string'||!c)c=_tx(\"Facebook {Chat} is experiencing technical problems.\",{Chat:_tx(\"Chat\")});if(typeof b!='string'||!b)b=\"undefined\";this.logError(\"13001:shutdown:presence:\"+b);if(!this.inPopoutWindow){CSS.addClass(this.holder,'presence_error');var a=$('fbChatErrorNub').find('.uiTooltipText');DOM.setContent(a,HTML(c));}else{if(this.shutdownErrorDialog)this.shutdownErrorDialog.hide();this.shutdownErrorDialog=new ErrorDialog().setTitle(_tx(\"Facebook Chat Error\")).setBody(c).show();}if(this.isShutdown)return;this.warn(\"presence: shutting down\");this.isShutdown=true;Arbiter.inform(PresenceMessage.SHUTDOWN,{sender:this});},restart:function(a){this.isShuttingDown=false;this.isRestarting=true;if(!a){this._restart(0);}else setTimeout(this._restart.bind(this,this.shutdownTime),this.restartDelay);},_restart:function(a){if(!this.isRestarting||(a&&a!=this.shutdownTime))return;this.debug(\"presence: restarting\");this.isShutdown=false;this.load();Arbiter.inform(PresenceMessage.RESTARTED,{sender:this});if(!this.inPopoutWindow){CSS.removeClass(this.holder,'presence_error');}else if(this.shutdownErrorDialog)this.shutdownErrorDialog.hide();},start:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});},registerStateStorer:function(a){this.stateStorers.push(a);},registerStateLoader:function(a){this.stateLoaders.push(a);}};function getFirstName(c){var d=c.split(\" \");var b=d[0];var a=b.length;if(typeof d[1]!='undefined'&&(a==1||(a==2&&b.indexOf('.')!=-1)||(a==3&&b.toLowerCase()=='the')))b+=' '+d[1];return b;}\nvar Emote={_initialized:false,_imageBase:null,_emoteMap:null,_emoteOrderMap:null,_imageURLs:null,_regex:null,_mapOverlay:null,initImageURL:function(a){Emote._imageURL=a;},initExtraEmoticons:function(a){Emote._mapOverlay=a;},_init:function(){var f=env_get('static_base');Emote._imageBase=f+'images\/emote\/';Emote._blankImgSrc=f+'images\/blank.gif';var a=['smile','frown','tongue','grin','gasp','wink','glasses','sunglasses','grumpy','unsure','cry','devil','angel','kiss','heart','kiki','squint','confused','upset','pacman','colonthree'];Emote._emoteMap={':-)':['\\\\:\\\\-\\\\)','smile'],':)':['\\\\:\\\\)','smile'],':]':['\\\\:\\\\]','smile'],'=)':['=\\\\)','smile'],':-(':['\\\\:\\\\-\\\\(','frown'],':(':['\\\\:\\\\(','frown'],':[':['\\\\:\\\\[','frown'],'=(':['=\\\\(','frown'],':-P':['\\\\:\\\\-P','tongue'],':P':['\\\\:P','tongue'],':-p':['\\\\:\\\\-p','tongue'],':p':['\\\\:p','tongue'],'=P':['=P','tongue'],':-D':['\\\\:\\\\-D','grin'],':D':['\\\\:D','grin'],'=D':['=D','grin'],':-O':['\\\\:\\\\-O','gasp'],':O':['\\\\:O','gasp'],':-o':['\\\\:\\\\-o','gasp'],':o':['\\\\:o','gasp'],';-)':['\\\\;\\\\-\\\\)','wink'],';)':['\\\\;\\\\)','wink'],'8-)':['8\\\\-\\\\)','glasses'],'8)':['8\\\\)','glasses'],'B-)':['B\\\\-\\\\)','glasses'],'B)':['B\\\\)','glasses'],'8-|':['8\\\\-\\\\|','sunglasses'],'8|':['8\\\\|','sunglasses'],'B-|':['B\\\\-\\\\|','sunglasses'],'B|':['B\\\\|','sunglasses'],'>:(':['>\\\\:\\\\(','grumpy'],'>:-(':['>\\\\:\\\\-\\\\(','grumpy'],':\/':['\\\\:\/','unsure'],':-\/':['\\\\:\\\\-\/','unsure'],':\\\\':['\\\\:\\\\\\\\','unsure'],':-\\\\':['\\\\:\\\\-\\\\\\\\','unsure'],\":'(\":[\"\\\\:'\\\\(\",'cry'],'3:)':['3\\\\:\\\\)','devil'],'3:-)':['3\\\\:\\\\-\\\\)','devil'],'O:)':['O\\\\:\\\\)','angel'],'O:-)':['O\\\\:\\\\-\\\\)','angel'],':-*':['\\\\:\\\\-\\\\*','kiss'],':*':['\\\\:\\\\*','kiss'],'<3':['<3','heart'],'^_^':['\\\\^_\\\\^','kiki'],'-_-':['\\\\-_\\\\-','squint'],'o.O':['o\\\\.O','confused'],'O.o':['O\\\\.o','confused'],'>:O':['>\\\\:O','upset'],'>:-O':['>\\\\:\\\\-O','upset'],'>:o':['>\\\\:o','upset'],'>:-o':['>\\\\:\\\\-o','upset'],':v':['\\\\:v','pacman'],':|]':['\\\\:\\\\|\\\\]','robot'],':3':['\\\\:3','colonthree'],'<(\")':['<\\\\(\\\\\"\\\\)','penguin'],':putnam:':['\\\\:putnam\\\\:','putnam'],'(^^^)':['\\\\(\\\\^\\\\^\\\\^\\\\)','shark'],':42:':['\\\\:42\\\\:','42']};if(Emote._mapOverlay)copy_properties(Emote._emoteMap,Emote._mapOverlay);var d=[];for(var c in Emote._emoteMap)d.push(Emote._emoteMap[c][0]);var e='(?:^|\\\\s|\\'|\"|\\\\.)('+d.join('|')+')(?:\\\\s|\\'|\"|\\\\.|,|!|\\\\?|<br>|$)';Emote._regex=new RegExp(e);Emote._emoteOrderMap={};for(var b=0;b<a.length;b++)Emote._emoteOrderMap[a[b]]=b;Emote._initialized=true;},htmlEmote:function(j,l){if(typeof l!='function')l=htmlize;if(!Emote._initialized)Emote._init();var i=0;var k=j;var h=[];while(true){var e=Emote._regex.exec(k);if(!e||!e.length)break;var b=e[1];var d=Emote._emoteMap[b][1];var c=k.indexOf(b);var a=k.substring(0,c);if(a)h.push(l(a));h.push('<span class=\"emote_text\">');h.push(b);h.push('<\/span><img class=\"emote_img\" ');var f;if(typeof(f=Emote._emoteOrderMap[d])=='undefined'){h.push('src=\"');h.push(Emote._imageBase);h.push(d);h.push('.gif\" ');}else{var g=((f*-16)-590);h.push('src=\"');h.push(Emote._blankImgSrc);h.push('\" style=\"background:url(');h.push(Emote._imageURL);h.push(') ');h.push(g);h.push('px -84px no-repeat\" ');}h.push('alt=\"');h.push(b);h.push('\" \/>');k=k.substring(c+b.length);}if(k)h.push(l(k));return h.join('');}};\nfunction html_wordwrap(i,l,k){if(typeof l=='undefined')l=60;if(typeof k!='function')k=htmlize;var f=new RegExp(\"\\\\S{\"+(l+1)+\"}\",'g');var h=0;var j=i;var g=[];var e=i.match(f);if(e)for(var b=0;b<e.length;b++){var c=e[b];var d=h+j.indexOf(c);var a=i.substring(h,d);if(a)g.push(k(a));g.push(k(c)+'<wbr\/>');h=d+c.length;j=i.substring(h);}if(j)g.push(k(j));return g.join('');}function text_get_hyperlinks(k){if(typeof(k)!='string')return [];var f=k.match(\/(?:(?:ht|f)tps?):\\\/\\\/[^\\s\"',]*[^\\s\"'.,?!]\/ig);if(f&&f.length){var a={'>':'<',')':'(',']':'['};var c,d,g=0,e,h,j,i;for(var b=0;b<f.length;b++){d=f[b];c=a[d[d.length-1]];if(c){e=k.indexOf(d);h=k.substr(g,e);if(h.indexOf(c)!=-1)f[b]=d.substr(0,d.length-1);g=e+d.length;}prev_link=d;}}return f;}function html_hyperlink(o,s,t,l){var a={'<':'>','*':'*','{':'}','[':']',\"'\":\"'\",'\"':'\"','#':'#','+':'+','-':'-','(':')'};if(typeof(o)=='undefined'||!o.toString)return '';if(typeof s!='function')s=htmlize;if(typeof t!='function')t=htmlize;var o=o.toString();var f=text_get_hyperlinks(o);var n=0;var q=o;var m=[];var q=o;if(f)for(var j=0;j<f.length;j++){var h=f[j];var e=n+q.indexOf(h);var p=h.length;var k=o.substring(n,e);if(k)m.push(s(k));var r='';if(e>0){var b=o[e-1];if(typeof a[b]!='undefined'){var c=a[b];var d=h.indexOf(c);if(d!=-1){r=s(h.substring(d));h=h.substring(0,d);}}}var g=t(h);var i=h.replace(\/\"\/g,'%22');m.push('<a target=\"_blank\" rel=\"nofollow\" href=\"'+i+'\"');if(l)m.push(' onmousedown=\"UntrustedLink.bootstrap(this, \\''+Env.lhsh+'\\', event)\"');m.push('>'+g+'<\/a>'+r);n=e+p;q=o.substring(n);}if(q)m.push(s(q));return m.join('');}function nl2br(a){if(typeof(a)=='undefined'||!a.toString)return '';return a.toString().replace(\/\\n\/g,'<br \/>');}function is_email(a){return \/^([\\w!.%+\\-])+@([\\w\\-])+(?:\\.[\\w\\-]+)+$\/.test(a);}\nvar Sound=(function(){var a=false;var b='so_sound_player';return {init:function(){if(a)return;a=true;var c=document.createElement('div');c.id='sound_player_holder';document.body.appendChild(c);try{var player=new SWFObject('\/swf\/SoundPlayerHater.swf',b,'1px','1px',['9.0.159.0','10.0.22.87'],'#ffffff');player.addParam('allowscriptaccess','always');player.addParam('wmode','transparent');player.addVariable('swf_id',b);player.fallback_html=' ';player.write(c.id);window[b]=player;}catch(d){}},play:function(d,f){Sound.init();var g=URI(d);if(!g.getDomain())d=URI(env_get('static_base')).setPath(g.getPath()).toString();var e=document[b]||window[b];var c;if(\/\\.mp3$\/.test(d))if(e){if(!e.playSound&&e.length)e=e[0];if(e.playSound){e.playSound(d,!!f);return;}}c=ge('sound');if(!c){c=document.createElement('span');c.setAttribute('id','sound');DOM.getRootElement().appendChild(c);}c.innerHTML='<embed src=\"'+d+'\" autostart=\"true\" loop=\"false\" '+'hidden=\"true\" \/>';}};})();\nfunction ChatTabActions(a){this._container=a;this._actions={};this._actionOrder=[];this._visibilityChanged=false;this._anyVisible=false;this.actionClass='action';}copy_properties(ChatTabActions.prototype,{anyVisible:function(){return this._anyVisible;},appendAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.push(c);return this;},prependAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.unshift(c);return this;},setVisible:function(b,c){var a=this._actions[b];if(a.visible!=c){a.visible=c;this._visibilityChanged=true;}return this;},refresh:function(){if(this._visibilityChanged){this._render();this._visibilityChanged=false;return true;}return false;},_render:function(){DOM.empty(this._container);var c=this._actions;var b=this._actionOrder;this._anyVisible=false;var d=[];for(var e=0;e<b.length;++e){var a=c[b[e]];if(a.visible){if(this._anyVisible)d.push($N('span',{className:'divider'},'|'));d.push(a.create_element());this._anyVisible=true;}}DOM.appendContent(this._container,d);this._container.style.display=this._anyVisible?'block':'none';},_addAction:function(c,b,a){if(typeof b=='string'){var d=b;b=function(){return $N('span',{className:this.actionClass},d);}.bind(this);}this._actions[c]={create_element:function(){var e=b();Event.listen(e,'click',a);return e;},visible:false};this._visibilityChanged=true;}});\nvar ChatUserInfos={};\nfunction ChatBuddyListTypeahead(d,c,b,a){this.inDock=!presence.inPopoutWindow;this.curStr='';this.clearDiv=null;this.focused=false;this.selected=null;this.selectedIndex=0;this.selectableCount=0;this.minBuddyCount=buddyList.flMode?20:10;this.flid=b;this.excludedIds=a;this.id=ChatBuddyListTypeahead.numTypeaheads++;if(this.inDock){this.obj=DOM.find(d,'input');c=d;}else{this.obj=d;this.obj.typeahead=this;}this.placeholderText=this.obj.value;this.inputDiv=c;Event.listen(this.obj,'keyup',function(e){e=$E(e);var f=e?e.keyCode:-1;this._onkeyup.bind(this,f).defer();}.bind(this));this.buildIndex();Arbiter.subscribe(ChatBuddyList.AVAILABILITY_CHANGED,this.buildIndex.bind(this));}ChatBuddyListTypeahead.numTypeaheads=0;ChatBuddyListTypeahead.prototype={buildIndex:function(){this.availableListIDs=buddyList.getSortedListUI(this.flid);this.firstLetterIndex={};for(var a=0;a<this.availableListIDs.length;a++){var b=this.availableListIDs[a];var c=typeahead_source.tokenize(ChatUserInfos[b].name);for(var d=0;d<c.length;d++){if(!this.firstLetterIndex[c[d][0]])this.firstLetterIndex[c[d][0]]={};this.firstLetterIndex[c[d][0]][b]=true;}}this._refreshAvailableList();if(buddyList.availableCount<this.minBuddyCount){CSS.addClass(this.inputDiv,'hidden_elem');this.resetSearch(true);}else{CSS.removeClass(this.inputDiv,'hidden_elem');this.search.bind(this,true).defer();}},_getAvailableListIDs:function(){if(!this.availableIDs)this._refreshAvailableList();return this.availableIDs;},_refreshAvailableList:function(){var a=this.availableListIDs;if(this.excludedIds)a=a.filter((function(b){return this.excludedIds[b]!=1;}).bind(this));this.availableIDs=a;},_onkeyup:function(a){switch(a){case KEYS.ESC:if(''==this.curStr){buddyList.closeTab();}else this.resetSearch(true);break;case undefined:case KEYS.LEFT:case KEYS.RIGHT:return false;break;case KEYS.UP:this.upArrowPress();break;case KEYS.DOWN:this.downArrowPress();break;case KEYS.RETURN:this.select();break;case KEYS.BACKSPACE:case 0:default:if(this.search())this.resetSearch(true);break;}},focusInput:function(){if(buddyList.availableCount&&buddyList.availableCount>this.minBuddyCount)this.obj.focus();this.resetSearch();},resetSearch:function(a){if(!this.obj)return false;if(!this.obj.value||a){this.curStr='';this.obj.value='';}this.selected=null;this.selectedIndex=-1;this.showAll();this.hideClear();if(this.inDock)Dock._resizeNubFlyout($('fbDockChatBuddylistNub'));},search:function(a){var e=this.obj.value;if(e==this.placeholderText)return true;var c=typeahead_source.flatten_string(e);if(!a&&c==this.curStr)return false;this.curStr=c;var d=typeahead_source.tokenize(c).sort(typeahead_source._sort);if(!d[0])return true;var b=this.firstLetterIndex[d[0][0]];this.showClear();buddyList.suppressNonFriendInfoInBuddyList(this.flid);this.getMatchingFriends(b,d);this.selected=null;this.selectMatchingFriends();if(this.inDock)Dock._resizeNubFlyout($('fbDockChatBuddylistNub'));return false;},getMatchingFriends:function(h,i){var f=0;var b;var a=this._getAvailableListIDs();for(var d=0;d<a.length;d++){var e=a[d];var c=ChatUserInfos[e].name;if(h!=undefined&&h[e]&&typeahead_source.check_match(i,c)){var g=typeahead_source.highlight_found(c,this.curStr);DOM.setContent(buddyList.getBuddyItemName(e,this.flid),HTML(g));buddyList.showBuddyItem(e,false,this.flid);f++;if(!b)b=e;}else{CSS.removeClass(buddyList.getBuddyItem(e,this.flid),'selected');buddyList.hideBuddy(e,this.flid);}}if(f>0){buddyList.hideEmptySearch(this.flid);if(f==1||(i.length==1&&i[0].length==1)){this.selected=b;this.selectedIndex=0;CSS.addClass(buddyList.getBuddyItem(b,this.flid),'selected');}}else buddyList.showEmptySearch(this.flid);},selectMatchingFriends:function(){this.selectableCount=0;var a=this._getAvailableListIDs();for(var c=0;c<a.length;c++){var d=a[c];var b=buddyList.getBuddyItem(d,this.flid);if(b&&CSS.getStyle(b,'display')!='none'){if(this.selectedIndex==this.selectableCount){this.selected=d;CSS.addClass(b,'selected');Vector2.scrollIntoView(b);}else CSS.removeClass(b,'selected');this.selectableCount++;}}},downArrowPress:function(){this.selectedIndex++;var a=this.selectableCount-1;if(this.selectedIndex>a)this.resetSearch();this.selectMatchingFriends();},upArrowPress:function(){this.selectedIndex--;if(this.selectedIndex<0)this.selectedIndex=0;this.selectMatchingFriends();},showAll:function(){this.obj.value='';buddyList.hideEmptySearch(this.flid);var a=this._getAvailableListIDs();for(var c=0;c<a.length;c++){var d=a[c];var b=buddyList.getBuddyItem(d,this.flid);if(b){buddyList.updateBuddyItemName(d,this.flid);CSS.removeClass(buddyList.getBuddyItem(d,this.flid),'selected');buddyList.showBuddyItem(d,true,this.flid);}}buddyList.unsuppressNonFriendInfoInBuddyList(this.flid);},showClear:function(){if(!this.clearDiv){this.clearDiv=DOM.find(this.inputDiv,'.clear_input');Event.listen(this.clearDiv,'click',this.resetSearch.bind(this,true));}CSS.removeClass(this.clearDiv,'hidden_elem');},hideClear:function(){if(this.clearDiv)CSS.addClass(this.clearDiv,'hidden_elem');},select:function(){if(this.selected!=null){CSS.removeClass(buddyList.getBuddyItemName(this.selected,this.flid),'selected');buddyList.itemOnClick(this.selected,this.flid);this.resetSearch(true);}}};\nfunction PresenceUpdater(){this.timerGranularity=presence.sitevars.UPDATE_GRANULARITY?presence.sitevars.UPDATE_GRANULARITY*1000:60000;this._init();}PresenceUpdater.prototype={_init:function(){this.handlers=[];this.updatePaused=0;this.updateNumber=0;this._runTimer();bind(Arbiter,Arbiter.inform,PresenceMessage.PRESENCE_UPDATER_READY,true,Arbiter.BEHAVIOR_STATE).defer();},register:function(a,b,d,c,e){this.handlers.push({asyncParam:a,checkCB:b,responseCB:d,errorCB:c,transportErrorCB:e});},_runTimer:function(){clearTimeout(this.timer);this.timer=setTimeout(this.checkForUpdate.bind(this,false,[],false),this.timerGranularity);},forceUpdate:function(a){if(this.updatePaused)return;if(a!==undefined&&a.length>0){this.checkForUpdate(false,a,false);}else this.checkForUpdate(true,[],false);},pauseUpdate:function(){this.updatePaused++;},resumeUpdate:function(a){this.updatePaused--;this.forceUpdate(a);},checkForUpdate:function(d,e,c){if(!c)clearTimeout(this.timer);if(presence.isShutdown){if(!c)this._runTimer();return;}var j=presence.getTime();var b=[];var a={user:presence.user};for(var h=0;h<this.handlers.length;h++){var g=this.handlers[h];var f=d||(e.indexOf(g.asyncParam)!=-1);var i=g.checkCB(j,a,f);if(i){a[g.asyncParam]=1;b.push(g);}}if(b.length>0){this._sendUpdate(a,b,c);}else if(!c)this._runTimer();},runHandler:function(a){this.checkForUpdate(false,[a],true);},_initialHandler:function(b,a){if(b!=this.updateNumber)return false;},_onResponse:function(a,b,f){var g=f.getPayload();presence.updateServerTime(g.time);var h=presence.getTime();for(var d=0;d<a.length;d++){var c=a[d];var e=g[c.asyncParam];if(typeof e=='undefined'||!e){c.errorCB(f);}else c.responseCB(e,h);}presenceCookieManager.store();if(!b)this._runTimer();},_onError:function(a,c){for(var b=0;b<a.length;b++)a[b].errorCB(c);this._runTimer();},_onTransportError:function(a,c){for(var b=0;b<a.length;b++)a[b].transportErrorCB(c);this._runTimer();},_sendUpdate:function(a,b,c){this.updateNumber++;var f=a.notifications?'\/ajax\/presence\/update.php':'\/ajax\/chat\/buddy_list.php';var e=URI.getRequestURI().getQueryData();var d={};for(key in e)if(key.indexOf('buddy')==0)d[key]=e[key];if(d)f=new URI(f).setQueryData(d);this.async=new AsyncRequest().setInitialHandler(this._initialHandler.bind(this,this.updateNumber)).setHandler(this._onResponse.bind(this,b,c)).setErrorHandler(this._onError.bind(this,b)).setTransportErrorHandler(this._onTransportError.bind(this,b)).setOption('suppressErrorAlerts',true).setData(a).setURI(f).setAllowCrossPageTransition(true).send();}};\nfunction TypingIndicator(a,b,d,c){this.id=a;this.input=b;this.source=d;this.callback=null;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('typ'),this.onTyping.bind(this));this.currentState=TypingIndicator.INACTIVE;this.remoteState=TypingIndicator.INACTIVE;this.lastKeystrokeAt=null;this.notifyTimer=null;this.checkTimer=null;c=c||{};this.notifyDelay=c.notifyDelay||TypingIndicator.DEFAULT_NOTIFY_DELAY;this.keystrokeExpiry=c.keystrokeExpiry||TypingIndicator.DEFAULT_KEYSTROKE_EXPIRY;Event.listen(b,'keydown',this._update.bind(this));}copy_properties(TypingIndicator,{INACTIVE:0,TYPING:1,DEFAULT_NOTIFY_DELAY:1000,DEFAULT_KEYSTROKE_EXPIRY:7000});copy_properties(TypingIndicator.prototype,{resetState:function(){presence.debug('typing: ** RESET **');this.currentState=TypingIndicator.INACTIVE;this.remoteState=TypingIndicator.INACTIVE;this.lastKeystrokeAt=null;clearTimeout(this.notifyTimer);this.notifyTimer=null;clearTimeout(this.checkTimer);this.checkTimer=null;},_notifyState:function(b){var d=this.id;var c=buddyList.availableList[d];if(c&&b!=this.remoteState){this.remoteState=b;presence.debug('typing: notifyState('+b+')');if(!channelManager.iframeEverLoaded)return;var a={typ:b,to:d,source:this.source};new AsyncRequest().setHandler(bagofholding).setErrorHandler(this._onError.bind(this,d)).setData(a).setURI('\/ajax\/chat\/typ.php').setAllowCrossPageTransition(true).send();}},_onError:function(b,a){if(a.getError()==1356003)buddyList.setUnavailable(b);},_update:function(){var a=this.currentState;if(this.input.value.length==0){if(!(a==TypingIndicator.INACTIVE))this._transition(TypingIndicator.INACTIVE);}else if(a==TypingIndicator.TYPING){this._recordKeystroke();}else if(a==TypingIndicator.INACTIVE){this._transition(TypingIndicator.TYPING);this._recordKeystroke();}},_recordKeystroke:function(){this.lastKeystrokeAt=new Date();if(!this.checkTimer)this.checkTimer=this._checkTyping.bind(this).defer(this.keystrokeExpiry);},_checkTyping:function(){var a=this.lastKeystrokeAt.valueOf()+this.keystrokeExpiry;var b=new Date().valueOf();if(b>a){this._transition(TypingIndicator.INACTIVE);}else{clearTimeout(this.checkTimer);this.checkTimer=this._checkTyping.bind(this).defer(a-b+10);}},_transition:function(a){clearTimeout(this.checkTimer);this.checkTimer=null;this.lastKeystrokeAt=null;presence.debug('typing:'+this.currentState+' -> '+a);this.currentState=a;clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.bind(this,a).defer(this.notifyDelay);},setCallback:function(a){this.callback=a;},onTyping:function(b,a){this.callback&&this.callback(a.obj);}});\nfunction ChatTab(a,c,e,b,f,d){this.inDock=!presence.inPopoutWindow;this.chatDisplay=a;this.id=c;this.name=e;this.messageTypes={msg:{visible:true,user:true,preserveHistory:false},online:{visible:true,user:false,preserveHistory:true}};this.tabRef='chatDisplay.tabs['+this.id+']';this.firstName=b;this.tabDisabled=false;this.numMissed=f;this.missedTime=d;this.focused=false;this.lastLogItem=null;this.historyLoaded=false;this.pendingSentMsgs=[];this.failedSentMsgs=[];this.historyRequestID=0;this.bounceAnimation=null;this.convTextProcessor=this._processConvText.bind(this);this.convTextEmoteProcessor=this._processConvTextEmote.bind(this);this.minTextHeight=presence.inPopoutWindow?this.minTextHeightPopout:this.minTextHeightPopin;this.lastMessageAt=null;this.lastMessageHadOfflineResponse=false;this._buildUI();this.addPopoutChat(c);this.loadData();this.handleVisibility(true);if(this.inDock){this.nubController=new DockChatTabNub(this.tabHandle,this);Dock.registerNubController(this.tabHandle,this.nubController);}Sound.init();}copy_properties(ChatTab.prototype,{pendingToLogCompareWindow:60000,resendDelay:5000,convWrapLimit:30,handleWidth:136,popinWidth:226,popinHeight:250,popoutWidthOffset:180,flPopoutWidthOffset:200,minTextHeightPopin:13,minTextHeightPopout:32,maxTextHeight:77,msgBunchTime:60000,maxHandleLen:16,maxTitleLen:20,bounceDuration:50,isTabVisible:function(){return this.focused&&(presence.inPopoutWindow||!presence.poppedOut)&&(this.chatInfo.clientWidth>20||presence.inPopoutWindow);},start:function(){this._popSendQueue();},restart:function(){this.getHistory(true);this.handleResize.bind(this).defer();},loadData:function(){if(ChatUserInfos[this.id]){this.updateUserInfo();}else this.chatDisplay.loadInitialUserInfo(this.id,this.name,this.firstName);if(this.chatDisplay.histories[this.id])this._setHistory(this.chatDisplay.histories[this.id]);},_onHistoryInitialHandler:function(a,b){if(a!=this.historyRequestID){presence.debug(\"tabs: got old history async, ignoring\");return false;}return null;},_onHistoryResponse:function(a,l){var b=l.getPayload();var n=b.userInfo;var h=b.history;ChatUserInfos[this.id]=n;buddyList.updateItemDisplay(this.id);this.updateUserInfo();if(b.fls)buddyList.setFlids(this.id,b.fls);if(b.overlay)buddyList.addOverlayInfo(b.overlay);if(!h)return;var k=false;if(this.pendingSentMsgs.length>0&&h.length>0){var j=this.pendingSentMsgs[0];var c;for(c=h.length-1;c>=0;c--){var g=h[c];if(g.to==this.id){var m=Math.abs(j.time-g.time);if(m<this.pendingToLogCompareWindow&&j.text==g.msg.text){this._setMsgInfoMarkup(j.msgID,'');this.pendingSentMsgs.shift();this._popSendQueue();this.poppedSendQueue=true;break;}}}var e=h[h.length-1].time;for(c=0;c<this.pendingSentMsgs.length;c++){j=this.pendingSentMsgs[c];if(j.time<e)j.time=(++e);}}var i=this.chatDisplay.histories[this.id];if(i)if(h.length>0){var d=h[h.length-1];var f=d.time;for(var c=0;c<i.length;c++){var g=i[c];if(g.time>f)h.push(g);}}else h=i;this._setHistory(h);this.chatDisplay.histories[this.id]=h;if(a)if(!k)this._popSendQueue();},getHistory:function(a){var b=++(this.historyRequestID);new AsyncRequest().setInitialHandler(this._onHistoryInitialHandler.bind(this,b)).setHandler(this._onHistoryResponse.bind(this,a)).setErrorHandler(bagofholding).setMethod('GET').setReadOnly(true).setOption('suppressErrorAlerts',true).setData({id:this.id}).setURI('\/ajax\/chat\/history.php').setAllowCrossPageTransition(true).send();},_setHistory:function(d){this.lastLogItem=null;var e='';var g=0;var i=[];Array.prototype.push.apply(i,this.failedSentMsgs);Array.prototype.push.apply(i,this.pendingSentMsgs);var f=0;var a=false;for(var b=0;b<d.length;b++){var c=d[b];if(typeof this.messageTypes[c.type]==undefined)continue;if(!this.messageTypes[c.type].preserveHistory)a=true;for(;g<i.length;g++){var h=i[g];if(!this.messageTypes[h.type].preserveHistory)a=true;if(h.time>f&&h.time<=c.time){if(this.messageTypes[h.type].visible)e+=this._renderMsg(presence.user,this.id,h.time,h,h.msgID,h.isError,h.infoMarkup);}else break;}if(c.type=='msg'){e+=this._renderMsg(c.from,c.to,c.time,c.msg);}else if(c.type=='online')e+=this._renderVisibilityChange(c.time,c.text);this.lastLogItem=c;f=c.time;}for(;g<i.length;g++){var h=i[g];if(this.messageTypes[h.type].visible){e+=this._renderMsg(presence.user,this.id,h.time,h,h.msgID,h.isError,h.infoMarkup);this.lastLogItem={type:h.type,from:presence.user,to:this.id,time:h.time,msg:h};}}this.chatConvContent.innerHTML=e;this.scrollToBottom();if(this.actions.setVisible('clearHistory',a).refresh())this.handleResize();this.historyLoaded=true;},clearHistory:function(){new AsyncRequest().setHandler(bagofholding).setErrorHandler(bagofholding).setData({clear_history_id:this.id}).setURI(this.chatDisplay.settingsURL).setAllowCrossPageTransition(true).send();var c=[];for(var a=0;a<this.chatDisplay.histories[this.id].length;a++){var b=this.chatDisplay.histories[this.id][a];if(typeof this.messageTypes[b.type]=='undefined'||this.messageTypes[b.type].preserveHistory)c.push(b);}this._setHistory(this.chatDisplay.histories[this.id]=c);},_isCurrentPendingSend:function(a){return (this.pendingSentMsgs.length>0&&a==this.pendingSentMsgs[0].msgID);},_onSendInitialHandler:function(a){this.lastMessageHadOfflineResponse=false;},_onSendResponse:function(a,d){var b=d.getPayload();if(this._isCurrentPendingSend(a)){var c=this.pendingSentMsgs[0];c.asyncSuccess=true;}if(b&&b.warning){var e=this._renderMsgWarningMarkup(b.warning.title+'<br \/>'+b.warning.body);this._setMsgInfoMarkup(a,e,'msg_warning');}},_onSendTransportError:function(a,b){if(!this._isCurrentPendingSend(a))return;if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a).defer(this.resendDelay);},_onSendError:function(i,k){if(!this._isCurrentPendingSend(i))return;var j=k.getPayload();var b=k.getError();var a=presence.getErrorDescription(k);if(b==1356003){this.lastMessageHadOfflineResponse=true;buddyList.setUnavailable(this.id);for(var d=0;d<this.pendingSentMsgs.length;d++){var g=this.pendingSentMsgs[d];var h=ge('msg_'+this.id+'_'+g.msgID);if(h){var c='rel=\"dialog\"';var l=new URI(this.chatDisplay.messageURL).addQueryData({id:this.id,message:g.text}).toString();var e=presence.renderLink(l,_tx(\"send as a message\"),c);var f=_tx(\"{message} ({=send as a message})\",{message:this._renderMsgHtmlize(g),'=send as a message':e});DOM.setContent(h,HTML(f));}}}else if(b==1356002){this.lastMessageHadOfflineResponse=true;chatOptions.setVisibility(false);presence.doSync();}else if(b==1356008){a=j.error.title;new ErrorDialog().displayError(j.error.title,j.error.body);}this._sendErrorAll(a);},_renderMsgWarningMarkup:function(a){return '<p class=\"chat_notice chat_msg_warning\">'+a+'<\/p>';},_renderMsgErrorMarkup:function(a){return '<p class=\"chat_notice chat_msg_not_sent\">'+a+'<\/p>';},_sendErrorAll:function(a){var b=this._renderMsgErrorMarkup(a);var c=true;while(this.pendingSentMsgs.length){var d=this.pendingSentMsgs.shift();d.isError=true;if(c)d.infoMarkup=b;this._setMsgInfoMarkup(d.msgID,b,'msg_error');this.failedSentMsgs.push(d);c=false;b='';}},_sendError:function(c,a){var b=this._renderMsgErrorMarkup(a);var d=this.pendingSentMsgs.shift();d.isError=true;d.infoMarkup=b;this._setMsgInfoMarkup(c,b,'msg_error');this.failedSentMsgs.push(d);this._popSendQueue();},_createMessage:function(c,e){var a=rand32()+1;var d=presence.getTime();if(this.lastLogItem&&d<this.lastLogItem.time)d=this.lastLogItem.time+1;var b={text:c,msgID:a,type:e,time:d,asyncSuccess:false,isError:false,errorMarkup:''};return b;},_flushSmallQueue:function(){if(this.pendingSentMsgs.length==1){var a=this.pendingSentMsgs[0];if(channelManager.iframeEverLoaded){this._sendMessage(a);}else if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a.msgID).defer(this.resendDelay);}},_updateChatActivity:function(b,a){this.lastLogItem={type:b.type,from:presence.user,to:this.id,time:b.time,msg:a};this.chatDisplay.chatActivityTime=(new Date()).getTime();presence.doSync();},sendInput:function(){var d=this.chatInput.value;if(!d||!d.match(\/[^\\s]\/))return;if(this.actions.setVisible('clearHistory',true).refresh())this.handleResize();this.chatInput.value='';var b=this._createMessage(d,'msg');this.pendingSentMsgs.push(b);this._flushSmallQueue();var a={text:d};var c=this._renderMsg(presence.user,this.id,b.time,a,b.msgID);this._addConvMarkup(c);this._updateChatActivity(b,a);this.typingIndicator&&this.typingIndicator.resetState();},_sendMessage:function(f){f.time=presence.getTime();if(this.lastLogItem&&f.time<this.lastLogItem.time)f.time=this.lastLogItem.time+1;clearTimeout(this.resendTimeout);this.resendTimeout=null;var e=f.msgID;var b=this.chatDisplay.histories[this.id];var d=null;if(b)for(var c=b.length-1;c>0;c--)if(b[c].type=='msg'){d=b[c].time;break;}var g={msg_id:e,client_time:f.time,to:this.id,num_tabs:this.chatDisplay.numTabs,pvs_time:d,msg_text:f.text,to_offline:(typeof buddyList.availableList[this.id]=='undefined')};var a='\/ajax\/chat\/send.php';channelManager.expectResponse();new AsyncRequest().setServerDialogCancelHandler(function(){if(!this._isCurrentPendingSend(e))return;this.failedSentMsgs.push(this.pendingSentMsgs.shift());this._popSendQueue();}.bind(this)).setInitialHandler(this._onSendInitialHandler.bind(this)).setHandler(this._onSendResponse.bind(this,e)).setErrorHandler(this._onSendError.bind(this,e)).setTransportErrorHandler(this._onSendTransportError.bind(this,e)).setData(g).setURI(a).setAllowCrossPageTransition(true).send();},_popSendQueue:function(){if(this.pendingSentMsgs.length==0)return;var a=this.pendingSentMsgs[0];if(channelManager.iframeEverLoaded){this._sendMessage(a);}else if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a.msgID).defer(this.resendDelay);},_resendMessage:function(a){clearTimeout(this.resendTimeout);this.resendTimeout=null;if(this._isCurrentPendingSend(a))if(channelManager.iframeEverLoaded){this._sendMessage(this.pendingSentMsgs[0]);}else this.resendTimeout=this._resendMessage.bind(this,a).defer(this.resendDelay);},_setMsgInfoMarkup:function(e,b,c){var d=ge('msg_'+this.id+'_'+e);if(!d)return;var a=ge('pending_'+this.id+'_'+e);if(a)a.innerHTML=b;if(c)CSS.addClass(d,c);this.scrollToBottom();},updateUserInfo:function(){this.chatInfoPic.src=ChatUserInfos[this.id].thumbSrc;CSS.removeClass(this.chatInfo,'hidden');},tabHitAreaOnClick:function(){if(this.suppressHeaderCollapse)return;if(presence.inPopoutWindow){this.chatDisplay.focusTab(this.id,true,this.name,this.firstName);}else this.chatDisplay.toggleTab(this.id,true,this.name,this.firstName);this.chatDisplay.doStopBlinking();},tabXOnClick:function(a){this.chatDisplay.closeTab(this.id);this.chatDisplay.doStopBlinking();$E(a).kill();return false;},headerLinkMouseOver:function(){CSS.addClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=true;},headerLinkMouseOut:function(){CSS.removeClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=false;},chatConvOnMouseDown:function(event){event=$E(event);if(event.button!=0)return;this.chatDisplay.doStopBlinking();},chatConvOnMouseUp:function(){if(DOM.getSelection()=='')this.focusChatInput(true);},focusChatInput:function(a){if(!this.tabDisabled&&this.isTabVisible())if(a||this.canStealFocus())this.chatInput.focus();},canStealFocus:function(){if(undefined!=document.activeElement){var a=document.activeElement;if(a){var b='INPUT'==a.nodeName||'TEXTAREA'==a.nodeName||('DIV'==a.nodeName&&a.contentEditable==\"true\");return !b;}}return false;},_buildUI:function(){if(this.inDock){this.tabHandle=this.getFromTemplate();var a=_tx(\"Chat\");var t=htmlize(this.trimName(this.maxHandleLen));var za=htmlize(this.trimName(this.maxTitleLen));var w=this.chatDisplay.profileURL+'?id='+this.id;this.tabHandle.id='tab_handle_'+this.id;this.tabHandle.style.width=this.handleWidth+'px';CSS.removeClass(this.tabHandle,'hidden_elem');var z=DOM.find(this.tabHandle,'.tab_name strong');z.innerHTML=t;var f=DOM.find(this.tabHandle,'.chat_header_link');f.href=w;f.innerHTML=za;var l=DOM.find(this.tabHandle,'.chat_info_pic_link');l.href=w;this.tabCount=DOM.find(this.tabHandle,'.tab_count');this.chatWrapper=DOM.find(this.tabHandle,'.fbNubFlyout');Dock.setFlyoutContentHeight(this.chatWrapper,285);this.chatConv=DOM.find(this.tabHandle,'.fbNubFlyoutBody');Event.listen(this.chatConv,'mousedown',this.chatConvOnMouseDown.bind(this));Event.listen(this.chatConv,'mouseup',this.chatConvOnMouseUp.bind(this));this.chatInfo=DOM.find(this.tabHandle,'.chat_info');this.chatInfoPic=DOM.find(l,'img');this.chatConvContent=DOM.find(this.tabHandle,'.fbNubFlyoutBodyContent');this.chatInput=DOM.find(this.tabHandle,'textarea.chat_input');this.chatShadowInput=DOM.find(this.tabHandle,'textarea.chat_shadow_input');Event.listen(this.chatInput,'click',this.chatDisplay.doStopBlinking.bind(this.chatDisplay));Event.listen(this.chatInput,'keydown',this.inputKeyDown.bind(this));Event.listen(this.chatInput,'keypress',this.inputKeyPress.bind(this));var r=DOM.find(this.tabHandle,'.fbNubButton .uiCloseButton');Event.listen(r,'click',this.tabXOnClick.bind(this));var s=DOM.find(this.tabHandle,'.fbNubFlyout .uiCloseButton');Event.listen(s,'click',this.tabXOnClick.bind(this));this.toolbox=DOM.find(this.tabHandle,'.toolbox');var o=ge(this.inDock?'fbDockChatTabs':'chat_tab_bar');var v=null;for(var u in this.chatDisplay.tabs)v=this.chatDisplay.tabs[u];if(v){o.insertBefore(this.tabHandle,v.tabHandle);}else o.appendChild(this.tabHandle);}else{var x='missed_count_'+this.id;var q='chat_window_wrapper_'+this.id;var d='chat_conv_'+this.id;var e='chat_header_'+this.id;var j='chat_info_'+this.id;var k='chat_info_pic_'+this.id;var c='chat_conv_content_'+this.id;var m='chat_input_'+this.id;var n='chat_shadow_input_'+this.id;var p='chat_toolbox_'+this.id;var a=_tx(\"Chat\");var t=htmlize(this.trimName(this.maxHandleLen));var za=htmlize(this.trimName(this.maxTitleLen));var g=' onmouseover=\"'+this.tabRef+'.headerLinkMouseOver();\" onmouseout=\"'+this.tabRef+'.headerLinkMouseOut();\"';var w=this.chatDisplay.profileURL+'?id='+this.id;var i=presence.renderLink(w,'<img class=\"chat_info_pic\" id=\"'+k+'\" title=\"View Profile\" style=\"display:block;\">',g);var h=presence.renderLink(w,za,g);var y=['<div class=\"tab_button_div\" ','onmouseover=\"CSS.addClass(this, \\'hover\\')\" ','onmouseout=\"CSS.removeClass(this, \\'hover\\')\">','<div title=\"',_tx(\"Show\\\/Hide {Chat} Window\",{Chat:a}),'\" ','class=\"tab_hit_area\" ','onclick=\"',this.tabRef,'.tabHitAreaOnClick()\">','<div class=\"tab_name\">','<span>',t,'<\/span>','<img src=\"http:\/\/static.ak.fbcdn.net\/images\/spacer.gif\"','class=\"tab_availability\" alt=\"',t,'\"\/>','<\/div>','<\/div>','<div class=\"tab_count hidden_elem\" id=\"',x,'\"><\/div>','<div title=\"',_tx(\"Close {Chat} Window\",{Chat:a}),'\" ','class=\"tab_x\" ','onclick=\"',this.tabRef,'.tabXOnClick(event)\" ','onmouseover=\"CSS.addClass(this, \\'hover\\')\" ','onmouseout=\"CSS.removeClass(this, \\'hover\\')\">','<\/div>','<div class=\"chat_window_wrapper\" id=\"',q,'\">','<div class=\"chat_window\">','<div class=\"chat_header\" id=\"',e,'\" onclick=\"',this.tabRef,'.tabHitAreaOnClick()\">','<div class=\"header_buttons\">','<a title=\"',_tx(\"Close {Chat} Window\",{Chat:a}),'\" ','class=\"close\" ','onmouseover=\"CSS.addClass($(\\'',e,'\\'), \\'suppress_hover\\')\" ','onmouseout=\"CSS.removeClass($(\\'',e,'\\'), \\'suppress_hover\\')\" ','onclick=\"',this.tabRef,'.tabXOnClick(event)\">','<\/a>','<a title=\"',_tx(\"Hide {Chat} Window\",{Chat:a}),'\" ','class=\"minimize\">','<\/a>','<\/div>',i,'<div class=\"chat_header_name\">',h,'<\/div>','<\/div>','<div class=\"chat_info\" id=\"',j,'\">','&nbsp;','<\/div>','<div id=\"',p,'\" class=\"toolbox\">','<div class=\"chat_actions\"><\/div>','<\/div>','<div class=\"chat_conv\" id=\"',d,'\" ','onmousedown=\"',this.tabRef,'.chatConvOnMouseDown(event)\" ','onmouseup=\"',this.tabRef,'.chatConvOnMouseUp()\">','<div class=\"chat_conv_content\" id=\"',c,'\"><\/div>','<\/div>','<div class=\"chat_input_div\">','<textarea class=\"chat_shadow_input\" id=\"',n,'\"><\/textarea>','<div class=\"chat_input_icon\"><\/div>','<textarea class=\"chat_input\" id=\"',m,'\" ','onclick=\"chatDisplay.doStopBlinking()\" ','onkeydown=\"return ',this.tabRef,'.inputKeyDown(event)\" ','onkeypress=\"return ',this.tabRef,'.inputKeyPress(event)\" ','><\/textarea>','<div class=\"chat_input_border\"><\/div>','<\/div>','<\/div>','<\/div>','<\/div>'];this.tabHandle=document.createElement('div');var o=ge(this.inDock?'fbChatTabBar':'chat_tab_bar');var v=null;for(var u in this.chatDisplay.tabs)v=this.chatDisplay.tabs[u];if(v){o.insertBefore(this.tabHandle,v.tabHandle);}else o.appendChild(this.tabHandle);this.tabHandle.id='tab_handle_'+this.id;CSS.setClass(this.tabHandle,'tab_handle');this.tabHandle.style.width=this.handleWidth+'px';this.tabHandle.style.display='block';this.tabHandle.innerHTML=y.join('');this.tabCount=ge(x);this.chatWrapper=ge(q);this.chatConv=ge(d);this.chatHeader=ge(e);this.chatInfo=ge(j);this.chatInfoPic=ge(k);this.chatConvContent=ge(c);this.chatInput=ge(m);this.chatShadowInput=ge(n);this.toolbox=ge(p);}var b=DOM.find(this.toolbox,'div.chat_actions');this.actions=new ChatTabActions(b);this.actions.appendAction('clearHistory',_tx(\"Clear {Chat} History\",{Chat:a}),this.clearHistory.bind(this));this.actions.refresh();this.popoutChatTabs=presence.inPopoutWindow?ge('open_chats'):null;this._updateNumMissedDisplay();if(this.chatDisplay.gatedFeatures.typ)this.typingIndicator=new TypingIndicator(this.id,this.chatInput,'chat');},show:function(){CSS.removeClass(this.tabHandle,'hidden_elem');},hide:function(){CSS.addClass(this.tabHandle,'hidden_elem');},inputKeyDown:function(event){event=$E(event);this.chatDisplay.doStopBlinking();if(event.keyCode==KEYS.RETURN&&!event.shiftKey)if(this.chatInput.value)this.sendInput();if(event.keyCode==KEYS.DELETE||event.keyCode==KEYS.BACKSPACE)this.handleResize.bind(this).defer();},inputKeyPress:function(event){event=$E(event);this.handleResize.bind(this).defer();if(event.keyCode==KEYS.RETURN&&!event.shiftKey){event.returnValue=false;return false;}return null;},trimName:function(a){var b=this.name;if(b.length>a)b=b.substring(0,a-2)+'...';return b;},handleVisibility:function(b){var a=chatOptions.visibility;if(chatOptions.visibility){this._enableTab(true,false,a,b);}else this._disableTab(true,a,b);this.handleBuddyAvailability(!b&&a,b);},handleBuddyAvailability:function(b,c){if(!chatOptions.visibility)return;var a=buddyList.getAvailability(this.id);if(a){this._enableTab(false,a.i,b,c);}else this._disableTab(false,b,c);},_enableTab:function(b,a,c,d){d=d||false;var e=this.tabDisabled;this.tabDisabled=false;if(presence.inPopoutWindow){CSS.removeClass(this.popoutTab,'disabled');CSS.conditionClass(this.popoutTab,'idle',a);}CSS.removeClass(this.tabHandle,'disabled');CSS.conditionClass(this.tabHandle,'idle',a);if((b&&!d)||(!b&&e&&!c))this._newVisibilityChange(b,d,true);},_disableTab:function(a,b,c){c=c||false;var d=this.tabDisabled;this.tabDisabled=true;if(presence.inPopoutWindow){CSS.addClass(this.popoutTab,'disabled');CSS.removeClass(this.popoutTab,'idle');}CSS.addClass(this.tabHandle,'disabled');CSS.removeClass(this.tabHandle,'idle');if((a||c||!d)&&!this.lastMessageHadOfflineResponse&&!b)this._newVisibilityChange(a,c,false);},handleResize:function(){var g;var j;var h;var i;var d=31;var n=this.toolbox.childNodes;for(var e=0;e<n.length;++e){var c=n[e];if(shown(c))d+=Vector2.getElementDimensions(c).y;}if(presence.inPopoutWindow){var b=33;d+=Vector2.getElementDimensions(this.chatInfo).y-b;var k=(presence.popoutWidth>330)?presence.popoutWidth:330;g=k-this.flPopoutWidthOffset;j=k-this.flPopoutWidthOffset-28;h=k-this.flPopoutWidthOffset-16;var a=Vector2.getElementDimensions(ge('popout_chat_tabs')).y;i=presence.popoutHeight-a-33;}else{g=this.popinWidth;j=this.popinWidth-28;h=this.popinWidth-8;i=this.popinHeight;}this.chatShadowInput.style.width=this.chatInput.style.width=j+'px';this.chatShadowInput.value=this.chatInput.value;var m=this.chatShadowInput.scrollHeight;if(!m||presence.isOpera){m=this.minTextHeight;if(this.chatInput.value){var l=new RegExp('([\\n]|[^\\n]{'+parseInt(j\/8)+'})','g');var f=this.chatInput.value.match(l);if(f)m=(f.length+1)*this.minTextHeight;}if(!this.inDock)if(presence.isSafari2)m+=8;}if(ua.ie())m-=6;if(m>this.maxTextHeight){m=this.maxTextHeight;}else if(m<this.minTextHeight)m=this.minTextHeight;if(!this.inDock){if(presence.isSafari2){d-=7;}else if(ua.ie()<7)if(this.tabDisabled)d+=4;if(!presence.inPopoutWindow||ua.ie()){this.chatHeader.style.width=g+'px';this.chatInfo.style.width=(g-55)+'px';this.chatConv.style.width=g+'px';}}this.chatInput.style.height=m+'px';if(this.inDock){Dock._resizeNubFlyout(this.tabHandle,true);}else this.chatConv.style.height=Math.max(0,(i-d-m))+'px';this.scrollToBottom();},isUserScrolled:function(){return (this.chatConv.scrollHeight>this.chatConv.scrollTop+this.chatConv.clientHeight);},scrollToBottom:function(){this.chatConv.scrollTop=this.chatConv.scrollHeight;},unfocus:function(){if(!this.focused)return;this.focused=false;if(this.inDock){Dock.hide(this.tabHandle);}else CSS.removeClass(this.tabHandle,'focused');},focus:function(c,a,b){if(this.focused)return;if(this.inDock){Dock.show(this.tabHandle);}else CSS.addClass(this.tabHandle,'focused');this.focused=true;if(!c){this._onFocusUIActions(b);this._onFocusUIActions.bind(this,b).defer(100);}if(!this.historyLoaded)this.getHistory(false);this._updateNumMissed(0);this._stopBounce();},_onFocusUIActions:function(a){this.handleResize();if(!this.inDock)if(ua.ie()<7&&presence.inPopoutWindow)this.chatWrapper.style.top='67px';this.focusChatInput(a);},_startBounce:function(){if(presence.isFF2&&presence.isWindows)return;var a=-8;this.bounceAnimation=animation(this.tabCount).to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-12).duration(this.bounceDuration).checkpoint().to('top',-10).duration(this.bounceDuration).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().go();},_stopBounce:function(){if(this.bounceAnimation){this.bounceAnimation.stop();this.bounceAnimation=null;}},close:function(){if(this.inDock)Dock.unregisterNubController(this.tabHandle);this.tabHandle.parentNode.removeChild(this.tabHandle);this.closePopoutChat();},addPopoutChat:function(a){if(this.popoutChatTabs){this.popoutTab=document.createElement('div');this.popoutTab.id='popout_tab_'+this.id;this.popoutTab.className='popout_tab_button'+(this.chatDisplay.gatedFeatures.typ?'':' vanilla')+((a==this.chatDisplay.focused)?' highlight':'');var b='popout_missed_'+this.id;this.popoutTab.innerHTML='<div class=\"popout_tab_hit_area\" '+'onclick=\"'+this.tabRef+'.tabHitAreaOnClick();\">'+'<div id=\"'+b+'\" class=\"popout_tab_count\"><\/div>'+'<div class=\"popout_tab_name\">'+this.name+'<\/div>'+'<div class=\"popout_tab_status\"><\/div>'+'<a class=\"popout_tab_x\" href=\"#\" '+'onclick=\"'+this.tabRef+'.tabXOnClick(event)\"><\/a>'+'<\/div>';this.popoutChatTabs.appendChild(this.popoutTab);this.popoutTabCount=ge(b);CSS.addClass(document.body,'active_chats');show(ge('popout_chat_tabs'));}},closePopoutChat:function(){if(this.popoutChatTabs){this.popoutChatTabs.removeChild(this.popoutTab);if(this.popoutChatTabs.childNodes.length<=0){hide(ge('popout_chat_tabs'));CSS.removeClass(document.body,'active_chats');}}},selectPopoutChat:function(){CSS.addClass(this.popoutTab,'highlight');},deselectPopoutChat:function(){CSS.removeClass(this.popoutTab,'highlight');},_newVisibilityChange:function(b,f,e){var h=presence.getTime();var g;if(b){if(e){g=_tx(\"You are online.\",{name:this.firstName});}else g=_tx(\"You are not online.\",{name:this.firstName});}else if(e){g=_tx(\"{name} is online.\",{name:this.firstName});}else g=_tx(\"{name} is offline.\",{name:this.firstName});var c={type:'online',time:h,text:g};var a=this.chatDisplay.getHistory(this.id,true);a.push(c);var d=this._renderVisibilityChange(h,g);this._addConvMarkup(d);this.lastLogItem=c;},newTyping:function(b){var a=b.from;var d=b.to;var e=b.st;if(!this.chatDisplay.gatedFeatures.typ){return;}else if((new Date()-this.lastMessageAt)<this.typingIndicator.notifyDelay)return;presence.debug('typing from '+a+': '+e);var c=(e==TypingIndicator.TYPING)&&(this.numMissed==0);if(d!=this.id){if(presence.inPopoutWindow)CSS.conditionClass(this.popoutTab,'typing',c);CSS.conditionClass(this.tabHandle,'typing',c);buddyList.setAvailable(this.id);}},_isChatMessage:function(a){return;typeof this.messageTypes[a.type]!='undefined'&&this.messageTypes[a.type].user;},newMsg:function(j){var c=j.from;var p=j.to;var q=j.type;var h=j.msg;var o=h.time;var a=h.clientTime;var i=h.msgID;var m=true;this.lastMessageAt=new Date();var d=this.chatDisplay.getHistory(this.id,true);var g=null;for(var f=d.length-1;f>=0;f--)if(this._isChatMessage(d[f])){g=d[f];break;}if(g&&o<=g.time){var b=false;for(var f=0;f<d.length;f++)if(this._isChatMessage(d[f])&&o==d[f].time){b=true;break;}if(b){presence.warn('tabs: already had this msg');return;}for(var f=d.length-1;f>=0;f--){var e=d[f];if(this._isChatMessage(e)&&(e.to!=p||(!e.msg.clientTime||e.msg.clientTime<a)))break;}presence.warn('tabs: merging new msg due to out-of-order server timestamp');if(f==d.length-1){this.chatDisplay.histories[this.id].push(j);}else{d.splice(f+1,0,j);this._setHistory(d);m=false;}}else this.chatDisplay.histories[this.id].push(j);if(p!=this.id){var n=this.chatDisplay.isSquelched()||this.chatDisplay.isSquelchedTab(this.id);if(!n&&this.chatDisplay.gatedFeatures.sound&&chatOptions.getSetting('sound'))Sound.play('\/sound\/pop.mp3',true);buddyList.setAvailable(this.id);if(n){this._updateNumMissed(0,o);}else if(!this.focused){this._updateNumMissed(this.numMissed+1,o);this._startBounce();}if(presence.inPopoutWindow)CSS.removeClass(this.popoutTab,'typing');CSS.removeClass(this.tabHandle,'typing');}else{this._updateNumMissed(0,o);for(var f=0;f<this.pendingSentMsgs.length;f++)if(i==this.pendingSentMsgs[f].msgID){var l=this.pendingSentMsgs.splice(f,1);this._popSendQueue();m=false;break;}}m=this.messageTypes[q].visible&&m;if(m){var k=this._renderMsg(c,p,o,h);this._addConvMarkup(k);if(this.actions.setVisible('clearHistory',true).refresh())this.handleResize();this.lastLogItem=j;}},getInputElem:function(){return this.chatInput;},_updateNumMissed:function(a,b){if(a==this.numMissed||(b&&b<=this.missedTime))return;if(a>99)a=99;this.numMissed=a;this.missedTime=b;this._updateNumMissedDisplay();},_updateNumMissedDisplay:function(){if(this.inDock){var a=document.createElement('span');CSS.addClass(a,'tab_count');DOM.setContent(a,this.numMissed);this.tabCount.parentNode.replaceChild(a,this.tabCount);this.tabCount=a;}else this.tabCount.innerHTML=this.numMissed;if(this.numMissed>0){if(this.popoutTabCount){this.popoutTabCount.style.display='block';this.popoutTabCount.innerHTML=this.numMissed;}else chatTabSlider.updateMissedCount();CSS.addClass(this.tabHandle,'highlight');CSS.removeClass(this.tabCount,'hidden_elem');}else{if(this.popoutTabCount){this.popoutTabCount.style.display='none';}else chatTabSlider.updateMissedCount();CSS.removeClass(this.tabHandle,'highlight');CSS.addClass(this.tabCount,'hidden_elem');}},_addConvMarkup:function(b){var a=this.isUserScrolled();this.chatConvContent.innerHTML+=b;if(!a)this.scrollToBottom();},_renderDateBreak:function(f){var d=new Date();d.setTime(f);var e=false;var b=new Date();if(this.lastLogItem)b.setTime(this.lastLogItem.time);if(d.getDate()!=b.getDate()||d.getMonth()!=b.getMonth())e=true;var c='';if(e){var a='date_divider';if(!this.lastLogItem)a+=' first';c='<div class=\"'+a+'\">'+renderDate(d,!presence.inPopoutWindow)+'<\/div>';}return c;},_renderVisibilityChange:function(b,c){var a=this._renderDateBreak(b);a+='<div class=\"visibility_change\">'+'<span class=\"time_stamp\">'+chatDisplay.renderServerTime(b)+'<\/span>'+c+'<\/div>';return a;},_renderMsg:function(b,s,q,h,o,f,a){var c=b!=this.id;var d=c&&b==s;var i=c&&!d?'self':'other';var g=this._renderDateBreak(q);if(!(!g&&this.lastLogItem&&this.lastLogItem.type=='msg'&&this.lastLogItem.from==b&&q-this.lastLogItem.time<this.msgBunchTime)){var t=ChatUserInfos[b];var p=t&&presence.inPopoutWindow?'<img src=\"'+t.thumbSrc+'\" class=\"pic\" \/>':'';var m=c?htmlize(_tx(\"Me\")):presence.renderLink(this.chatDisplay.profileURL+'?id='+this.id,htmlize(this.firstName));var r=chatDisplay.renderServerTime(q);g+='<h5 class=\"'+i+'\">'+p+' <span class=\"time_stamp ts_'+i+'\">'+r+'<\/span>'+m+'<\/h5>';}var e=h.text.substr(0,4)=='?OTR';var k=o?' id=\"msg_'+this.id+'_'+o+'\"':'';var j='p_'+i+' pic_padding'+(f?' msg_error':'')+(e?' cyphertext':'');var l=e?_tx(\"[encrypted message]\"):this._renderMsgHtmlize(h);g+='<p'+k+' class=\"'+j+'\">'+l+'<\/p>';if(o||a){var n=o?' id=\"pending_'+this.id+'_'+o+'\"':'';g+='<div'+n+' class=\"pic_padding\">'+(a?a:'')+'<\/div>';}return g;},_renderMsgHtmlize:function(a){return html_hyperlink(a.text||'',this._processStyledText.bind(this,this.convTextEmoteProcessor),this.convTextProcessor,true);},_processStyledText:function(b,a){return b(a).replace(\/\\b_([^_\\*]+)_\\b\/g,'<u>$1<\/u>').replace(\/(\\s|^)\\*([^_\\*]+)\\*(?=$|\\s)\/g,'$1<b>$2<\/b>');},_processConvText:function(a){return html_wordwrap(a,this.convWrapLimit);},_processConvTextEmote:function(a){return Emote.htmlEmote(a,this.convTextProcessor);},getFromTemplate:function(){if(!this.template)this.template=$('fbDockChatTabTemplate');return this.template.cloneNode(true);}});function renderDate(a,e){if(e){var f=new Date();f.setHours(0);f.setMinutes(0);f.setSeconds(0);f.setMilliseconds(0);var b=24*60*60*1000;var c=f.getTime()-a.getTime();if(c<=0){return _tx(\"Today\");}else if(c<b)return _tx(\"Yesterday\");}var d='';switch(a.getMonth()){case 0:d=_tx(\"January\");break;case 1:d=_tx(\"February\");break;case 2:d=_tx(\"March\");break;case 3:d=_tx(\"April\");break;case 4:d=_tx(\"May\");break;case 5:d=_tx(\"June\");break;case 6:d=_tx(\"July\");break;case 7:d=_tx(\"August\");break;case 8:d=_tx(\"September\");break;case 9:d=_tx(\"October\");break;case 10:d=_tx(\"November\");break;case 11:d=_tx(\"December\");break;}return _tx(\"{month} {date}\",{month:d,date:a.getDate()});}\nfunction ChatDisplay(e,b,a,c,d){this.histories=e;this.everSentMessage=b;this.user=presence.user;var f=env_get('www_base');this.profileURL=f+'profile.php';this.messageURL=f+'gigaboxx\/dialog\/MessageComposer.php';this.settingsURL='\/ajax\/chat\/settings.php';this.gatedFeatures=d;this.useUICookieCache=d.ui_cookie_cache;this.renderServerTime=this.gatedFeatures['24h_times']?this._renderServerTime24hr:this._renderServerTime12hr;this.jabberSquelchInterval=300000;this._squelchUntil=null;this._squelchedIds={};this._init(a,c);}ChatDisplay.prototype={blinkTime:1500,initialBlinkDelay:3000,_init:function(a,b){this.loaded=false;this.tabs={};this.numTabs=0;this.lastFocused=null;this.newMsgNames=[];this.newMsgNamesIndex=0;this.blinkingTimer=null;this.windowIsFocused=true;this.chatActivityTime=0;if(this.useUICookieCache){this.uiChangeTime=0;this.uiCookieCacheTime=(Env.rep_lag+presence.sitevars.CHAT_UI_COOKIE_CACHE_WINDOW)*1000;}this.favIcon=null;this.altFavIcon=null;this.initialFocusedChat=b;this.initialActiveChats=a;presence.registerStateStorer(this._store.bind(this));presence.registerStateLoader(this._load.bind(this));var c=['unfocus_chat','focus_chat','close_chat','msg','typ','buddylist_overlay'].map(PresenceMessage.getArbiterMessageType);Arbiter.subscribe(c,this._handlePresenceMessage.bind(this));Arbiter.subscribe(PresenceMessage.STARTED,this.start.bind(this));Arbiter.subscribe(PresenceMessage.SHUTDOWN,this.shutdown.bind(this));Arbiter.subscribe(PresenceMessage.RESTARTED,this.restart.bind(this));Arbiter.subscribe(ChatOptions.VISIBILITY_CHANGED,this.handleVisibility.bind(this));Arbiter.subscribe(ChatBuddyList.AVAILABILITY_CHANGED,this._onBuddyAvailability.bind(this));Arbiter.subscribe(PresenceMessage.WINDOW_RESIZED,this.handleResize.bind(this));Arbiter.subscribe('messaging\/open',this._onExternalOpen.bind(this));Arbiter.subscribe('messaging\/close',this._onExternalClose.bind(this));Event.listen(window,'focus',this.onWindowFocus.bind(this));Event.listen(window,'blur',this.onWindowBlur.bind(this));},onWindowFocus:function(){this.isWindowFocused=true;this.doStopBlinking();},onWindowBlur:function(){this.isWindowFocused=false;},start:function(){for(var a in this.tabs)this.tabs[a].start();},shutdown:function(){this._stopBlinking();},restart:function(){for(var a in this.tabs)this.tabs[a].restart();},loadInitialUserInfo:function(b,c,a){if(ChatUserInfos[b])return;ChatUserInfos[b]={name:c,firstName:a,thumbSrc:''};},_loadInitialTabs:function(a,d){var c=null;for(var e in a){if(!c)c=e;if(this.tabs[e])continue;var i=a[e];var g,b;if(ChatUserInfos[e]){g=ChatUserInfos[e].name;b=ChatUserInfos[e].firstName;}else{g=i.n;if(!g)continue;b=i.fn?i.fn:getFirstName(g);}var h=i.m||0;var f=i.t||0;this.tabs[e]=new ChatTab(this,e,g,b,h,f);this.numTabs++;}if(presence.inPopoutWindow&&!d)d=c;if(d&&(d!=this.focused))this._focusTab(d);chatTabSlider.addTab();},load:function(){this._load(presence.state);},_load:function(d){var b=false;if(d){if(this.blinkingTimer&&d.sb)this._stopBlinking();this._squelchUntil=d.sq;this.chatActivityTime=verifyNumber(d.ct)*1000;if(this.useUICookieCache){var c=presence.getTime();this.uiChangeTime=Math.max(this.uiChangeTime,verifyNumber(d.uct)*1000);if(!this.loaded)if(c-this.uiChangeTime<this.uiCookieCacheTime){if(c-d.ut>60*60*1000)for(var a in d.t)d.t[a].m=0;presence.debug('chatDisplay: loading tabs from cookie cache');this._loadInitialTabs.bind(this,d.t,d.f).defer();b=true;}}}if(!this.loaded&&!b){presence.debug('chatDisplay: loading tabs from server state');this._loadInitialTabs.bind(this,this.initialActiveChats,this.initialFocusedChat).defer();this.initialFocusedChat=this.initialActiveChats=false;}this.loaded=true;},_store:function(c){c.ct=Math.floor(this.chatActivityTime*.001);c.sb=(this.blinkingTimer==null)?1:0;var d=this.getSquelchUntil();if(d!==null)c.sq=d;if(this.useUICookieCache){c.t={};c.f=null;c.uct=0;var b=presence.getTime();if(b-this.uiChangeTime<this.uiCookieCacheTime){for(var a in this.tabs){var e=this.tabs[a];c.t[a]={n:e.name,m:e.numMissed};if(e.firstName!=getFirstName(e.name))c.t[a].fn=e.firstName;}c.f=this.focused;c.uct=Math.floor(this.uiChangeTime*.001);}}return c;},handleResize:function(){if(!this.focused)return;var a=this.tabs[this.focused];a.handleResize();},_sendTabStateChange:function(a){a.window_id=presence.windowID;new AsyncRequest().setURI(this.settingsURL).setData(a).setHandler(this._onCheckTabStateChangeResponse.bind(this)).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_onCheckTabStateChangeResponse:function(b){var a=b.getPayload();if(a.overlay)buddyList.addOverlayInfo(a.overlay);},reloadTabs:function(){for(var a in this.tabs)this.tabs[a].loadData();},_closeTab:function(b){if(!this.tabs[b])return;if(this.focused==b)if(presence.inPopoutWindow){var e=null;var a=false;for(var c in this.tabs)if(c!=b){e=c;if(a)break;}else if(e){break;}else a=true;if(e){var d=this.tabs[e];this._focusTab(e);}else this.focused=null;}else this.focused=null;this.tabs[b].close();delete this.tabs[b];this.numTabs--;chatTabSlider.close(b);},_onExternalOpen:function(b,a){if(a.id)this.unfocusAndSquelchTab(a.id,true);},_onExternalClose:function(b,a){if(a.id)this.unfocusAndSquelchTab(a.id,false);},unfocusAndSquelchTab:function(a,b){if(!a in this.tabs)return;if(presence.inPopoutWindow)return;this.setSquelchedTab(b,a);if(b&&this.focused==a)if(this.focused==a){this.tabs[a].unfocus();this.focused=false;}},uiChanged:function(){if(this.useUICookieCache){this.uiChangeTime=presence.getTime();presence.doSync();}},closeTab:function(a){this._closeTab(a);this._sendTabStateChange({close_chat:a});this.uiChanged();},_unfocus:function(){var a=this.focused;if(!a)return false;this.focused=null;if(presence.inPopoutWindow)this.tabs[a].deselectPopoutChat();this.tabs[a].unfocus();return true;},unfocus:function(){var a=this._unfocus();if(a){this._sendTabStateChange({unfocus_chat:1});this.uiChanged();}this.lastFocused=null;},unfocusNoSync:function(){this._unfocus();},refocus:function(){if(!this.lastFocused||!this.tabs[this.lastFocused])return null;this._focusTab(this.lastFocused);},_focusTab:function(c,b,e,a){if(c==this.focused)return;if(!this.tabs[c]){if(typeof e=='undefined'){if(!ChatUserInfos[c]||!ChatUserInfos[c].name){presence.warn(\"chat: couldn't create tab \"+c+\" since no name is specified\");return;}e=ChatUserInfos[c].name;a=ChatUserInfos[c].firstName;}this.tabs[c]=new ChatTab(this,c,e,a,0);this.numTabs++;chatTabSlider.addTab(c);}chatTabSlider.gotoTab(c);if(this.focused){this.tabs[this.focused].unfocus();if(presence.inPopoutWindow)this.tabs[this.focused].deselectPopoutChat();}this.focused=c;this.lastFocused=c;if(this.focused){var d=this.loaded;(function(){var f=!presence.inPopoutWindow&&presence.poppedOut;if(this.tabs[this.focused])this.tabs[this.focused].focus(f,d,b);if(presence.inPopoutWindow)this.tabs[c].selectPopoutChat();}).bind(this).defer();}},focusTab:function(c,b,d,a){presence.pauseSync();this._focusTab(c,b,d,a);this._sendTabStateChange({focus_chat:c});this.uiChanged();this.chatActivityTime=(new Date()).getTime();this.doStopBlinking();presence.resumeSync();},toggleTab:function(c,b,d,a){if(this.focused==c){this.unfocus();}else this.focusTab(c,b,d,a);},_handleBlinking:function(b,c){var a=(b.from==this.user);if(a){this.doStopBlinking(true);}else if(this.isWindowFocused){setTimeout(this.doStopBlinking.bind(this,true),500);}else if(!presence.isOpera){this.newMsgNames.push(c.firstName);if(!this.blinkingTimer)this.blinkingTimer=setTimeout(function(){this.blinkingTimer=setInterval(this._doBlink.bind(this),this.blinkTime);}.bind(this),this.initialBlinkDelay);}},_doBlink:function(){if(!this.favIcon){var b=document.getElementsByTagName('link');for(var a=0;a<b.length;a++)if(b[a].rel=='shortcut icon'){this.favIcon=b[a];this.altFavIcon=document.createElement('link');this.altFavIcon.rel='shortcut icon';this.realTitle=document.title;break;}}if(this.favIcon.parentNode){if(this.newMsgNames&&this.newMsgNames.length>0){if(this.newMsgNamesIndex>=this.newMsgNames.length)this.newMsgNamesIndex=0;var c=this.newMsgNames[this.newMsgNamesIndex++];document.title=_tx(\"New message from {name}!\",{name:c});}else document.title=_tx(\"New message!\");var d=this.favIcon.parentNode;d.removeChild(this.favIcon);d.appendChild(this.altFavIcon);}else{document.title=this.realTitle;var d=this.altFavIcon.parentNode;d.removeChild(this.altFavIcon);d.appendChild(this.favIcon);}},doStopBlinking:function(a){if(this.blinkingTimer||a){this._stopBlinking();presence.doSync();}},_stopBlinking:function(){if(this.blinkingTimer){if(this.favIcon&&!this.favIcon.parentNode)this._doBlink();clearInterval(this.blinkingTimer);this.blinkingTimer=null;this.newMsgNames=[];this.newMsgNamesIndex=0;}},_onBuddyAvailability:function(b,a){this.handleBuddyAvailability(a.justCameOnline);},handleBuddyAvailability:function(b){for(var a in this.tabs)this.tabs[a].handleBuddyAvailability(b);},_handlePresenceMessage:function(j,a){var f=a.obj;var g;var h=false;if(f.window_id==presence.windowID)return;if(f.from){if(f.from==this.user){var d=f.to;g=!!f.csid;this.setSquelched(g);}else{var d=f.from;h=this.isSquelchedTab(d);g=this.isSquelched();}var i=this.tabs[d];}switch(f.type){case 'unfocus_chat':this._unfocus();break;case 'focus_chat':this._focusTab(f.id);break;case 'close_chat':this._closeTab(f.id);break;case 'msg':var c=(f.from==this.user);if(c){var e=f.to_name;var b=f.to_first_name?f.to_first_name:getFirstName(e);}else{var e=f.from_name;var b=f.from_first_name?f.from_first_name:getFirstName(e);}this.loadInitialUserInfo(d,e,b);buddyList.setAvailable(d,c);if(!g&&!h&&!i){i=this.tabs[d]=new ChatTab(this,d,e,b,0);this.numTabs++;chatTabSlider.addTab(d);if(!this.focused){this.focusTab(d);}else i.getHistory();}if(!g&&!h&&(presence.inPopoutWindow||!presence.poppedOut))this._handleBlinking(f,i);if(!g||this.focused==d){f.time=f.msg.time;i.newMsg(f);}break;case 'typ':if((!g||this.focused==d)&&i)i.newTyping(f);break;case 'buddylist_overlay':buddyList.addOverlayInfo(f.overlay);break;default:break;}},_getIDsToNotifyVisibility:function(a){return keys(this.tabs);},handleVisibility:function(){for(var a in this.tabs)this.tabs[a].handleVisibility();},getHistory:function(b,a){a=a||false;if(!this.histories[b]&&a)this.histories[b]=[];return this.histories[b];},_renderServerTime12hr:function(d){var e=new Date();e.setTime(d+presence.timeSkew);var b=e.getHours();var a='am';if(b>=12){a='pm';b-=12;}if(b==0)b=12;var c=e.getMinutes();if(c<10)c='0'+c;var f=b+':'+c+a;return f;},_renderServerTime24hr:function(c){var d=new Date();d.setTime(c+presence.timeSkew);var a=d.getHours();if(a<10)a='0'+a;var b=d.getMinutes();if(b<10)b='0'+b;var e=a+':'+b;return e;},setSquelched:function(c){if(c){var a=(new Date()).valueOf();var b=a+this.jabberSquelchInterval;this._squelchUntil=b;presence.doSync();}else if(this._squelchUntil){this._squelchUntil=null;presence.doSync();}},isSquelched:function(){return this.getSquelchUntil()!==null;},setSquelchedTab:function(b,a){if(b){this._squelchedIds[a]=true;}else delete this._squelchedIds[a];},isSquelchedTab:function(a){return a in this._squelchedIds;},getSquelchUntil:function(){if(this._squelchUntil===null)return null;var a=(new Date()).valueOf();var b=a+(this.jabberSquelchInterval+5000);if(b<this._squelchUntil){this.setSquelched(false);return null;}else if(a<this._squelchUntil){return this._squelchUntil;}else{this.setSquelched(false);return null;}}};function chat_simple_popout(){window.open(presence.popoutURL,\"fbChatWindow\",\"status=0,toolbar=0,location=0,menubar=0,\"+\"directories=0,resizable=1,scrollbars=0,\"+\"width=\"+Presence.prototype.defWidth+\",height=\"+Presence.prototype.defHeight+\",left=\"+Presence.prototype.defX+\",top=\"+Presence.prototype.defY);}\nfunction ChatBuddyList(){this.inDock=!presence.inPopoutWindow;this.user=presence.user;this.shouldRender=true;this.haveFullList=false;this.errorMode=false;this.shouldShowLoading=false;this.availableCount=0;this.availableList={};this.sortedList=[];this.listChanged=false;this.updateTime=0;this.flMode=false;this.flData={};this.otherFriendsFlid='-1';this.botsFlid='-2';this.requiredIdsForUpdate=[];this.stopUpdates=false;this.showingErrorMessage=false;this.flSortableGroup=null;this.reorderingLists=false;this.sortables={};this.flOpts={};this.externalFlids=[];this.updateOverlay={};this.visibilityRatio={};this.justCameOnline=false;this.backgroundColor='#fff';}copy_properties(ChatBuddyList,{OVERLAY_ONLINE:0,OVERLAY_IDLE:1,OVERLAY_OFFLINE:-1,DEFAULT_OPTS:{fullDisplay:true,excludeIds:{}},MAX_BUDDY_NAME_LENGTH:20,BUDDY_LIST_INITIALIZED:'buddylist\/initialized',BUDDY_CLICKED:'buddylist\/buddy_clicked',AVAILABILITY_CHANGED:'buddylist\/availability-changed',UPDATER_NAME:'buddy_list',MAX_UPDATE_FAILURES:4});ChatBuddyList.prototype={setNubController:function(a){this.nubController=a;},maxItemsToAnimate:10,highlightColor:'#fffbe2',expandAnimDuration:400,initError:function(){this.errorMode=true;this._init();},initNoRender:function(a,b,g,e,d,c,f){this.shouldRender=false;this.shouldShowLoading=true;this.availableCount=a;this.availableList=b;this.updateTime=g;this.listChanged=e;this.updateOverlay=f;this.flMode=d;this.flData=c;this._init();if(presence.inPopoutWindow)this._forceUpdate.bind(this,false).defer();},initFullList:function(a,f,d,c,b,e){this.availableList=a;this.updateTime=f;this.listChanged=d;this.haveFullList=true;this.flMode=c;this.flData=b;this.updateOverlay=e;this.availableCount=count(this.availableList);this._init();},_init:function(){this.loaded=false;this.poppedOut=presence.poppedOut;this.buddyListOpen=false;this.updateDiff=0;this.rendered=false;this.showingError=false;this.numRequestFailures=0;for(var a in this.availableList)this.availableList[a].i=this.availableList[a].i?1:0;if(this.inDock){this.tabDiv=$('fbDockChatBuddylistNub');this.wrapperDiv=DOM.find(this.tabDiv,'.fbChatBuddylist');this.contentDiv=DOM.find(this.wrapperDiv,'.fbChatBuddylistContent');this.buddyListError=DOM.find(this.wrapperDiv,'.fbChatBuddylistError');this.buddyCountSpan=DOM.find(this.tabDiv,'.label');}else{this.wrapperID='buddy_list';this.contentID='buddy_list_content';this.wrapperDiv=ge(this.wrapperID);this.contentDiv=ge(this.contentID);this.buddyListError=ge('buddy_list_error');this.buddyCountSpan=ge('buddy_count');}presenceUpdater.register(ChatBuddyList.UPDATER_NAME,this._checkUpdater.bind(this),this._onUpdaterResponse.bind(this),this._onUpdaterError.bind(this),this._onUpdaterError.bind(this));presenceCookieManager.register('bl',this._getCookieData.bind(this));presence.registerStateStorer(this._storeState.bind(this));presence.registerStateLoader(this._loadState.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('fl_settings'),this._handleFLMessage.bind(this));Arbiter.subscribe(ChatOptions.VISIBILITY_CHANGED,this._handleVisibility.bind(this));this.setCompactDisplay(chatOptions.getSetting('compact_buddylist'));this._loadState(presence.state);this._postInit.bind(this).defer();Arbiter.subscribe(Arbiter.LIST_EDITOR_LISTS_CHANGED,this._flManagerHandler.bind(this));},_postInit:function(){if(presence.inPopoutWindow)this._firstRender();if(chatOptions.visibility)this._updateCount();this.updateDiff=this._computeUpdateTimeDiff();this._mergeOverlay();Arbiter.inform(ChatBuddyList.BUDDY_LIST_INITIALIZED,{},Arbiter.BEHAVIOR_PERSISTENT);},_storeState:function(a){a.blo=this.buddyListOpen?1:0;a.bvt=parseInt(this.buddyViewTime*.001);return a;},_loadState:function(c){this.buddyViewTime=verifyNumber(c.bvt)*1000;var b=!!c.blo;if(!presence.poppedOut&&this.poppedOut){this._showLoading();this._forceUpdate(false);}this.poppedOut=presence.poppedOut;var a=null;if(!this.poppedOut)if(b){a=this.openTab.bind(this);}else a=this.closeTab.bind(this);if(a)if(this.loaded){a();}else a.defer();this.loaded=true;},setCompactDisplay:function(a){this.isCompactDisplay=a;if(this.isCompactDisplay){this.itemHeight=18;}else this.itemHeight=22;if(this.rendered)this._render();},setRequiredIdsForUpdate:function(a){this.requiredIdsForUpdate=a;},_handleVisibility:function(){if(chatOptions.visibility){this._showLoading();this._show();this._forceUpdate(true);this.justCameOnline=true;}else this._hide();},_handleFLMessage:function(c,a){var b=a.obj;this.setVisibilityRatio({});if(!this._flChanged(b.fl_mode,b.fl_data))return;this._onFlChange(b.fl_mode,b.fl_data);},_flChanged:function(b,a){return (b!=this.flMode||!are_equal(a,this.flData));},_massageNowAvailableList:function(h,g,f){for(var e in h){var a=h[e];if(g!=this.flMode){if(g){delete a.fl;}else a.fl=[this.otherFriendsFlid];}else{var c=a.fl||[];for(var d=0;d<c.length;d++){var b=c[d];if(typeof this.flData[b]=='undefined')a.fl.remove(b);}if(a.fl&&a.fl.length==0)a.fl=[this.otherFriendsFlid];}h[e]=a;}return h;},_onFlChange:function(d,c){if(!this.rendered){this.flMode=d;this.flData=c;return;}var g=[];var h=[];var f=[];var e=[];if(this.flMode&&this.flMode==d){var b=this._groupAvailableListByFl(true);for(var a in c)if(typeof this.flData[a]=='undefined'){if(c[a].h)continue;g.push(a);f.push(a);}else if(this.flData[a].h!=c[a].h){if(c[a].h){h.push(a);}else{g.push(a);if(c[a].o)f.push(a);}}else if(this.flData[a].o!=c[a].o)if(c[a].o){f.push(a);}else e.push(a);for(var a in this.flData)if(typeof c[a]=='undefined')h.push(a);this.flMode=d;if(h.length!=0)this._removeFlidsFromBuddyList(h,b);if(e.length!=0)this._goOfflineToLists(e,true);this.flData=c;if(g.length!=0)this._addFlidsToDOM(g,b);if(f.length!=0)this._goOnlineToLists(f,true);}else if(this.flMode&&this.flMode!=d){var b=this._groupAvailableListByFl(true);h=keys(this.flData);this.flMode=d;this.flData=c;this._addFlidsToDOM([null]);this._removeFlidsFromBuddyList(h,b);this._forceUpdate(false);}else{for(var a in c){if(c[a].h)continue;g.push(a);if(c[a].o)f.push(a);}this.flMode=d;this.flData=c;this._removeFlidsFromDOM([null]);if(g.length>0)this._addFlidsToDOM(g);if(f.length>0)this._goOnlineToLists.bind(this,f,true).defer();}},_addFlidsToDOM:function(e,f){f=f||this._groupAvailableListByFl(true);var a=this._getRenderedFriendLists();var c=a[0];var h=$('fbChatBuddyListParent');for(var g=0;g<e.length;g++){var d=e[g];if(this.flMode&&d){var b=DOM.create('div',{id:this._getFriendListId(d),className:this._getFriendListItemClasses(d,f)});DOM.setContent(b,HTML(this._renderFriendListHeader(d)));DOM.appendContent(b,HTML(this._renderFriendListContent(d,[])));if(c==d){DOM.prependContent(h,b);}else{var j=a.indexOf(d);var i=a[j-1];DOM.insertAfter(ge(this._getFriendListId(i)),b);}this._addFlSortable(d);this._initFlidSortable(d,[]);}else DOM.prependContent(h,HTML(this._renderFriendListContent(null,[])));}this._addFriendListListeners(e);},_removeFlidsFromDOM:function(b){for(var c=0;c<b.length;c++){var a=b[c];if(a){if(ge(this._getFriendListId(a))){DOM.remove($(this._getFriendListId(a)));this._removeFlSortable(a);this._destroyFlidSortable(a);}}else{DOM.remove($(this._getAvailableMarkerId(a)));DOM.remove($(this._getIdleMarkerId(a)));}}},loadTypeahead:function(){if(this.inDock){this.typeahead=new ChatBuddyListTypeahead(DOM.find(this.tabDiv,'div.chat_buddylist_typeahead'));}else this.typeahead=new ChatBuddyListTypeahead($(\"buddy_list_typeahead_input\"),$(\"buddy_list_typeahead\"));},getContentWrapper:function(){return this.contentDiv.parentNode;},resizeTab:function(a){if(this.inDock)this.nubController.flyoutContentChanged();},_hide:function(){if(!presence.inPopoutWindow){CSS.addClass(presence.holder,'offline');this.closeTab();DOM.setContent(this.buddyCountSpan,_tx(\"Chat (Offline)\"));}},_show:function(){if(presence.inPopoutWindow){CSS.removeClass(presence.popoutSidebar,'buddy_list_hidden');}else{CSS.removeClass(presence.holder,'offline');this.openTab();this._updateCount();}},toggleTab:function(){if(!this.buddyListOpen){this.openTab(true);}else this.closeTab();},_goOnline:function(){chatOptions.sendVisibility(true);},openTab:function(b){if(this.buddyListOpen)return;buddyListDisplay.init();if(CSS.hasClass(presence.holder,'offline')){this._goOnline();return;}if(!this.rendered){var a=this.availableList;this.availableList={};this.shouldShowLoading=true;this._firstRender();Dock.show(this.tabDiv);this.availableList=a;if(this.haveFullList){this._render.bind(this).defer();setTimeout(this._availableListChanged.bind(this,true),10);}}else Dock.show(this.tabDiv);this.buddyListOpen=true;setTimeout(this._openTabPostProcess.bind(this,b),50);},_openTabPostProcess:function(a){this.buddyViewTime=(new Date()).getTime();var b=(presence.getTime()-this.updateTime)*.001;if(this.showingError||b>presence.sitevars.BUDDY_VIEW_FETCH_WINDOW)this._forceUpdate(false);presence.doSync();if(a&&this.typeahead)this.typeahead.focusInput();},closeTab:function(){if(!this.buddyListOpen)return;this.buddyListOpen=false;Dock.hide(this.tabDiv);if(chatOptions.visibility)setTimeout(this._closeTabPostProcess.bind(this),50);buddyListDisplay.closeOpenFlyout();this.exitReorderingFlMode();},_closeTabPostProcess:function(){if(this.typeahead)this.typeahead.resetSearch(true);this.buddyViewTime=(new Date()).getTime();presence.doSync();},_mergeOverlay:function(){var d=presence.getTime();var c={};var e=[];for(var b in this.updateOverlay)if(d<this.updateOverlay[b].exp){var a=this.availableList[b];if(!ChatUserInfos[b])continue;if(this.updateOverlay[b].ol!=ChatBuddyList.OVERLAY_OFFLINE){if(!a){a={i:0};if(this.flMode)a.fl=[this.otherFriendsFlid];c[b]=a;}}else e.push(b);}else delete this.updateOverlay[b];if(!is_empty(c)||!is_empty(e))this._updateAvailableListWithDiff(c,e);},getAvailability:function(a){if(a==this.user)return chatOptions.visibility;if(typeof this.availableList[a]!='undefined'){return this.availableList[a];}else return null;},setAvailable:function(a,b){this._manageOverlay(a,ChatBuddyList.OVERLAY_ONLINE);this._addToBuddyList([a],b);},_addToBuddyList:function(e,f){var a={};var g=[];for(var c=0;c<e.length;c++){var d=e[c];var b=this.getAvailability(d);if(b&&(b.i==0||f))continue;a[d]={i:0};if(this.flMode)if(this.availableList[d]&&this.availableList[d].fl){a[d].fl=this.availableList[d].fl;}else a[d].fl=[this.otherFriendsFlid];if(b&&b.i==1)g.push(d);}this._updateAvailableListWithDiff(a,g);},setFlids:function(b,a){if(!this.getAvailability(b))return;if(this.availableList[b].fl[0]==this.otherFriendsFlid){var c={};c[b]=this.availableList[b];c[b].fl=a;this._updateAvailableListWithDiff(c,[],this.otherFriendsFlid);}},setUnavailable:function(a){this._manageOverlay(a,ChatBuddyList.OVERLAY_OFFLINE);this._removeFromBuddyList([a]);},_removeFromBuddyList:function(d,a){var e=[];for(var b=0;b<d.length;b++){var c=d[b];if(!this.getAvailability(c))continue;e.push(c);}if(e.length>0)this._updateAvailableListWithDiff({},e,a);},addOverlayInfo:function(b){for(var a in b)this._manageOverlay(a,b[a].ol);this._mergeOverlay();},_manageOverlay:function(b,c){var a=presence.getTime()+60000;this.updateOverlay[b]={ol:c,exp:a};if(this.rendered)presenceCookieManager.store();},hideBuddy:function(c,a){var b;if(a){b=[a];}else b=this._getUserFlids(c,null,true);this._toggleBuddy(c,false,b);},_toggleBuddy:function(e,h,c){var g=h?'block':'none';var f,a;for(var d=0;d<c.length;d++){var b=c[d];f=ge(this._getBuddyListItemId(e,b));if(f)f.style.display=g;if(h&&(a=ge(this._getFriendListId(b))))CSS.removeClass(a,'suppress');}},showBuddyItem:function(d,e,a){e=e||false;var b;if(a){b=[a];}else{var b=this._getUserFlids(d,null,true);if(b.length>1&&!e){var c=b.slice(1);this._toggleBuddy(d,false,c);b=[b[0]];}}this._toggleBuddy(d,true,b);},getBuddyItem:function(b,a){a=this._getUserFlid(b,a);return ge(this._getBuddyListItemId(b,a));},getBuddyItemName:function(b,a){a=this._getUserFlid(b,a);return ge(this._getBuddyListItemNameId(b,a));},updateBuddyItemName:function(b,a){var c=ChatUserInfos[b];this.getBuddyItemName(b,a).innerHTML=this.shortenedBuddyName(c.name);},_getUserFlid:function(c,a){if(a===null||a===undefined){var b=this._getUserFlids(c);a=b[0];}return a;},showEmptySearch:function(a){show(this._getEmptySearchId(a));},hideEmptySearch:function(a){hide(this._getEmptySearchId(a));},_getSortedList:function(){if(this.sortedList.length==0&&count(this.availableList)==this.availableCount){this._pruneUsersWithoutDisplayInfo(this.availableList);this.sortedList=this._sort(keys(this.availableList));}return this.sortedList;},_pruneUsersWithoutDisplayInfo:function(a){for(var b in a)if(!ChatUserInfos[b])delete a[b];},getSortedListUI:function(a){if(!a&&this.flMode){var b=this._groupAvailableListByFl(true);var c=[];for(var a in b)c=c.concat(b[a]);return unique(c);}return this._getSortedList();},getFriendLists:function(){var a={};copy_properties(a,this.flData);delete a[this.otherFriendsFlid];delete a[this.botsFlid];return a;},_getRenderedFriendLists:function(){var b=[];for(var a in this.flData)if(!this.flData[a].h)b.push(a);return b;},_getFriendListsInChat:function(){var a=this._getRenderedFriendLists();a.remove(this.otherFriendsFlid);a.remove(this.botsFlid);return a;},suppressNonFriendInfoInBuddyList:function(a){this._updateNonFriendInfoInBuddyList(a,true);},unsuppressNonFriendInfoInBuddyList:function(a){this._updateNonFriendInfoInBuddyList(a,false);},_updateNonFriendInfoInBuddyList:function(b,f){var c=b?[b]:this._getGlobalFlids(true);var e,a;for(var d=0;d<c.length;d++){var b=c[d];if(e=ge(this._getIdleMarkerId(b)))CSS.conditionClass(e,'suppress',f);if(b&&(a=ge(this._getFriendListId(b))))CSS.conditionClass(a,'suppress',f);}},_updateCount:function(){if(this.buddyCountSpan&&!presence.inPopoutWindow){var a=_tx(\"{Chat} {number-available}\",{Chat:_tx(\"Chat\"),'number-available':'<span class=\"buddy_count_num\">(<strong>'+this.availableCount+'<\/strong>)<\/span>'});var b=document.createElement('span');b.className='label';DOM.setContent(b,HTML(a));this.buddyCountSpan.parentNode.replaceChild(b,this.buddyCountSpan);this.buddyCountSpan=b;}},setVisibilityRatio:function(a){this.visibilityRatio=a;presence.doSync();},_getCookieData:function(){var a={};for(var c in chatDisplay.tabs)if(this.availableList[c])a[c]=this.availableList[c];var b={ac:this.availableCount,ut:parseInt(this.updateTime*.001),ud:parseInt(this.updateDiff),lc:this.listChanged?1:0,cvr:this.visibilityRatio};if(!is_empty(this.updateOverlay))b.uo=this.updateOverlay;if(!is_empty(a))b.al=a;return b;},_computeUpdateTimeDiff:function(){if(!chatOptions.visibility||(presence.poppedOut&&!presence.inPopoutWindow))return Math.round(presence.sitevars.BUDDY_MAX_TIME);var c=presence.sitevars.BUDDY_BASE_TIME;var d=presence.getTime();if(!chatDisplay.everSentMessage)c+=presence.sitevars.BUDDY_COST_NEVER_SENT_MESSAGE;if(!this.listChanged)c+=presence.sitevars.BUDDY_COST_NO_LIST_CHANGE;if(chatTabSlider.numTabs==0)c+=presence.sitevars.BUDDY_COST_NO_CHAT_TABS;var b=(d-chatDisplay.chatActivityTime)\/60000;if(b>presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)b=presence.sitevars.BUDDY_MAX_ACTIVITY_MINS;c+=(presence.sitevars.BUDDY_COST_CHAT_ACTIVITY\/presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)*b;if(!presence.poppedOut){var e=(d-presence.pageLoadTime)\/60000;if(e<b){if(e>presence.BUDDY_MAX_ACTIVITY_MINS)e=presence.BUDDY_MAX_ACTIVITY_MINS;c+=(presence.sitevars.BUDDY_COST_PAGE_ACTIVITY\/presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)*e;}if(!this.buddyListOpen){var a=(d-this.buddyViewTime)\/60000;if(a>presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)a=presence.sitevars.BUDDY_MAX_ACTIVITY_MINS;c+=(presence.sitevars.BUDDY_COST_VIEW_ACTIVITY\/presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)*a;}}if(!c||c>presence.sitevars.BUDDY_MAX_TIME)c=presence.sitevars.BUDDY_MAX_TIME;return Math.round(c);},_checkUpdater:function(c,a,b){this.updateDiff=this._computeUpdateTimeDiff();if(b||(chatOptions.visibility&&!this.stopUpdates&&(c-this.updateTime)>this.updateDiff*1000)){a.popped_out=presence.poppedOut;a.available_list=this.haveFullList?this.availableList:{};a.force_render=this.shouldRender;if(this.requiredIdsForUpdate.length)a.required_ids=this.requiredIdsForUpdate;return true;}},_forceUpdate:function(a){this.shouldRender=true;var b=a?undefined:[ChatBuddyList.UPDATER_NAME];presenceUpdater.forceUpdate(b);},updateUserInfos:function(a){copy_properties(ChatUserInfos,a);},_collapseItem:function(f,a,g,c){if(this.flMode&&c){var d=[c];}else var d=this._getUserFlids(f,a);for(var e=0;e<d.length;e++){var c=d[e];var b=ge(this._getBuddyListItemId(f,c));if(b){b.id=this._getBuddyListWasItemId(f,c);if(g)animation(b).to('height','0px').duration(this.expandAnimDuration).go();this._removeSortable(f,d[e]);}}},_expandItem:function(d,c,h,e,i,j,k){var b=ge(this._getBuddyListItemId(d,c));if(!b){var b=HTML(this._renderItem(d,c,e)).getRootNode();}else if(e)CSS.addClass(b,'idle');var f=this.itemHeight;var g=this._getFlOpts(c);if(!g.fullDisplay)f=18;if(!i){b.style.height=f+'px';DOM.insertAfter(h,b);}else{b.style.height='0px';DOM.insertAfter(h,b);var a=animation(b);if(j)a.duration(this.expandAnimDuration+500).checkpoint();a.from('height','0').to('height',f+'px').duration(this.expandAnimDuration);if(k===undefined)k=!e;if(k){b.style.backgroundColor=this.highlightColor;a.checkpoint().duration(3000).checkpoint().to('backgroundColor',this.backgroundColor).duration(500);}a.go();}this._addSortable(d,c);return b;},_clearWasAvailableItems:function(g,h,b){if(!this.rendered)return;for(var d=0;d<g.length;d++){var e=g[d];if(h[e]){if(this.flMode&&b){var c=[b];}else var c=this._getUserFlids(e,h[e]);for(var f=0;f<c.length;f++){var a=ge(this._getBuddyListWasItemId(e,c[f]));if(a){DOM.remove(a);delete a;}}}}this._showBuddyListEmptyItem();},_showBuddyListEmptyItem:function(){var a=ge(this._getBuddyListEmptyItemId());if(a)CSS.conditionClass(a,'hide_empty_item',this.availableCount!=0);},_hideBuddyListEmptyItem:function(){var a=ge(this._getBuddyListEmptyItemId());if(a)CSS.addClass(a,'hide_empty_item');},_updateAvailableListWithDiff:function(x,zf,j){if(this.stopUpdates)return;var r,t;var zc=false;var zg={};var zh={};var i=(j!=null);this._pruneUsersWithoutDisplayInfo(x);for(var q=0;q<zf.length;q++){var ze=zf[q];if(this.availableList[ze]){zc=true;zg[zf[q]]=this.availableList[ze];if(j&&this.flMode&&this.availableList[ze].fl.length>1){this.availableList[ze].fl.remove(j);zh[ze]=1;continue;}delete this.availableList[ze];}}this._hideBuddyListEmptyItem();var w=keys(x);var zb=!j&&!this.showingError&&!presence.isSafari2&&(zf.length+w.length<this.maxItemsToAnimate);if(this.rendered){for(var q=0;q<zf.length;q++)if(zg[zf[q]])this._collapseItem(zf[q],zg[zf[q]],zb,j);var c=zb?this.expandAnimDuration:0;setTimeout(this._clearWasAvailableItems.bind(this,zf,zg,j),c);}var b=this.sortedList;if(this.haveFullList)this.sortedList=[];this._sort(w,x);var v=w.shift();var a=b.shift();var d=this._compareFunction.bind(this,null);var e={},za={},y={},o={},p={};var n=[];if(this.shouldRender){n=this._getGlobalFlids();for(var q=0;q<n.length;q++){var j=n[q];e[j]=y[j]=this._getAvailableMarkerId(j);za[j]=this._getIdleMarkerId(j);o[j]=p[j]=false;}}var u=false;var k=function(zj,zi,zk){var zl=this._getBuddyListItemId(zj,zi);if(zk){za[zi]=zl;}else y[zi]=zl;o[zi]=o[zi]||zk;p[zi]=p[zi]||!zk;};var l=k.bind(this);while(true){if(a&&zg[a]&&!zh[a]){a=b.shift();continue;}if(a&&v){if(a==v){a=b.shift();continue;}if(d(a,v,this.availableList[a].i,x[v].i)<0){r=a;}else r=v;}else if(a){r=a;}else if(v){r=v;}else break;if(r==a){a=b.shift();t=this.availableList[r].i;if(this.shouldRender){var m=this._getUserFlids(r);for(var q=0;q<m.length;q++)l(r,m[q],t);}}else{v=w.shift();if(this.shouldRender&&this.availableList[r]){var zd=this._getUserFlids(r,this.availableList[r],i);for(var q=0;q<zd.length;q++){var j=zd[q];var h=ge(this._getBuddyListItemId(r,j));if(h){this._removeSortable(r,j);DOM.remove(h);}}}this.availableList[r]=x[r];if(this.shouldRender){t=x[r].i;var m=this._getUserFlids(r,null,i);for(var q=0;q<m.length;q++){var j=m[q];var z=t?ge(za[j]):ge(y[j]);if(!z)z=ge(e[j]);this._expandItem(r,j,z,t,zb,zc);u=true;l(r,j,t);}}}if(this.haveFullList)this.sortedList.push(r);}if(this.shouldRender){for(var q=0;q<n.length;q++){var j=n[q];var s=ge(this._getIdleMarkerId(j));if(s)if(o[j]&&p[j]){CSS.removeClass(s,'hide_idle_marker');}else CSS.addClass(s,'hide_idle_marker');}var f=0;if(zb){var g=u;if(g)f+=this.expandAnimDuration;if(zc){f+=this.expandAnimDuration;if(g)f+=500;}}setTimeout(this.resizeTab.bind(this),f);this._resetFlidClasses();}this._availableListChanged(u);},shortenedBuddyName:function(a){return (a.length>ChatBuddyList.MAX_BUDDY_NAME_LENGTH)?a.substring(0,ChatBuddyList.MAX_BUDDY_NAME_LENGTH-2)+'...':a;},_sort:function(c,a){a=a||this.availableList;var b=this._compareFunction.bind(this,a);c.sort(b);return c;},_compareFunction:function(a,b,e,c,f){if(typeof c=='undefined')c=a[b].i;if(typeof f=='undefined')f=a[e].i;if(c^f)return c?1:-1;var d=ChatUserInfos[b].name.toLowerCase();var g=ChatUserInfos[e].name.toLowerCase();return (d<g)?-1:1;},_availableListChanged:function(b){if(this.haveFullList)this.availableCount=count(this.availableList);for(var a in this.availableList)this.availableList[a].i=this.availableList[a].i?1:0;if(this.rendered)presenceCookieManager.store();if(!b)this.resizeTab();this._updateCount();Arbiter.inform(ChatBuddyList.AVAILABILITY_CHANGED,{sender:this,justCameOnline:this.justCameOnline});this.justCameOnline=false;},_onUpdaterResponse:function(a,g){this.numRequestFailures=0;if(this.shouldRender&&!a.forcedRender)return;this.updateTime=g;if(!chatOptions.visibility||this.stopUpdates)return;var c=this.haveFullList;var b=this._flChanged(a.flMode,a.flData);var f=is_empty(a.nowAvailableList);this.errorMode=false;this._hideError();this.listChanged=a.listChanged;this.updateUserInfos(a.userInfos);if(!((c&&b)||f)){this.flMode=a.flMode;this.flData=a.flData;}if(this.shouldRender){this.haveFullList=true;if(!this.rendered)this._firstRender();}else{this.availableCount=a.availableCount;this._updateCount();}if(!c||a.wasAvailableIDs.length||!f){for(var e in this.updateOverlay)if(g<this.updateOverlay[e].exp){if(c||!this.availableList[e]){delete a.nowAvailableList[e];}else a.nowAvailableList[e]=this.availableList[e];for(var d=0;d<a.wasAvailableIDs.length;d++)if(e==a.wasAvailableIDs[d]){a.wasAvailableIDs.splice(d,1);break;}}else delete this.updateOverlay[e];if(c){if(b&&!f)a.nowAvailableList=this._massageNowAvailableList(a.nowAvailableList,a.flMode,a.flData);this._updateAvailableListWithDiff(a.nowAvailableList,a.wasAvailableIDs);if(b)this._onFlChange(a.flMode,a.flData);}else{this.availableList=a.nowAvailableList;this._availableListChanged(true);if(this.shouldRender)this._render();}}else{this._availableListChanged.bind(this).defer();if(b&&f)this._onFlChange(a.flMode,a.flData);}},_onUpdaterError:function(a){this.numRequestFailures++;if(this.numRequestFailures>=ChatBuddyList.MAX_UPDATE_FAILURES){this.updateTime=presence.getTime();this.availableCount=0;this._updateCount();this._updateAvailableListWithDiff({},keys(this.availableList));this._showLoadError();}},itemOnClick:function(c,b){var a;if((a=ge(this._getBuddyListItemId(c,b)))&&a.activeDrag)return;presence.pauseSync();chatDisplay.focusTab(c,true);if(!this.isSticky())this.closeTab();if(this.typeahead)this.typeahead.resetSearch(true);Arbiter.inform(ChatBuddyList.BUDDY_CLICKED,{flid:b,id:c});presence.resumeSync();},_renderItem:function(d,b,e){var k=ChatUserInfos[d];var g=this.shortenedBuddyName(k.name);var j=k.thumbSrc;var a='';if(e)a=_tx(\"Idle\");var h='buddyList.itemOnClick('+parseInt(d,10);if(b){h+=\",'\"+escape_js_quotes(b)+\"')\";}else h+=\")\";var f=['<a href=\"#\" class=\"clearfix friend',(e?' idle':''),'\" title=\"',a,'\"','onclick=\"',h,';return false;\" id=\"',this._getBuddyListItemId(d,b),'\">'];var c=!this.isCompactDisplay;var i=this._getFlOpts(b);c&=i.fullDisplay;if(c)f=f.concat('<img src=\"',j,'\" width=\"22px\" height=\"22px\" \/>');f=f.concat('<span id=\"',this._getBuddyListItemNameId(d,b),'\">',htmlize(g),'<\/span>','<\/a>');return f.join('');},_groupAvailableListByFl:function(e,a){if(!this.flMode||!this.flData)return null;e=e||false;a=a||false;var h={};for(var b in this.flData)h[b]=[];if(a)return h;var c=function(l){var k=this.availableList[l].fl;if(k)for(var m=0;m<k.length;++m){var j=k[m];h[j].push(l);}};var d=c.bind(this);if(e){var i=this._getSortedList();for(var f=0;f<i.length;f++)d(i[f]);}else for(var g in this.availableList)d(g);return h;},_listNameInUse:function(b){for(var a in this.flData)if(this.flData[a].n==b)return true;return false;},keyPressNewListInput:function(b){if(Event.getKeyCode(b)==KEYS.RETURN){var b=$E(b);var c=b.getTarget().value;if(this._listNameInUse(c)){new ErrorDialog().showError(_tx(\"An error occurred.\"),_tx(\"You cannot have two lists with the same name. Please create a unique name for this list.\"));return;}var a={create:c};this._saveBuddyListSetting(a,function(){for(var d in this.flData)if(this.flData[d].n==c){Vector2.scrollIntoView($(this._getFriendListId(d)));break;}}.bind(this));return b.kill();}},handleFlInChat:function(b,a){buddyListDisplay.closeOpenFlyout();if(b){this._unHideFriendListFromChat(a);}else this._hideFriendListFromChat(a);},_unHideFriendListFromChat:function(b){var d=this._getFriendListsInChat().length==0;var c=[b];var a={unhide_from_chat:1,flids:c};this.flData[b].h=0;this._saveBuddyListSetting(a,function(){this._showEmptyListMomentarily(b);Vector2.scrollIntoView($(this._getFriendListId(b)));}.bind(this));if(d){this._onFlChange(true,this.flData);}else this._addFlidsToDOM(c);},_hideFriendListFromChat:function(b){var d=this._getFriendListsInChat().length==1;var c=[b];var a={hide_from_chat:1,flids:c};this.flData[b].h=1;this._saveBuddyListSetting(a);if(d){this._onFlChange(false,this.flData);}else this._removeFlidsFromBuddyList(c);},_friendListHandleSwitchThrown:function(b){var a=this.flData[b].o;if(a){this._goOfflineToLists([b]);}else this._goOnlineToLists([b]);},_friendListHandleSwitchMouseDown:function(b){var a=Event.listen(document,'mouseup',function(){a.remove();this._friendListHandleSwitchThrown(b);}.bind(this));},_friendListHandleMouseOver:function(a){if(this.reorderingLists)return;CSS.addClass($(this._getFriendListId(a)),'hover');},_friendListHandleMouseOut:function(a){CSS.removeClass($(this._getFriendListId(a)),'hover');},_saveBuddyListSetting:function(b,a){b.user=this.user;a=a||bagofholding;new AsyncRequest().setData(b).setURI('\/ajax\/chat\/buddy_list_settings.php').setHandler(this._onBuddyListSettingSave.bind(this,a)).setFinallyHandler(function(){buddyListDisplay.closeOpenFlyout();}).setAllowCrossPageTransition(true).send();},_goOnlineToLists:function(b,d){d=d||false;var a={online_to_list:1,flids:b,read_only:d};var c=chatDisplay._getIDsToNotifyVisibility(true);if(c)a.notify_ids=c;this._handleFlVisibilityChange(b,1);this._saveBuddyListSetting(a);},_handleFlVisibilityChange:function(d,f,a){for(var e=0;e<d.length;e++){var c=d[e];var b=ge(this._getFriendListId(c));if(!b)continue;this.flData[c].o=f;if(f){CSS.addClass(b,'online');CSS.removeClass(b,'offline');if(c==this.otherFriendsFlid)this._showEmptyListMomentarily(c);}else{CSS.addClass(b,'offline');CSS.removeClass(b,'online');}var g=DOM.find(b,'div.titletip strong');DOM.setContent(g,this._getFriendListTooltipText(c));a&&a(c);}},_showEmptyListMomentarily:function(b){this.shownEmptyFlids=this.shownEmptyFlids||{};this.shownEmptyFlids[b]=1;var a=ge(this._getFriendListId(b));if(a)CSS.addClass(a,'show_empty_list');(function(){delete this.shownEmptyFlids[b];var c=ge(this._getFriendListId(b));if(c)CSS.removeClass(c,'show_empty_list');}).bind(this).defer(8000);},_goOfflineToLists:function(b,e){e=e||false;var c=this._groupAvailableListByFl();this._handleFlVisibilityChange(b,0,function(f){var g=c[f];this._removeFromBuddyList(g,f);}.bind(this));if(!e){var a={offline_to_list:1,flids:b};var d=chatDisplay._getIDsToNotifyVisibility(true);if(d)a.notify_ids=d;this._saveBuddyListSetting(a);}},_removeFlidsFromBuddyList:function(c,d){d=d||this._groupAvailableListByFl(true);if(!d)return;var i={};for(var e=0;e<c.length;e++){var b=c[e];var g=d[b];if(!g)continue;for(var h=0;h<g.length;h++){var f=g[h];var a={};a.i=this.availableList[f].i;a.fl=this.availableList[f].fl.clone();if(this.flMode){a.fl.remove(b);if(a.fl.length==0&&this.flData[this.otherFriendsFlid].o)a.fl.push(this.otherFriendsFlid);}else delete a.fl;i[f]=a;}}if(!is_empty(i))this._updateAvailableListWithDiff(i,[]);this._removeFlidsFromDOM(c);},_onBuddyListSettingSave:function(b,a){var e=a.getPayload();if(e){if(e.availableList){this.updateUserInfos(e.userInfos);var d;if(e.flids&&e.flids.length==1)d=e.flids[0];this._updateAvailableListWithDiff(e.availableList,[],d);}if(e.flData){var c;if(typeof e.flMode!='undefined'){c=e.flMode;}else c=true;this._onFlChange(c,e.flData);this._resetFlidClasses();}b&&b();}},_flManagerHandler:function(b,a){},_resetFlidClasses:function(){if(!this.flMode)return;var c=this._groupAvailableListByFl();for(var b in this.flData){var a=ge(this._getFriendListId(b));if(a)CSS.setClass(a,this._getFriendListItemClasses(b,c));}},_getFriendListItemClasses:function(b,e){var d=this.flData[b].o;var c=this.flData[b].h;var a=['friend_list'];if(d){a.push('online');}else a.push('offline');if(!c&&this.shownEmptyFlids&&this.shownEmptyFlids[b])a.push('show_empty_list');if(is_empty(e[b]))if(this.availableCount!=0&&(this.flData[b].c==0||b==this.otherFriendsFlid))a.push('empty_friend_list');if(b==this.otherFriendsFlid){a.push('compact_friend_list');a.push('other_friends_list');}if(this.reorderingLists&&(b==this.otherFriendsFlid||b==this.botsFlid))a.push('suppress');return a.join(' ');},_renderFriendListHeader:function(c){var b=this.flData[c].n;var e=this.flData[c].o;var a='';var f=typeof this.flData[c].s!='undefined';if(!f&&c!=this.otherFriendsFlid)var a='<a href=\"\/friends\/ajax\/edit_list.php?list_id='+c+'\" '+'rel=\"dialog-post\">'+_tx(\"edit\")+'<\/a>';var d=['<div class=\"friendlist_name\">','<span class=\"title\"><a href=\"#\">',htmlize(b),'<\/a><\/span>','<span class=\"edit_link\">',a,'<\/span>','<\/div>'];if(!f)d.push('<div class=\"switch\"><a class=\"online_status\" ','>','<div class=\"titletip\"><strong>',this._getFriendListTooltipText(c),'<\/strong><\/div>','<\/a>','<\/div>');return d.join('');},_getFriendListTooltipText:function(a){return this.flData[a].o?_tx(\"Go Offline\"):_tx(\"Go Online\");},registerExternalFriendList:function(b){if(!this.rendered)this._firstRender();var a='xfl_'+this.externalFlids.length;this.externalFlids.push(a);this.flOpts[a]=b;return a;},_renderFriendListContent:function(a,i){var l;var d=this.flMode&&a;if(d){l=['<div id=\"',this._getFriendListContainerId(a),'\"','class=\"friend_list_container\">'];}else l=[];l.push('<div id=\"',this._getAvailableMarkerId(a),'\" class=\"suppress\"><\/div>');var g=[];var b=false,c=false;for(var k=0;k<i.length;k++){var e=i[k];var f=this.availableList[e].i;var j=[this._renderItem(e,a,f)];if(f){b=true;g=g.concat(j);}else{c=true;l=l.concat(j);}}var h=(b&&c)?'':' hide_idle_marker';l.push('<div id=\"',this._getIdleMarkerId(a),'\" class=\"subheader',h,'\"><\/div>');l=l.concat(g);if(d)l.push('<\/div>');return l.join('');},_addFriendListListeners:function(c){if(!this.flMode)return;c=c||this._getRenderedFriendLists();for(var d=0;d<c.length;d++){var b=c[d];if(typeof this.flData[b].s!='undefined')continue;var a=$(this._getFriendListId(b));Event.listen(a,'mouseover',this._friendListHandleMouseOver.bind(this,b));Event.listen(a,'mouseout',this._friendListHandleMouseOut.bind(this,b));var e=DOM.find(a,'a.online_status');Event.listen(e,'mousedown',this._friendListHandleSwitchMouseDown.bind(this,b));}},_renderBuddyContent:function(){var a=(this.availableCount?'hide_empty_item':'');var g=['<div class=\"subgroup\">',this.renderEmptySearch(),'<div id=\"fbChatBuddyListParent\" class=\"list_select\">','<div id=\"',this._getBuddyListEmptyItemId(),'\" class=\"info_text ',a,'\">',_tx(\"No one is available to chat.\"),'<\/div>'];var c;var d={};if(this.flMode){c=keys(this.flData);d=this._groupAvailableListByFl(true);}else c=[null];for(var e=0;e<c.length;++e){var b=c[e];var f=[];if(this.flMode&&b){if(this.flData[b].h)continue;g.push('<div id=\"',this._getFriendListId(b),'\"','class=\"',this._getFriendListItemClasses(b,d),'\">',this._renderFriendListHeader(b));f=d[b];}else f=this._getSortedList();g.push(this._renderFriendListContent(b,f));if(this.flMode&&b)g.push('<\/div>');}g.concat(['<\/div>','<\/div>']);return g.join('');},renderEmptySearch:function(a){var b='<div id=\"'+this._getEmptySearchId(a)+'\" class=\"info_text\" style=\"display:none\">'+_tx(\"Could not find that friend online.\")+'<\/div>';return b;},_render:function(){this._getSortedList();CSS.conditionClass(this.contentDiv,'compact',this.isCompactDisplay);var a=this._renderBuddyContent();if(this.rendered)CSS.addClass(this.contentDiv,'hidden');this.contentDiv.innerHTML=a;if(this.rendered){CSS.addClass(this.wrapperDiv,'presence_menu_offscreen');this._hideError();CSS.removeClass(this.contentDiv,'hidden');this.resizeTab();CSS.removeClass(this.wrapperDiv,'presence_menu_offscreen');this._initDragging();this._addFriendListListeners();}if(this.errorMode)this._showLoadError();if(this.shouldShowLoading){this._showLoading();this.shouldShowLoading=false;}},_firstRender:function(){this._render();this.rendered=true;this.loadTypeahead();},updateItemDisplay:function(d){var a=this.availableList[d];if(!a)return;var f=this._getUserFlids(d);for(var c=0;c<f.length;c++){var b=f[c];var e=ge(this._getBuddyListItemId(d,b));if(!e)return;e=HTML(this._renderItem(d,b,a.i)).getRootNode();}},_showLoadError:function(){this._showError(_tx(\"Could not load available friends.\"));},_showLoading:function(){this._showError(_tx(\"Loading...\"));},_hideError:function(){this.showingError=false;CSS.removeClass(this.wrapperDiv,'error');},_showError:function(a){this.showingError=true;DOM.setContent(this.buddyListError,HTML(a));CSS.addClass(this.wrapperDiv,'error');},isSticky:function(){return chatOptions.getSetting('sticky_buddylist');},enterErrorMode:function(a){this.exitErrorMode();this.exitReorderingFlMode();this.showingErrorMessage=true;var b=$N('div',{id:'error_fl_alert'},[$N('span',{className:'helper_text'},a),$N('input',{type:'button',className:'inputbutton',value:_tx(\"Okay\"),onclick:this.exitErrorMode.bind(this)})]);DOM.insertBefore(b,this.contentDiv);},exitErrorMode:function(){if(this.showingErrorMessage){DOM.remove($('error_fl_alert'));this.showingErrorMessage=false;}return false;},enterReorderingFlMode:function(){if(this.reorderingLists)return;this.exitErrorMode();this.reorderingLists=true;CSS.addClass(this.wrapperDiv,'reorder_fl');var a=this._getRenderedFriendLists();this.flSortableGroup=new SortableGroup();for(var c=0;c<a.length;c++){var b=a[c];if(b==this.otherFriendsFlid||b==this.botsFlid){CSS.addClass(this._getFriendListId(b),'suppress');}else this._addFlSortable(b);}var d=$N('div',{id:'reorder_fl_alert'},[$N('span',{className:'helper_text'},_tx(\"Drag lists to re-order.\")),$N('input',{type:'button',className:'inputbutton',value:_tx(\"Done Re-Ordering\"),onclick:this.exitReorderingFlMode.bind(this)})]);DOM.insertBefore(d,this.contentDiv);},exitReorderingFlMode:function(){if(!this.reorderingLists)return;this._reorderFlids();DOM.remove($('reorder_fl_alert'));CSS.removeClass(this.wrapperDiv,'reorder_fl');var a=this._getRenderedFriendLists();for(var c=0;c<a.length;c++){var b=a[c];if(b==this.otherFriendsFlid||b==this.botsFlid){CSS.removeClass(this._getFriendListId(b),'suppress');}else this._removeFlSortable(b);}this.reorderingLists=false;this.flSortableGroup.destroy();this.flSortableGroup=null;},_addFlSortable:function(a){if(this.flSortableGroup!=null){this.flSortableGroup.addSortable(a,$(this._getFriendListId(a)));animation($(this._getFriendListContainerId(a))).to('height','0px').to('opacity',0).from(1).blind().hide().ease(animation.ease.end).duration(300).go();}},_removeFlSortable:function(b){if(this.flSortableGroup!=null){this.flSortableGroup.removeSortable(b);var a;if(a=ge(this._getFriendListContainerId(b)))animation(a).to('height','auto').from('0px').to('opacity',1).from(0).blind().show().ease(animation.ease.end).duration(300).go();}},_reorderFlids:function(){var a={reorder:1,flids:this.flSortableGroup.getOrder()};this._saveBuddyListSetting(a);},_getDragKey:function(b,a){return b+'_'+a;},_initDragging:function(){if(!this.flMode)return;var c=this._groupAvailableListByFl();this.sortables={};var b=this._getRenderedFriendLists();for(var d=0;d<b.length;d++){var a=b[d];var e=c[a];this._initFlidSortable(a,e);}},_initFlidSortable:function(c,d){if(!c||!this.flMode)return;if(this.flData[c].s)return;var b=head(this.sortables);this.sortables[c]=new SortableGroup();if(b)b.link(this.sortables[c]);var a=$N('div',{id:this._getEmptyListDropZoneId(c),className:'list_drop_zone'},$N('span',{className:'list_drop_zone_inner'},_tx(\"Drag a friend here to add\")));var f=$(this._getFriendListContainerId(c));this.sortables[c].addEmptyMessage(a,f).setBoundingBox(this._getBoundingBox()).setDragOverCallback(this._dragOverHandler.bind(this)).setDropCallback(this._dropHandler.bind(this)).setGrabCallback(this._grabHandler.bind(this));for(var e=0;e<d.length;e++)this._addSortable(d[e],c);},_getBoundingBox:function(){return Rect.newFromVectors(new Vector2(0,0),Vector2.getElementDimensions(this.contentDiv));},_destroyFlidSortable:function(a){if(!a||!this.flMode)return;if(this.sortables&&this.sortables[a]){this.sortables[a].destroy();delete this.sortables[a];}},_addSortable:function(b,a){if(!a||!this.flMode||!this.flData[a])return;if(this.flData[a].s)return;if(!this.sortables[a])return;var c=this._getDragKey(b,a);if(this.sortables[a].keyExists(c))return;this.sortables[a].addSortable(c,ge(this._getBuddyListItemId(b,a)));},_removeSortable:function(b,a,c){if(!a||!this.flMode)return;if(this.sortables[a])this.sortables[a].removeSortable(this._getDragKey(b,c||a));},_dragOverHandler:function(a,b){if(CSS.hasClass(b,'list_drop_zone')){var c=this._extractFlid(b.id);var d=$(this._getFriendListId(c));CSS.addClass(d,'drag_over');}},_grabHandler:function(a){CSS.addClass($('fbChatBuddyListParent'),'drag_active');},_dropHandler:function(e){CSS.removeClass($('fbChatBuddyListParent'),'drag_active');var k=e.split('_');if(k.length!=2)return;var d=k[0];var h=k[1];var c=$(this._getBuddyListItemId(d,h));if(!c)return;var g=this._extractFlid(c.parentNode.id);if(g==h){this._updateUIAfterDragging(d,h,h,c);}else{if(this.flData[h].s||this.flData[g].s){this._updateUIAfterDragging(d,h,h,c);return;}var a=this.availableList[d].fl;var f=false;var i=false;var j=false;if(g==this.otherFriendsFlid){i=true;if(a.length==1){this.availableList[d].fl=[this.otherFriendsFlid];}else{this.availableList[d].fl.remove(h);j=true;DOM.remove(c);Vector2.scrollIntoView(this.getBuddyItem(d));}}else if(a.length==1){this.availableList[d].fl=[g];f=h!=this.otherFriendsFlid;}else{f=true;this.availableList[d].fl.push(g);this.availableList[d].fl.remove(h);}if(j||this._updateUIAfterDragging(d,h,g,c)){var b;if(i){b={remove_fl:true,old_flid:h,drag_uid:d};}else if(f){b={move_fl:true,new_flid:g,old_flid:h,drag_uid:d};}else b={add_fl:1,new_flid:g,drag_uid:d};this._saveBuddyListSetting(b);}}this._resetFlidClasses();},_updateUIAfterDragging:function(c,f,e,a){var b=this._groupAvailableListByFl(true);var h=b[e];var d=h.indexOf(c);var g;if(d==-1){return false;}else if(d==0){g=$(this._getAvailableMarkerId(e));}else g=$(this._getBuddyListItemId(h[d-1],e));(function(){var j,k=false;if(h.length!=1)j=showHight=true;var i=this._expandItem(c,e,g,this.availableList[c].i,j,false,k);if(f!=e){DOM.remove(a);this._removeSortable(c,e,f);}Vector2.scrollIntoView(i);}).bind(this).defer(500);return true;},_getGlobalFlids:function(a){var b=this.flMode&&this.flData?keys(this.flData):[null];return a?b:b.concat(this.externalFlids);},_getUserFlids:function(d,a,b){a=a||this.availableList[d];var c=a.fl?a.fl:[null];if(!b){if(!a.allFlids)a.allFlids=this._addExternalFlids(d,c);c=a.allFlids;}return c;},_addExternalFlids:function(d,b){b=b.concat();for(var c=0;c<this.externalFlids.length;c++){var a=this.externalFlids[c];var e=this._getFlOpts(a);if(!e.excludeIds[d])b.push(a);}return b;},_getFlOpts:function(a){return this.flOpts[a]||ChatBuddyList.DEFAULT_OPTS;},_getAvailableMarkerId:function(a){return this._encodeFlid('buddy_list_avail_marker',a);},_getIdleMarkerId:function(a){return this._encodeFlid('buddy_list_idle_marker',a);},_getEmptyListDropZoneId:function(a){return this._encodeFlid('buddy_list_drop_zone',a);},_getBuddyListItemId:function(b,a){return this._encodeFlid('buddy_list_item_'+b,a);},_getBuddyListItemNameId:function(b,a){return this._encodeFlid('buddy_list_item_name_'+b,a);},_getBuddyListWasItemId:function(b,a){return this._encodeFlid('buddy_list_was_item_'+b,a);},_getEmptySearchId:function(a){return this._encodeFlid('buddy_list_empty_search',a);},_getBuddyListEmptyItemId:function(){return 'buddy_list_empty_item';},_encodeFlid:function(a,b){return b?(b+'_'+a):a;},_getFriendListId:function(a){return this._encodeFlid('friend_list_item',a);},_extractFlid:function(a){return a.split('_').shift();},_getFriendListContainerId:function(a){return this._encodeFlid('friend_list_container',a);},debugPrintUpdateOverlay:function(){var b=this.updateOverlay;for(var a in b);}};\nfunction ChatBuddyListDisplay(){this.inDock=!presence.inPopoutWindow;this.openFlyout=null;this.openControl=null;if(presence.inPopoutWindow)this.init();}ChatBuddyListDisplay.prototype={init:function(){this.init=bagofholding;if(this.inDock){var b=$('fbDockChatBuddylistNub');this.buddyListPanel=DOM.find(b,'.fbChatBuddylistPanel');this.flyout=DOM.find(b,'.fbNubFlyout');}else this.buddyListPanel=$('buddy_list_panel',true);var a=this._clickControlPanel.bind(this,'buddy_list_panel_lists_control','buddy_list_panel_lists_flyout',this._getListsFlyoutContent.bind(this));Event.listen(DOM.find(this.buddyListPanel,'#buddy_list_panel_lists_control a'),'click',a);var c=this._clickControlPanel.bind(this,'buddy_list_panel_settings_control','buddy_list_panel_settings_flyout',this._getChatSettingsNodes.bind(this));Event.listen(DOM.find(this.buddyListPanel,'#buddy_list_panel_settings_control a'),'click',c);},_clickVisibilityToggle:function(){chatOptions.toggleVisibility();this.closeOpenFlyout();},_clickReorderLists:function(){buddyList.enterReorderingFlMode();this.closeOpenFlyout();},_clickPopout:function(){presence.popout();this.closeOpenFlyout();},_clickControlPanel:function(a,b,c){if(this.openFlyout){if(this.openFlyout==b){this.closeOpenFlyout();}else{this.closeOpenFlyout();this._openFlyout(a,b,c());}}else this._openFlyout(a,b,c());return false;},_openFlyout:function(c,e,a){DOM.setContent($(e),a);CSS.removeClass(e,'hidden_elem');CSS.addClass(c,'flyout_open');if(this.inDock)CSS.addClass(this.flyout,'menuOpened');if(!presence.poppedOut){var d=Vector2.getElementDimensions($(e)).y;var b=Vector2.getElementDimensions(buddyList.getContentWrapper()).y;if(d>b)CSS.addClass(e,'flyout_reversed');}this.openFlyout=e;this.openControl=c;},isFlyoutOpen:function(){return this.openFlyout;},closeOpenFlyout:function(){if(!this.openFlyout)return;CSS.addClass(this.openFlyout,'hidden_elem');CSS.removeClass(this.openFlyout,'flyout_reversed');CSS.removeClass(this.openControl,'flyout_open');if(this.inDock)CSS.removeClass(this.flyout,'menuOpened');this.openFlyout=null;this.openControl=null;},_getListsFlyoutContent:function(){var f=$N('input',{className:'inputtext',type:'text'});f.listen('keypress',buddyList.keyPressNewListInput.bind(buddyList));new TextInputControl(f).setPlaceholderText(_tx(\"Type a list name\"));var e=$N('div',{className:'new_list'},[$N('span',{},_tx(\"Create a new list:\")),f]);var d=$N('div',{className:'text'},_tx(\"Display these lists in Chat:\"));var b=buddyList.getFriendLists();var a=new UISelectList();a.setCallback(buddyList.handleFlInChat.bind(buddyList));for(var c in b)a.addItem(b[c].n,!b[c].h,c);return [d,a.getElement(),e];},_renderListSettingToggle:function(c,a,b){return this._renderToggle('list_online_'+c,a,b,'list_online_checkbox_'+c,function(d,e){buddyList.handleFlInChat(c,d);});},_renderChatSettingToggle:function(b,c,a){return this._renderToggle('chat_setting_'+b,c,a,'chat_setting_checkbox_'+b,function(d,e){this.sendSettingChange(b,d.checked);}.bind(this));},_renderToggle:function(d,c,e,b,g){var a=$N('input',{type:'checkbox',id:b,name:b});a.checked=c;a.defaultChecked=c;a.listen('click',g.bind(this,a));var f=$N('label',{},e);f.setAttribute('for',b);return $N('div',{className:'chat_setting clearfix',id:d},[$N('div',{className:'input_box'},[$N('span',{className:'show_loading'},$N('img',{src:'\/images\/loaders\/indicator_blue_small.gif'})),$N('span',{className:'hide_loading'},a)]),f]);},_getChatSettingsNodes:function(){var c=[];if(this.buddyListPanel){var d=$N('a',{className:'go_offline_control'},[$N('div',{className:'menu_icon'}),$N('span',{},_tx(\"Go Offline\"))]);d.listen('click',this._clickVisibilityToggle.bind(this));var e=$N('div',{className:'options_actions'},d);if(buddyList._getFriendListsInChat().length>1){var g=$N('a',{className:'list_reorder_control'},[$N('div',{className:'menu_icon'}),$N('span',{},_tx(\"Re-order Lists\"))]);g.listen('click',this._clickReorderLists.bind(this));e.appendChild(g);}var f=$N('a',{className:'list_popout_control'},[$N('div',{className:'menu_icon'}),$N('span',{},(presence.poppedOut?_tx(\"Pop in Chat\"):_tx(\"Pop out Chat\")))]);f.listen('click',this._clickPopout.bind(this));e.appendChild(f);c.push(e);c.push($N('hr',{className:'menu_divider'}));}var b=[{name:'sound',label:_tx(\"Play Sound for New Messages\")},{name:'sticky_buddylist',label:_tx(\"Keep Online Friends Window Open\")},{name:'compact_buddylist',label:_tx(\"Show Only Names in Online Friends\")}];for(var a=0;a<b.length;a++)c.push(this._renderChatSettingToggle(b[a].name,chatOptions.getSetting(b[a].name),b[a].label));return c;},_onSettingChangeResponse:function(a,c,b){chatOptions.setSetting(a,c);CSS.removeClass($('chat_setting_'+a),'chat_setting_loading');presence.doSync();},_onSettingChangeError:function(c,d){CSS.removeClass($('chat_setting_'+c),'chat_setting_loading');var b=$('chat_setting_checkbox_'+c);b.checked=!b.checked;var a=_tx(\"Chat\");this.closeOpenFlyout();buddyList.enterErrorMode(_tx(\"Unable to save your {Chat} settings\",{Chat:a}));},sendSettingChange:function(b,c){CSS.addClass($('chat_setting_'+b),'chat_setting_loading');var a={};a[b]=c;new AsyncRequest().setHandler(this._onSettingChangeResponse.bind(this,b,c)).setErrorHandler(this._onSettingChangeError.bind(this,b)).setData(a).setURI(chatDisplay.settingsURL).setAllowCrossPageTransition(true).send();}};\nfunction NubController(a){this.el=a;this.init();}copy_properties(NubController,{FLYOUT_CONTENT_CHANGED:'nub\/flyout\/content-changed'});NubController.mixin('Arbiter',{init:bagofholding,click:bagofholding,flyoutContentChanged:function(){this.inform(NubController.FLYOUT_CONTENT_CHANGED);},hide:bagofholding,resize:bagofholding,setDock:function(a){this.dock=a;},show:bagofholding});\nvar Dock={MIN_HEIGHT:140,INITIAL_FLYOUT_HEIGHT_OFFSET:10,stateItems:[],init:function(a){this.init=bagofholding;this.rootEl=a;this.calculateViewportDimensions();this.calculateFlyoutHeightOffset();Event.listen(a,'click',this._onClick.bind(this));Event.listen(window,'resize',this._onWindowResize.bind(this));Arbiter.subscribe(\"page_transition\",this._onPageTransition.bind(this));this._adjustTooltips();Event.listen(a,'mouseover',this._fixTitlebarHover.bind(this));Event.listen(a,'mouseout',this._fixTitlebarHover.bind(this));this.registerStateItems();this.initialized=true;},calculateViewportDimensions:function(){return this.viewportDimensions=Vector2.getViewportDimensions();},calculateFlyoutHeightOffset:function(){this.flyoutHeightOffset=this.INITIAL_FLYOUT_HEIGHT_OFFSET+Vector2.getElementDimensions(this.rootEl).y;var a=ge('pageHead');if(a)this.flyoutHeightOffset+=Vector2.getElementPosition(a).y+Vector2.getElementDimensions(a).y;},toggle:function(a){var c=DOM.findParentByClass(a,'fbNub'),b=this._findFlyout(c);if(!b)return;var d=this.getToggler(c);d.toggle(a,function(e){if(e){this._resizeNubFlyout(c);this.notifyNub(c,'show');}else this.notifyNub(c,'hide');}.bind(this));},show:function(b){var c=this.getToggler(b);if(!DOM.contains(b,c.getActive())){CSS.addClass(b,'openToggler');var a=DOM.find(b,'a.fbNubButton');this.toggle(a);}},showNub:function(b){CSS.removeClass(b,'hidden_elem');var a=DOM.find(b,'a.fbNubButton');this._adjustTooltip(a);},hide:function(a){var b=this.getToggler(a);DOM.contains(a,b.getActive())&&b.hide();},hideNub:function(a){CSS.addClass(a,'hidden_elem');this.hide(a);},_resizeNubFlyout:function(l,j){var g=this._findFlyout(l);if(!g)return;var c=DOM.find(g,'div.fbNubFlyoutBody'),e=DOM.find(c,'div.fbNubFlyoutBodyContent'),d=Vector2.getElementDimensions(e),h=DataStore.get(g,'dock:nub:flyout:padding'),f;var k=DataStore.get(g,'dock:nub:flyout:height');if(j||!h){f=Vector2.getElementDimensions(g);if(k){var b=Vector2.getElementDimensions(c);h=f.y-b.y;}else h=f.y-d.y;DataStore.set(g,'dock:nub:flyout:padding',h);}var a=Math.max(this.MIN_HEIGHT-h,this.viewportDimensions.y-h-this.flyoutHeightOffset);if(k)a=Math.min(a,k-h);if(k||d.y>a){c.style.height=a+'px';}else c.style.height='auto';CSS.removeClass(g,'swapDirection');var i=Vector2.getElementPosition(g).x;CSS.conditionClass(g,'swapDirection',function(){if(i<0)return true;if(!f)f=Vector2.getElementDimensions(g);return i+f.x>this.viewportDimensions.x;}.bind(this)());this.notifyNub(l,'resize');},resizeAllFlyouts:function(){var b=DOM.scry(this.rootEl,'div.fbNub.openToggler'),a=b.length;while(a--)this._resizeNubFlyout(b[a]);},_onClick:function(event){var b=event.getTarget(),a=DOM.findParentByClass(b,'fbNub');if(a)if(DOM.findParentByClass(b,'fbNubFlyoutTitlebar')){this.hide(a);return false;}else this.notifyNub(a,'click');},_onPageTransition:function(){this._flushDockState();},_onWindowResize:function(event){this.calculateViewportDimensions();this.resizeAllFlyouts();this._adjustTooltips();},_adjustTooltip:function(a){var b=DOM.scry(a,'span.uiTooltipWrap')[0];if(b){var c=Vector2.getElementPosition(a).x;if(c){if(this._isRTL())c=this.viewportDimensions.x-c;CSS.conditionClass(b,'right',c>this.viewportDimensions.x\/2);}}},_adjustTooltips:function(){var a=DOM.scry(this.rootEl,'a.fbNubButton.uiTooltip');a.each(this._adjustTooltip.bind(this));},_fixTitlebarHover:function(event){var c=event.getTarget(),d=DOM.findParentByClass(c,'fbNubFlyoutTitlebar');if(d){var a=event.type==='mouseover';var b=c.tagName;CSS.conditionClass(d,'titlebarHover',!(!a||b==='A'||b==='INPUT'||b==='LABEL'));}},_findFlyout:function(a){return flyoutEl=CSS.hasClass(a,'fbNubFlyout')?a:DOM.scry(a,'div.fbNubFlyout')[0]||null;},setFlyoutContentHeight:function(a,b){a=this._findFlyout(a);if(!a)return;DataStore.set(a,'dock:nub:flyout:height',b);},registerNubController:function(b,a){DataStore.set(b,'dock:nub:controller',a);a.setDock(this);a.subscribe(NubController.FLYOUT_CONTENT_CHANGED,this._resizeNubFlyout.bind(this,b,false));},unregisterNubController:function(a){DataStore.remove(a,'dock:nub:controller');},notifyNub:function(c,d,b){var a=DataStore.get(c,'dock:nub:controller');if(a&&d in a)return a[d](b,c);return true;},registerTogglerGroup:function(a,c){var b=copy_properties({sticky:true},c);DataStore.set(a,'dock:nub-group:toggler',new Toggler(b));},getToggler:function(a){while(a&&a!==this.rootEl){var b=DataStore.get(a,'dock:nub-group:toggler');if(b)return b;a=a.parentNode;}return Toggler;},_getNubContainer:function(a,b){var c=DOM.scry(this.rootEl,'div.fbDock .'+a)[0];if(!c&&b)c=DOM[a==='lNubContainer'?'prependContent':'appendContent'](this.rootEl.firstChild,HTML('<div class=\"'+a+'\"><\/div>'))[0];return c||null;},_getLeftNubContainer:function(a){return this.leftNubContainer=this.leftNubContainer||this._getNubContainer('lNubContainer',a);},_getRightNubContainer:function(a){return this.rightNubContainer=this.rightNubContainer||this._getNubContainer('rNubContainer',a);},registerStateItem:function(d,e,f){var c=e==='left'?this._getLeftNubContainer(true):this._getRightNubContainer(true);if(!c.firstChild){var a=e==='left'?'fbDockWrapperRight':'fbDockWrapperLeft';CSS.removeClass(this.rootEl,a);}var b=f?'lastChild':'firstChild';while(d[b]){this.stateItems.push(d[b]);DOM[f?'prependContent':'appendContent'](c,d[b]);}DOM.remove(d);this._adjustTooltips();},registerStateItems:function(){if(this.initialized){var a=window.DockStateItems;while(a&&a.length)this.registerStateItem.apply(this,a.shift());}},_flushDockState:function(){this.stateItems.each(DOM.remove);this.stateItems=[];var a=this._getLeftNubContainer();if(a&&!a.firstChild)CSS.addClass(this.rootEl,'fbDockWrapperRight');var b=this._getRightNubContainer();if(b&&!b.firstChild)CSS.addClass(this.rootEl,'fbDockWrapperLeft');},_isRTL:function(){if(typeof this._rtl==='undefined')this._rtl=intl_locale_is_rtl();return this._rtl;}};\nfunction DockChat(){}DockChat.mixin('Arbiter',{init:function(a,b){this.tabContainer=new DockChatTabContainer(b);this.buddylistNub=new DockChatBuddyListNub(a,this.tabContainer);Dock.registerNubController(a,this.buddylistNub);this.inform('init',this);}});function DockChatTabContainer(a){this.el=a;this.init();}DockChatTabContainer.mixin('Arbiter',{init:function(){this.view=window.chatDisplay;}});function DockChatBuddyListNub(a,b){this.parent.construct(this,a);this.tabContainer=b;}DockChatBuddyListNub.extend('NubController');DockChatBuddyListNub.prototype={init:function(){this.parent.init();this.controller=window.buddyList;this.controller.setNubController(this);this.view=window.buddyListDisplay;},setSticky:function(a){var b=Dock.getToggler(this.el);b&&b.setSticky(a);},show:function(){this.controller.openTab(true);},hide:function(){this.controller.closeTab();}};function DockChatTabNub(b,a){this.parent.construct(this,b);this.controller=a;}DockChatTabNub.extend('NubController');DockChatTabNub.prototype={init:function(){this.parent.init();Dock.registerNubController(this.el,this);},show:function(){var a=window.chatDisplay;if(a.focused!=this.controller.id)a.focusTab(this.controller.id);},hide:function(){var a=window.chatDisplay;if(this.controller.focused)a.unfocus();}};\nfunction ChatOptions(b,a){this.visibility=b;this.settings=a;this._init();}copy_properties(ChatOptions,{VISIBILITY_CHANGED:'chat\/visibility-changed'});ChatOptions.prototype={_init:function(){presence.registerStateStorer(this._storeState.bind(this));presence.registerStateLoader(this._loadState.bind(this));},_storeState:function(a){a.vis=this.visibility;a.bls=this.getSetting('sticky_buddylist');a.blc=this.getSetting('compact_buddylist');a.snd=this.getSetting('sound');return a;},_loadState:function(a){if(a.vis!=this.visibility)this.setVisibility(a.vis);this.setSetting('sticky_buddylist',a.bls);this.setSetting('compact_buddylist',a.blc);this.setSetting('sound',a.snd);},setVisibility:function(a){if(a==this.visibility)return;this.visibility=a;if(a){channelManager.isActionRequest=true;channelManager.rebuild(ChannelRebuildReasons.UIRestart);}else channelManager.setReady(false);Arbiter.inform(ChatOptions.VISIBILITY_CHANGED,{sender:this});},_onVisibilityResponse:function(a,b){presence.pauseSync();this.setVisibility(a);if(!presence.inPopoutWindow&&!a)chatDisplay.unfocus();presence.resumeSync();if(presence.poppedOut)presence.popout();},_onVisibilityError:function(b){var a=_tx(\"Chat\");buddyList.enterErrorMode(_tx(\"Unable to save your {Chat} settings\",{Chat:a}));},toggleVisibility:function(){this.sendVisibility(!this.visibility);},sendVisibility:function(c){if(this.visibility==c)return;var a={visibility:c};var b=chatDisplay._getIDsToNotifyVisibility(c);if(b)a.notify_ids=b;this.visibilityAsync=new AsyncRequest().setHandler(this._onVisibilityResponse.bind(this,c)).setErrorHandler(this._onVisibilityError.bind(this)).setData(a).setURI(chatDisplay.settingsURL).setAllowCrossPageTransition(true).send();},getSetting:function(a){return this.settings[a];},setSetting:function(a,b){if(this.getSetting(a)==b)return;if(a=='compact_buddylist'){buddyList.setCompactDisplay(b);}else if(a==='sticky_buddylist')buddyList.nubController.setSticky(b);this.settings[a]=b;}};\nfunction ChatTabSlider(){this.inDock=!presence.inPopoutWindow;this.handleWidth=136;this.animationTime=210;this._init();}ChatTabSlider.prototype={_init:function(){this.org_s=0;this.numToShow=0;this.numShift=1;this.shiftByNumTabs=false;this.timer=null;this.skipAnimation=false;this.chatWidth=null;this.tabPos={};if(this.inDock){var a=$('fbDockChatTabSlider');this.chat=ge('fbDockChatTabsWrapper');this.chatTabBar=ge('fbDockChatTabs');this.nextTab=DOM.find(a,'div.next');Event.listen(this.nextTab,'click',this.next.bind(this));this.prevTab=DOM.find(a,'div.previous');Event.listen(this.prevTab,'click',this.prev.bind(this));this.nextCounter=DOM.find(this.nextTab,'span.numTabs');this.prevCounter=DOM.find(this.prevTab,'span.numTabs');this.numMissedNextCounter=DOM.find(this.nextTab,'span.numMessages');this.numMissedPrevCounter=DOM.find(this.prevTab,'span.numMessages');}else{this.chat=ge('chat');this.chatTabBar=ge('chat_tab_bar');this.nextTab=ge('chat_next_tab');this.prevTab=ge('chat_previous_tab');this.nextCounter=ge('next_count');this.prevCounter=ge('prev_count');this.numMissedNextCounter=ge('next_num_missed');this.numMissedPrevCounter=ge('prev_num_missed');}this.numNext=0;this.numPrev=0;this.prevTabs={};this.nextTabs={};presence.registerStateLoader(this._load.bind(this));presence.registerStateStorer(this._store.bind(this));Event.listen(window,'resize',this._resize.bind(this,false));},load:function(){this._load(presence.state);this._resize(true);},_load:function(a){var b=0;if(a)b=(a.s?a.s:b);this._setPos(b);},_store:function(a){a.s=this._s;return a;},_calculate:function(a){this._setMaxWidth();if(a)this.maxWidth-=16;if(presence.poppedOut){this.numToShow=chatDisplay.numTabs;}else{this.numToShow=parseInt(this.maxWidth\/this.handleWidth);this.numToShow=this.numToShow>0?this.numToShow:1;}if(this.shiftByNumTabs)this.numShift=this.numToShow;if(this._s!=null)this._setPos(this._s);},_setMaxWidth:function(){if(this.inDock){var d=document.body.clientWidth;var a=DOM.findParentByClass(this.chat,'fbDock').firstChild;for(;a;a=a.nextSibling)d-=a.clientWidth;d+=this.chat.clientWidth;this.maxWidth=d-70;}else{var d=document.body.offsetWidth;if(ChatTabSlider.presenceWidthTest)var d=$('presence_ui').offsetWidth;var b=['buddy_list_tab','presence_notifications_tab'];for(var c=0;c<b.length;c++)d-=(ge(b[c])&&$(b[c]).clientWidth!=undefined)?ge(b[c]).clientWidth:0;this.maxWidth=(presence.poppedOut?d-254:d-138);}},_setPos:function(a){if(a<0)a=0;this._s=a;this._e=this._s+this.numToShow;},_doSync:function(){var a=(this.org_s!=this._s);this.org_s=0;if(a)presence.doSync();},_build:function(){if(presence.poppedOut)return;var a=(this.numToShow>=chatDisplay.numTabs)?true:false;this.setVisibleTabs(a);if(a){this.resetCounters();}else this.updateCounters();this.updateMissedCount();},_resize:function(a){this.org_s=this._s;this._calculate(a);this._build();this._doSync();if(chatDisplay.lastFocused!=null)this.gotoTab(chatDisplay.lastFocused);},addTab:function(a){this._build();},gotoTab:function(a){if(this.tabPos[a]!=0&&!this.tabPos[a])return;var b=parseInt(this.tabPos[a]);if(!this._inRange(b)){var c=(b-this.numToShow)+1;this._setPos(c);this._build();}},close:function(a){if(this.tabPos[a]!=0&&!this.tabPos[a])return;delete this.tabPos[a];this._setPos(((this.numPrev>0||this.numNext>0)&&this._s>0)?this._s-1:0);this._calculate();this._build();},setVisibleTabs:function(a){var b=0;for(var c in chatDisplay.tabs){this.tabPos[c]=b;if(this._inRange(b,c)||a==true){chatDisplay.tabs[c].show();}else chatDisplay.tabs[c].hide();b++;}},_inRange:function(c,b){var d,a=false;if(c>=this._s){d=true;delete this.prevTabs[b];}else this.prevTabs[b]=b;if(c<this._e){a=true;delete this.nextTabs[b];}else this.nextTabs[b]=b;return (d&&a);},updateMissedCount:function(){var c=0;var b=0;for(var a in this.prevTabs)c+=chatDisplay.tabs[a]?chatDisplay.tabs[a].numMissed:0;this.numMissedPrevCounter.innerHTML=c;CSS.conditionClass(this.numMissedPrevCounter,'hidden_elem',!c);for(var a in this.nextTabs)b+=chatDisplay.tabs[a]?chatDisplay.tabs[a].numMissed:0;this.numMissedNextCounter.innerHTML=b;CSS.conditionClass(this.numMissedNextCounter,'hidden_elem',!b);},updateCounters:function(){this.numNext=chatDisplay.numTabs-this._e;this.numPrev=this._s;if(this.numNext<=0){this.numNext=0;CSS.addClass(this.nextTab,'disabled');}else CSS.removeClass(this.nextTab,'disabled');if(this.numPrev<=0){this.numPrev=0;CSS.addClass(this.prevTab,'disabled');}else CSS.removeClass(this.prevTab,'disabled');if(this.numPrev>0||this.numNext>0){if(this.inDock){CSS.removeClass(this.nextTab,'hidden_elem');CSS.removeClass(this.prevTab,'hidden_elem');}else{show('chat_next_tab');show('chat_previous_tab');}}else if(this.inDock){CSS.addClass(this.nextTab,'hidden_elem');CSS.addClass(this.prevTab,'hidden_elem');}else{hide('chat_next_tab');hide('chat_previous_tab');}this.nextCounter.innerHTML=this.numNext;this.prevCounter.innerHTML=this.numPrev;},resetCounters:function(){this._setPos(0);this.updateCounters();},shift:function(a){this.org_s=this._s;chatDisplay.unfocusNoSync();this._shift.bind(this,a).defer();},_shift:function(a){this._setPos(this._s<0?0:this._s+a);this._slide(a);if(this.timer||this.skipAnimation){this._slideReset();this.skipAnimation=true;var b=setTimeout(function(){this.skipAnimation=false;}.bind(this),500);}else this.timer=setTimeout(function(){this._slideReset();}.bind(this),this.animationTime);},_slide:function(a){this._slideSetup(false);this.setVisibleTabs(true);this.slideInc=(a*(this.handleWidth));this.leftPos=-(a)*(this.numNext*(this.slideInc));this.chatTabBar.style.left=this.leftPos+'px';animation(this.chatTabBar).by('left',this.slideInc).duration(this.animationTime-10).go();},_slideSetup:function(a){this.chat.style.position=a?'':'relative';this.chat.style.overflow=a?'visible':'hidden';if(!this.chatWidth)this.chatWidth=this.chatTabBar.clientWidth;if(a)this.chatWidth=null;this.chat.style.width=a?'':this.chatWidth+'px';this.chatTabBar.style.width=a?'':chatDisplay.numTabs*this.handleWidth+'px';this.chatTabBar.style.position=a?'':'absolute';},_slideReset:function(){clearTimeout(this.timer);this.timer=null;this._slideSetup(true);this._build();if(chatDisplay.lastFocused)if(this._inRange(this.tabPos[chatDisplay.lastFocused])){chatDisplay.refocus();}else chatDisplay.lastFocused=null;this._doSync();},next:function(){if(this.numNext<=0)return;this.shift(this.numShift);},prev:function(){if(this.numPrev<=0)return;this.shift(-this.numShift);}};\nfunction MenubarMessageController(b,a){}copy_properties(MenubarMessageController,{ensureInitialized:function(c,b,a){if(MenubarMessageController.initialized||!ge(b))return false;var d=new MenubarMessageController(c,b);MenubarMessageController.instance=d;d.ensureInitialized(c,b,a);MenubarMessageController.initialized=true;}});copy_properties(MenubarMessageController.prototype,{ensureInitialized:function(c,b,a){this.menu=ge(b);var d=[CounterDisplay.EVENT_TYPE_ADJUST+'\/messages_unread',CounterDisplay.EVENT_TYPE_UPDATE+'\/messages_unread'];Arbiter.subscribe(d,this.onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);this._dirty=a;Event.listen($(c),'mouseover',this.doRefetch.bind(this));},doRefetch:function(){if(this._dirty){this._dirty=false;this._fetch();}},_fetch:function(){new AsyncRequest().setURI('\/ajax\/gigaboxx\/endpoint\/ListThreads.php').setMethod('GET').setReadOnly(true).setHandler(this.onFetchComplete.bind(this)).setData({folder:'[fb]messages',start:0,limit:5,previews:true}).send();},onFetchComplete:function(a){if(this.menu)DOM.setContent(this.menu,HTML(a.payload));},onCounterUpdate:function(){this._dirty=true;}});\nvar Jewel={toggle:function(b,a){Toggler.toggle(b,this.markSeen.bind(this,a));},markSeen:function(b,c,a){if(c){CSS.removeClass(a,'jewelNew');if(b=='[fb]messages')MenubarMessageController.instance.doRefetch();new AsyncSignal('\/ajax\/gigaboxx\/endpoint\/UpdateLastSeenTime.php',{folder:b}).send();}else if(\/requests\/.test(b))DOM.scry(a,'li.jewelItemNew').each(function(d){CSS.removeClass(d,'jewelItemNew');});}};\nfunction ChatNotificationList(){this.alertIds=[];this.alertsObj={};this.contentRoot=null;this.noItemsElement=null;this.ITEM_UNREAD_CLASS='jewelItemNew';this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';}ChatNotificationList.prototype={setUnreadItemClass:function(a){this.ITEM_UNREAD_CLASS=a;},setItemTag:function(a){this.ITEM_TAG=a;},setItemClass:function(a){this.ITEM_CLASS=a;},setNoItemsClass:function(a){this.NO_ITEMS_CLASS=a;},getAlertIds:function(){return this.alertIds;},fromDom:function(b){this.contentRoot=b;var f=this.ITEM_TAG;if(this.ITEM_CLASS)f+='.'+this.ITEM_CLASS;var d=DOM.scry(this.contentRoot,f);for(var e=0;e<d.length;e++){var c=d[e];var a=parseInt(c.getAttribute('id').replace('notification_',''),10);this.alertIds.push(a);this.alertsObj[a]=c;}this.alertIds.sort(function(g,h){return h-g;});},add:function(b,c,d){b=parseInt(b,10);if(this.alertsObj[b]){if(!d){return false;}else DOM.replace(this.alertsObj[b],HTML(c));}else{var e=-1,f=-1;for(var a=0;a<this.alertIds.length;a++)if(this.alertIds[a]<b){e=this.alertIds[a];f=a;break;}if(-1==e){if(!this.isEmpty()){DOM.appendContent(this.contentRoot,HTML(c));}else DOM.prependContent(this.contentRoot,HTML(c));this.alertIds.push(b);}else{DOM.insertBefore(HTML(c),this.alertsObj[e]);this.alertIds.splice(f,0,b);}}this.alertsObj[b]=$('notification_'+b);if(1==this.size())hide(this.NO_ITEMS_ID);return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=ge(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=$N(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},_tx(\"No new notifications.\"));DOM.appendContent(this.contentRoot,this.noItemsElement);}CSS.removeClass(this.NO_ITEMS_ID,'hidden_elem');},remove:function(b){var a=this.alertsObj[b];if(!this.alertsObj[b])return false;DOM.remove(a);delete this.alertsObj[b];this.alertIds.splice(this.alertIds.indexOf(b),1);if(this.isEmpty())this.showNoNotifications();return true;},getUnreadIds:function(a){var d=[];a=a||this.alertIds;for(var c=0;c<a.length;c++){var b=this.alertsObj[a[c]];if(b&&CSS.hasClass(b,this.ITEM_UNREAD_CLASS))d.push(a[c]);}return d;},markRead:function(a){for(var c=0;c<a.length;c++){var b=this.alertsObj[a[c]];animation(b).duration(1500).checkpoint().to('backgroundColor','#FFFFFF').duration(2250).ondone(CSS.removeClass.bind(null,b,this.ITEM_UNREAD_CLASS)).go();}return 0!=a.length;},markReadNow:function(){for(var a in this.alertsObj)CSS.removeClass(this.alertsObj[a],this.ITEM_UNREAD_CLASS);},addMany:function(b){var c=0;if('object'==typeof b&&!is_empty(b))for(var a in b)if(this.add(a,b[a]))c++;if(0==c&&this.isEmpty()){this.showNoNotifications();}else hide(this.NO_ITEMS_ID);return c;},isEmpty:function(){return 0==this.size();},size:function(){return this.alertIds.length;}};function ChatNotifications(b,c,g,d,e,f,a){this.count=b;this.countNew=c;this.updateTime=g;this.user=Env.user;this.cache_version=a;this.latest_notif_time=d;this.latest_read_notif_time=e;this.piggyback_percentage=f;this.wrapperID='notificationsWrapper';this.contentID='jewelNotifs';this.navInboxID='mailWrapper';this.timeElement='small.time';this.alertList=new ChatNotificationList();this._init();}ChatNotifications.UPDATER_NAME='notifications';ChatNotifications.BEEPS_EXPIRED='beeper\/beeps_expired';ChatNotifications.prototype={_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.navInbox=ge(this.navInboxID);this.countSpan=ge('presence_notifications_count');this.alertList.fromDom(this.content);this._updateCount();this.initializeEvents();Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notification'),this._handleNotificationMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('inbox'),this._handleInboxMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notifications_read'),this._handleNotificationsReadMsg.bind(this));Arbiter.subscribe(PresenceMessage.PRESENCE_UPDATER_READY,this.registerForUpdates.bind(this));if(this.wrapper){this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');if(this.isTabOpen())this.loadTab();}},initializeEvents:function(){var a=null;Event.listen(this.content,{mouseover:function(event){var b=event.getTarget();a=DOM.getNearest(b,'li');if(a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;},click:function(event){var b=event.getTarget();if(!DOM.isNode(b,'a'))goURI(DOM.getNearest(b,'li').getAttribute('data-uri'));}});},registerForUpdates:function(){presenceUpdater.register(ChatNotifications.UPDATER_NAME,this._checkUpdater.bind(this),this._onUpdaterResponse.bind(this),this._onUpdaterError.bind(this),this._onUpdaterError.bind(this));},notifyRead:function(a){var b=null;if(a)b={alert_ids:a};AsyncRequest.pingURI('\/ajax\/presence\/notifications_read.php',b);},markRead:function(c,a,b){if(this.countNew==0)return;a=a||this.alertList.getUnreadIds();this.countNew=b?b:0;this._updateCount();if(!c)this.notifyRead(a);this.alertList.markRead(a);CSS.removeClass(this.wrapper,'jewelNew');CSS.addClass(this.wrapper,'jewel');},requiresUpdate:function(c,a,b){if(!buddyList._checkUpdater(c,{},b))return false;if(a&&undefined!=a[ChatNotifications.UPDATER_NAME])return a[ChatNotifications.UPDATER_NAME];return b||((100\/(this.updateCheckCount+1))<=this.piggyback_percentage);},_checkUpdater:function(c,a,b){if(!buddyList._checkUpdater(c,{},b))return false;if(this.requiresUpdate(c,{},b)){this.updateCheckCount=0;a.notif_latest=this.latest_notif_time;a.notif_latest_read=this.latest_read_notif_time;a[ChatNotifications.UPDATER_NAME]=1;return true;}else{this.updateCheckCount++;a[ChatNotifications.UPDATER_NAME]=0;}return false;},_updateInboxMarkup:function(a,c){this._updateInboxUnreadCount(a);var b=ge('fb_menu_inbox_dropdown');if(b&&c)DOM.setContent(b,HTML(c));},_updateInboxUnreadCount:function(a){CounterDisplay.setCount('messages_unread',a);this.navInbox&&CSS.conditionClass(this.navInbox,'jewelUnread',(a>0));},_updateInboxUnseenCount:function(a){CounterDisplay.setCount('messages_unseen',a);this.navInbox&&CSS.conditionClass(this.navInbox,'jewelNew',(a>0));},_onUpdaterResponse:function(a,b){if(!a.no_change){if(this.count!=a.count)this.count=a.count;this.updateTime=b;this.latest_notif_time=a.latest_notif;this.latest_read_notif_time=a.latest_read_notif;this.countNew=a.countNew;this._updateDisplayDelayed();this.alertList.addMany(a.markup_map);Arbiter.inform(Arbiter.NEW_NOTIFICATIONS,a);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(ChatNotifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)Arbiter.unsubscribe(this.beepsExpiredToken);},_onUpdaterError:function(a){},_updateCount:function(){if(this.countSpan)DOM.setContent(this.countSpan,this.countNew);CSS.conditionClass(this.wrapper,'jewelNew',(this.countNew>0));},loadTab:function(){if(!this.fetch())this.markRead();},fetch:function(){endpoint=URI('\/ajax\/presence\/notifications_read.php');endpoint.setQueryData({time:this.latest_notif_time,user:this.user,version:this.cache_version,render:1});var a=ge('presence_notifications_loading');new AsyncRequest().setURI(endpoint).setStatusElement(a).setMethod('GET').setReadOnly(true).setHandler(this.fetchHandler.bind(this)).setAllowCrossPageTransition(true).send();return true;},fetchHandler:function(d){var c=d.getPayload();this.alertList.addMany(c.markup_map);var b=ge('presence_notifications_loading');b&&DOM.remove(b);var e=c.generated;var a=(new Date()).getTime()\/1000;if(a-e>15){e=a;this.alertList.markReadNow();}Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(e);LiveTimer.startLoop(0);});this.markRead(true);this.fetch=bagofholding;},_mergeNotification:function(a,b,c){if(!this.alertList.add(a,b)){return;}else this.latest_notif_time=0;this.count++;if(c)this.countNew++;this._updateCount();if(this.isTabOpen())this._merged_mouseover_handler=this.content.listen('mouseover',(function(){this._merged_mouseover_handler.remove();this.markRead();}).bind(this));var d=this.alertList.alertsObj[a];if(d)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(d);});},_handleInboxMsg:function(c,a){var b=a.obj;if(b){this._updateInboxUnreadCount(b.unread);this._updateInboxUnseenCount(b.unseen);}},_handleNotificationMsg:function(c,a){var b=a.obj;if(b.markup){this._mergeNotification(b.alert_id,b.markup,b.unread);}else presenceUpdater.runHandler('notifications');},_handleNotificationsReadMsg:function(c,a){var b=a.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(true,b.alert_ids);this.markRead(true,b.alert_ids,b.num_unread);},isTabOpen:function(){return this.wrapper&&CSS.hasClass(this.wrapper,'jewelOn');}};\nvar TypeaheadUtil=(function(){var c=\/[ ]+\/g,d=\/[^ ]+\/g,a=\/[^\\w ]\/g,b=\/[-~_\\u2010\\u2011\\u2012\\u2013\\u2014\\u2015]+\/g;var e=new RegExp('(\\\\'+['\/','.','*','+','?','|','(',')','[',']','{','}','\\\\'].join('|\\\\')+')','g');var f={\"\\u0430\":'a',\"\\u00e0\":'a',\"\\u00e1\":'a',\"\\u00e2\":'a',\"\\u00e3\":'a',\"\\u00e4\":'a',\"\\u00e5\":'a',\"\\u0431\":'b',\"\\u0446\":'c',\"\\u00e7\":'c',\"\\u0434\":'d',\"\\u00f0\":'d',\"\\u044d\":'e',\"\\u0435\":'e',\"\\u00e8\":'e',\"\\u00e9\":'e',\"\\u00ea\":'e',\"\\u00eb\":'e',\"\\u0444\":'f',\"\\u0433\":'g',\"\\u011f\":'g',\"\\u0445\":'h',\"\\u0438\":'i',\"\\u00ec\":'i',\"\\u00ed\":'i',\"\\u00ee\":'i',\"\\u00ef\":'i',\"\\u0131\":'i',\"\\u0439\":'j',\"\\u043a\":'k',\"\\u043b\":'l',\"\\u043c\":'m',\"\\u043d\":'n',\"\\u00f1\":'n',\"\\u043e\":'o',\"\\u00f8\":'o',\"\\u00f6\":'o',\"\\u00f5\":'o',\"\\u00f4\":'o',\"\\u00f3\":'o',\"\\u00f2\":'o',\"\\u043f\":'p',\"\\u0440\":'r',\"\\u0441\":'s',\"\\u015f\":'s',\"\\u0442\":'t',\"\\u0443\":'u',\"\\u044e\":'u',\"\\u00fc\":'u',\"\\u00fb\":'u',\"\\u00fa\":'u',\"\\u00f9\":'u',\"\\u0432\":'v',\"\\u044b\":'y',\"\\u00ff\":'y',\"\\u00fd\":'y',\"\\u0437\":'z',\"\\u00e6\":'ae',\"\\u0153\":'oe',\"\\u0446\":'ts',\"\\u0447\":'ch',\"\\u0448\":'sh',\"\\u044f\":'ya'};var g=function(l){return l?l.replace(a,' '):'';};var h=function(l){return l?l.replace(e,'\\\\$1'):'';};var i=function(o){o=(''+o).toLowerCase();var n='',l='';for(var m=o.length;m--;){l=o.charAt(m);n=(f[l]||l)+n;}return n.replace(c,' ');};var j=function(l){return l?l.replace(b,' '):'';};var k=function(p){p=p.toLowerCase();var m=i(p),l=g(m),o=j(m);if(p!=m)p+=' '+m;if(p!=l)p+=' '+l;if(p!=o)p+=' '+o;var q=[],r={},n=d.exec(p);while(n){n=n[0];if(!r[n]){q.push(n);r[n]=true;}n=d.exec(p);}return q;};return {escape:h,flatten:i,tokenize:k};})();\nfunction DataSource(a){copy_properties(this,a);}DataSource.mixin('Arbiter',{events:['activity','query','respond'],maxResults:10,queryData:{},queryEndpoint:'',bootstrapData:{},bootstrapEndpoint:'',indexedFields:['text','tokens'],init:function(){this.init=bagofholding;this.numResults=this.maxResults;this.dirty();},dirty:function(){this.value=this.flatValue='';this.bootstrapped=false;this.data={};this.localCache={};this.queryCache={};},bootstrap:function(){if(this.bootstrapped)return;this.fetch(this.bootstrapEndpoint,this.bootstrapData);this.bootstrapped=true;},query:function(d){this.inform('beforeQuery',{});var a=TypeaheadUtil.flatten(d),c=this.buildUids(a),b=this.respond(d,c).filter(function(e){return e.type!='calltoaction';});this.value=d;this.flatValue=a;this.inform('query',{value:d,results:b});if(!a||!this.queryEndpoint||a in this.queryCache||b.length>=this.numResults)return false;this.inform('queryEndpoint',{value:d});this.fetch(this.queryEndpoint,this.getQueryData(d,c),d,a);return true;},getQueryData:function(c,b){var a=copy_properties({value:c},this.queryData||{});b=b||[];if(b.length)a.existing_ids=b.join(',');return a;},setQueryData:function(a,b){if(b)this.queryData={};copy_properties(this.queryData,a);return this;},respond:function(d,c,a){var b=this.buildData(c);this.inform('respond',{value:d,results:b,isAsync:a});return b;},fetch:function(c,b,e,d){if(!c)return;var a=new AsyncRequest().setURI(c).setData(b).setMethod('GET').setReadOnly(true).setHandler(function(f){this.fetchHandler(f,e,d);}.bind(this));if(!Env.is_dev)a.setErrorHandler(bagofholding);a.send();this.inform('activity',{activity:true,value:e});},fetchHandler:function(b,c,a){this.addEntries(b.getPayload().entries,c,a);this.inform('fetchComplete',{response:b,value:c});this.respond(c,this.buildUids(a),true);this.inform('activity',{activity:false,value:c});},addEntries:function(b,e,c){var d=this.processEntries(arrayize(b),e),a=this.buildUids(c,d);if(e){this.queryCache[c]=a;}else this.fillCache(a);},processEntries:function(a,b){return a.map(function(d,c){var e=(d.uid=d.uid+'');this.data[e]=d;d.index=c;d.query=b;return e;},this);},getEntry:function(a){return this.data[a]||null;},fillCache:function(b){var a=this.localCache;b.each(function(g){var d=this.data[g];if(!d)return;var f=this.getTokens(d);for(var c=0,e=f.length;c<e;++c){var h=f[c];if(!a[h])a[h]=[];a[h].push(g);}},this);},getTokens:function(e){if(e.preparedTokens)return e.preparedTokens;var f=[],b=this.indexedFields;for(var d=0,c=b.length;d<c;++d){var a=e[b[d]];if(a)f.push(a.join?a.join(' '):a);}return (e.preparedTokens=TypeaheadUtil.tokenize(f.join(' ')));},buildUids:function(h,b){if(!h)return b||[];var e=function(i,j){return this.data[i].index-this.data[j].index;}.bind(this);var f=TypeaheadUtil.tokenize(h),a=this.buildCacheResults(f,this.localCache).sort(e),d=this.buildQueryResults(h,f),c=a.concat(d,b||[]),g={};return c.filter(function(i){if(i in g)return false;return (g[i]=true);});},buildData:function(e){var c=[],b=this.numResults;for(var a=0;a<e.length&&b;++a){var d=e[a];c.push(this.data[d]);b--;}return c;},findQueryCache:function(d){var b=0,a=null;for(var c in this.queryCache)if(d.indexOf(c)==0&&c.length>b){b=c.length;a=c;}return this.queryCache[a]||[];},buildQueryResults:function(c,b){var a=this.findQueryCache(c);if(c in this.queryCache)return a;return a.filter(function(h){var i=this.getTokens(this.data[h]),f=i.length,d;for(var e=0;e<b.length;++e){for(d=0;d<i.length;++d){var g=new RegExp('^'+TypeaheadUtil.escape(b[e]));if(g.test(i[d]))break;}if(d==f)return false;}return true;},this);},buildCacheResults:function(n,b){var k=n.length,i=[],h={},g={};for(var e=0;e<k;++e){var m=n[e],l=new RegExp('^'+TypeaheadUtil.escape(m));for(var j in b)if(!(j in h)&&l.test(j)){h[j]=true;var d=b[j];for(var f=0,c=d.length;f<c;++f){var o=d[f];if(!(o in g)){i.push(o);g[o]=0;}g[o]|=(1<<e);}}}var a=(1<<k)-1;return i.filter(function(p){return !!(p&&g[p]==a);});}});\nfunction SearchDataSource(a){this.parent.construct(this,a);}SearchDataSource.extend('DataSource');SearchDataSource.prototype={minResults:3,maxResults:8,init:function(){this.parent.init();this.updateMaxResults();Event.listen(window,'resize',this.updateMaxResults.bind(this));},updateMaxResults:function(){var a=window.innerHeight||document.documentElement.clientHeight,b=Math.ceil(2+((a-370)\/56));this.numResults=Math.max(this.minResults,Math.min(this.maxResults,b));this.respond(this.value,this.buildUids(this.flatValue));}};\nfunction TypeaheadCore(a,b){this.element=$(a);copy_properties(this,b);}TypeaheadCore.mixin('Arbiter',{events:['reset','unselect'],keepFocused:true,resetOnSelect:false,setValueOnSelect:false,queryTimeout:250,init:function(a,d,c){this.init=bagofholding;this.data=a;this.view=d;var b=c.parentNode;this.root=CSS.getStyle(b,'position')!='static'?b:c;this.wrap=DOM.find(c,'div.wrap');this.hiddenInput=DOM.find(c,'input.hiddenInput');this.selectedText=this.getValue();this.initializeSubscriptions();this.initializeEvents();},initializeSubscriptions:function(){this.view.subscribe('select',function(a,b){this.select(b.selected.text,b.selected.uid);}.bind(this));this.data.subscribe('respond',function(b,a){if(a.value==undefined&&!this.selectedText){this.checkValue(true);}else if(a.value==this.getValue())this.view.render(a.value,a.results,a.isAsync);}.bind(this));this.data.subscribe('activity',function(b,a){this.fetching=a.activity;if(!this.fetching&&this.nextQuery)this.performQuery();}.bind(this));},initializeEvents:function(){var a=this.checkEvent.bind(this);Event.listen(this.element,{blur:a,focus:a,keyup:a});var b=ua.firefox()?'keypress':'keydown';Event.listen(this.element,b,a);this.keypress=this.keydown;if(ua.firefox())this.element.addEventListener('text',a,true);},select:function(a,b){if(this.resetOnSelect){this.reset();}else if(!this.keepFocused)this.element.blur();this.view.reset();if(this.setValueOnSelect){this.setValue(a);this.setHiddenValue(b);CSS.addClass(this.wrap,'selected');}this.selectedText=a;},unselect:function(){if(this.setValueOnSelect)CSS.removeClass(this.wrap,'selected');this.setHiddenValue();this.selectedText=null;this.inform('unselect',this);},reset:function(){this.unselect();this.setValue();this.view.reset();this.element.focus();if(!this.keepFocused)(function(){this.element.blur();}).bind(this).defer();this.inform('reset');},checkEvent:function(event){if(!event)return;var a=event.type;if(a=='text')a='keyup';this[a]&&this[a](event);this.checkValue.bind(this,false).defer();},blur:function(event){this.view.hide();CSS.removeClass(this.root,'uiTypeaheadFocused');},focus:function(event){if(!this.selectedText&&this.getValue())this.view.show();CSS.addClass(this.root,'uiTypeaheadFocused');},keyup:function(event){if(!this.getValue())this.view.reset();},keydown:function(event){if(!this.view.visible)return;switch(Event.getKeyCode(event)){case KEYS.UP:this.view.prev();event.kill();break;case KEYS.DOWN:this.view.next();event.kill();break;case KEYS.TAB:var a=event.getModifiers().shift?'prev':'next';this.view[a]();event.kill();break;case KEYS.RETURN:if(this.view.select()!==false)event.kill();break;case KEYS.ESC:this.view.reset();event.kill();break;}},getElement:function(){return this.element;},setValue:function(a){this.value=a||'';this.element.value=this.value;},setHiddenValue:function(a){this.hiddenInput.value=a||'';},getValue:function(){return this.element.getValue();},getHiddenValue:function(){return this.hiddenInput.value||'';},checkValue:function(b){var d=this.getValue();if(!b&&d==this.value)return;if(this.selectedText&&this.selectedText!=d)this.unselect();var c=(+new Date()),a=c-this.time;this.time=c;this.nextQuery=this.value=d;if(!this.fetching||a>this.queryTimeout)this.performQuery();},performQuery:function(){this.data.query(this.nextQuery);this.nextQuery=null;}});\nfunction SearchTypeaheadCore(a,b){this.parent.construct(this,a,b);}SearchTypeaheadCore.extend('TypeaheadCore');SearchTypeaheadCore.prototype={init:function(a,f,e){this.parent.init(a,f,e);var b=DOM.getNearest(e,'form'),d=this.reset.bind(this);if(b){var c=DOM.find(b,'input.search_ref_input');if(c.value=='search_preload')c.value='search_loaded';Event.listen(b,'submit',function(){d.defer();},Event.Priority.URGENT);}}};\nfunction SearchTypeaheadRecorder(a){this.init(a);this._reset();}SearchTypeaheadRecorder.prototype={init:function(d){var a=d.getCore(),b=d.getData(),e=d.getView(),c=a.getElement();Event.listen(c,{blur:function(event){if(this.sessionStart){this.recordValuePerSessionStat('session_sec',new Date()\/1000-this.sessionStart\/1000);this.sessionStart=null;}if(this.query)this.recordValuePerSessionStat('query',this.query);this.submit();}.bind(this),focus:function(event){this.sessionStart=+new Date();this.recordOdsCountedStat('session_count');}.bind(this),keydown:function(event){if(Event.getKeyCode(event)==KEYS.BACKSPACE)this.recordCountedStat('backspace_count');}.bind(this)});b.subscribe('activity',function(f,g){if(g.activity){this.activityStartTime=+new Date();}else if(g.activity===false&&this.activityStartTime){this.recordAveragedStat(g.value?'search_endpoint_ms_from_js':'first_endpoint_ms_from_js',new Date()-this.activityStartTime);this.activityStartTime=null;}}.bind(this));b.subscribe('beforeQuery',function(f,g){this.queryStart=+new Date();this.respondCount=0;}.bind(this));b.subscribe('respond',function(f,g){var i=new Date()-this.queryStart;var h=null;if(this.respondCount===0){this.recordAveragedStat('show_something_ms',i);h=this.respondCount+1;}if(this.respondCount===1||g.results.length==10){this.recordAveragedStat('show_full_ms',i);h=null;}this.respondCount=h;this.shownResultIds=g.results.map(function(j){return j.uid;}).filter(function(j){return j!='search';});}.bind(this));b.subscribe('query',function(f,g){this.query=g.value;this.recordCountedStat('num_search_queries');this.recordAveragedStat('num_served_from_js_cache',g.results.length);}.bind(this));b.subscribe('queryEndpoint',function(f,g){this.recordCountedStat('num_search_ajax_requests');this.recordAveragedStat('endpoint_query_length',g.value.length);}.bind(this));e.subscribe('select',function(f,h){this.recordValuePerSessionStat('selected_with_mouse',h.clicked?1:0);if(h.selected.type==='calltoaction'&&h.selected.path.indexOf('\/search\/')>=0){this.recordOdsCountedStat('selected_search');}else{this.recordOdsCountedStat('selected_'+h.selected.type);this.recordValuePerSessionStats({selected_position:h.index,selected_type:h.selected.type,selected_name_length:h.selected.text.length,selected_id:h.selected.uid,selected_degree:h.selected.query?2:1});}if(this.shownResultIds)for(var g=0;g<this.shownResultIds.length;++g)this.recordValuePerSessionStat('candidate_result_id_'+g,this.shownResultIds[g]);}.bind(this));this._data=b;},recordAveragedStat:function(c,d){if(this._averagedStats[c]){var b=this._averagedStats[c][0];var a=this._averagedStats[c][1];this._averagedStats[c]=[(b*a\/(a+1))+(d\/(a+1)),a+1];}else this._averagedStats[c]=[d,1];return this;},recordValuePerSessionStats:function(b){for(var a in b)this.recordValuePerSessionStat(a,b[a]);return this;},recordValuePerSessionStat:function(a,b){if(this._valuePerSessionStats[a])throw \"Already have value for \"+a;this._valuePerSessionStats[a]=b;},recordCountedStat:function(a){if(!this._countedStats[a])this._countedStats[a]=0;++this._countedStats[a];return this;},recordOdsCountedStat:function(a){this.recordValuePerSessionStat(a,1);},_dataToSubmit:function(){var a={};for(var b in this._averagedStats)a[b]=this._averagedStats[b][0];return merge(a,this._valuePerSessionStats,this._countedStats);},_reset:function(){this._averagedStats={};this._valuePerSessionStats={};this._countedStats={};var a={sid:Math.random()};this._data.setQueryData(a);this.recordValuePerSessionStats(a);},submit:function(){var a=this._dataToSubmit();if(count(a)>0)new AsyncRequest().setURI('\/ajax\/typeahead\/record_metrics.php').setMethod('POST').setData({stats:a}).send();this._reset();}};\nfunction TypeaheadView(a,b){this.element=$(a);copy_properties(this,b);}TypeaheadView.mixin('Arbiter',{events:['highlight','render','reset','select'],renderer:'basic',autoSelect:false,init:function(){this.init=bagofholding;this.initializeEvents();this.reset();},initializeEvents:function(){var a=this.checkEvent.bind(this);Event.listen(this.element,{mousedown:a,mouseover:a});},reset:function(){this.hide();this.index=-1;this.items=[];this.results=[];this.element.innerHTML='';this.inform('reset');},checkEvent:function(event){if(!event)return;var a=event.type;this[a]&&this[a](event);},getIndex:function(event){return this.items.indexOf(DOM.getNearest(event.getTarget(),'li'));},getSelection:function(){var a=this.items[this.index]||null;return this.visible?a:null;},mousedown:function(event){this.select(true);},mouseover:function(event){this.highlight(this.getIndex(event));},show:function(){if(!this.results.length)return;CSS.removeClass(this.element,'hidden_elem');this.visible=true;},hide:function(){CSS.addClass(this.element,'hidden_elem');this.visible=false;},render:function(g,d,e){if(!g||!d.length){this.reset();return;}var c=this.results[this.index],b=this.autoSelect?0:-1;this.results=d;this.element.innerHTML=this.buildMarkup(d);this.items=this.getItems();if(c&&e)for(var a=0,f=d.length;a<f;++a)if(c.uid==d[a].uid){b=a;break;}this.highlight(b,false);this.show();this.inform('render',d);},getItems:function(){return DOM.scry(this.element,'li');},buildMarkup:function(c){var b,a=[];if(typeof this.renderer==\"function\"){a.push('<ul>');b=this.renderer;}else{a.push('<ul class=\"'+this.renderer+'\">');b=TypeaheadRenderers[this.renderer];}c.each(function(d,e){a=a.concat(b(d,e));},this);a.push('<\/ul>');return a.join('');},next:function(){this.highlight(this.index+1);},prev:function(){this.highlight(this.index-1);},highlight:function(a,b){this.selected&&CSS.removeClass(this.selected,'selected');a=Math.min(Math.max(-1,a),this.items.length-1);if(a>=0&&a<this.items.length){this.selected=this.items[a];CSS.addClass(this.selected,'selected');}this.index=a;if(b!==false)this.inform('highlight',{index:a,selected:this.results[a]});},select:function(a){var b=this.index,c=this.results[b];if(!c)return false;this.inform('select',{index:b,clicked:!!a,selected:c});}});\nfunction SearchTypeaheadView(a,b){this.parent.construct(this,a,b);}SearchTypeaheadView.extend('TypeaheadView');SearchTypeaheadView.prototype={render:function(e,c,d,a){var b='<span class=\"seeMoreTitle\">'+_tx(\"See More Results for {query}\",{query:htmlize(e)})+'<span class=\"seeMoreArrow\"><\/span><\/span><br \/>'+'<span class=\"seeMoreResultsCount\">'+(c.length==1?_tx(\"Displaying Top Result\"):_tx(\"Displaying Top {number} Results\",{number:c.length}))+'<\/span>';if(e&&c.length>0&&!a)c.push({uid:'search',text:e,type:'calltoaction',path:'\/search\/?init=quick&q='+encodeURIComponent(e),markup:b});return this.parent.render(e,c,d);},select:function(a){var b=this.results[this.index],c=b&&b.path;this.parent.select(a);if(!c)return false;if(c.indexOf('http:\/\/')!=0&&c.indexOf('https:\/\/')!=0)c=Env.www_base+c.substr(1);c+=(c.indexOf('?')>0?'&':'?')+'ref=ts';if(b.is_external){goURI(c,true);}else goURI(c);}};\nTypeaheadBehaviors=copy_properties(window.TypeaheadBehaviors,{requireSelection:function(c){var a=c.getCore(),b=a.getElement();Event.listen(b,'blur',function(){!a.getHiddenValue()&&a.reset();});},resetOnBlur:function(c){var a=c.getCore(),b=a.getElement();Event.listen(b,'blur',function(){a.getValue()&&a.reset();});},setPhotoOnSelect:function(b){var a=DOM.scry(b.getElement(),'img.photo')[0];if(a)b.subscribe('select',function(c,d){var e=d.selected.photo;e?a.setAttribute('src',e):a.removeAttribute('src');});}});\nfunction Typeahead(b,d,a,c){this.args={data:b,view:d,core:a};DataStore.set(c,'Typeahead',this);this.element=c;}Typeahead.mixin('Arbiter',{init:function(a){this.init=bagofholding;this.getCore().focus();this.proxyEvents();this.initBehaviors(a||[]);this.data.bootstrap();this.inform('init',this);},getData:function(){if(!this.data){var a=this.args.data;this.data=new window[a.ctor](a.options||{});this.data.init();}return this.data;},getView:function(){if(!this.view){var a=this.args.view;this.view=new window[a.ctor](a.node,a.options||{});this.view.init();}return this.view;},getCore:function(){if(!this.core){var a=this.args.core;this.core=new window[a.ctor](a.node,a.options||{});this.core.init(this.getData(),this.getView(),this.getElement());}return this.core;},getElement:function(){return this.element;},proxyEvents:function(){[this.data,this.view,this.core].each(function(a){a.subscribe(a.events,this.inform.bind(this));},this);},initBehaviors:function(a){a.each(function(b){(TypeaheadBehaviors[b]||bagofholding)(this);},this);}});\n\nif (window.Bootloader) { Bootloader.done([\"js\\\/2ywfs5qomb8kwwgc.pkg.js\"]); }")